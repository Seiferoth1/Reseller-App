<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Reseller Pro | Enterprise</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { primary: '#4F52C9', secondary: '#EEEAF8', accent: '#DDE3F9', pink: '#E040A0', dark: '#1B1D3A' }
                    },
                    borderRadius: { '4xl': '2rem' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #EEEAF8; color: #1B1D3A; margin: 0; padding-bottom: 120px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid white; box-shadow: 0 10px 30px rgba(79, 82, 201, 0.05); }
        .bouncy { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; }
        .bouncy:active { transform: scale(0.92); }
        .nav-pill { background: #1B1D3A; box-shadow: 0 10px 35px rgba(27, 29, 58, 0.3); }
        .form-input, select, textarea { width: 100%; padding: 14px 16px; border-radius: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; outline: none; transition: 0.2s; }
        .form-input:focus { border-color: #4F52C9; box-shadow: 0 0 0 4px rgba(79,82,201,0.1); background: white; }
    </style>
</head>
<body>

    <header class="p-6 flex justify-between items-center relative z-10">
        <div>
            <h1 class="text-2xl font-extrabold bg-gradient-to-r from-brand-primary to-brand-pink bg-clip-text text-transparent italic tracking-tight">Reseller Pro</h1>
            <div class="flex items-center gap-2 mt-1">
                <span id="conn-dot" class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_8px_#22c55e]"></span>
                <p id="status-tag" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">System Live</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('platformModal').classList.add('active')" class="w-12 h-12 glass-card rounded-full flex items-center justify-center bouncy"><i data-lucide="settings" class="w-5 h-5 text-brand-dark"></i></button>
        </div>
    </header>

    <main class="px-4 space-y-6 container mx-auto relative z-10">
        
        <div id="dashboard" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-6 rounded-4xl">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Revenue</p>
                    <h2 id="revenue-val" class="text-2xl font-black mt-1 text-brand-dark">$0</h2>
                </div>
                <div class="bg-brand-primary p-6 rounded-4xl shadow-lg shadow-brand-primary/30">
                    <p class="text-[10px] font-bold text-white/60 uppercase tracking-wider">Net Profit</p>
                    <h2 id="profit-val" class="text-2xl font-black mt-1 text-white">$0</h2>
                </div>
            </div>

            <div class="glass-card p-6 rounded-4xl border border-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-brand-dark flex items-center gap-2"><i data-lucide="car" class="w-4 h-4 text-brand-pink"></i> Active Mileage</h3>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-brand-secondary/50 p-4 rounded-3xl">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Total Miles</p>
                        <h3 id="totalMiles" class="text-xl font-extrabold text-brand-dark mt-1">0</h3>
                    </div>
                    <div class="bg-green-50 p-4 rounded-3xl">
                        <p class="text-[10px] font-bold text-green-600/60 uppercase">IRS Deduction</p>
                        <h3 id="totalMileageDeduction" class="text-xl font-extrabold text-green-600 mt-1">$0</h3>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md h-20 nav-pill rounded-full flex items-center justify-around px-2 z-50">
        <button onclick="showTab('dashboard')" class="p-4 text-white/50 hover:text-white transition-all bouncy"><i data-lucide="layout-dashboard"></i></button>
        <button onclick="showTab('inventory')" class="p-4 text-white/50 hover:text-white transition-all bouncy"><i data-lucide="package"></i></button>
        
        <button onclick="openModal()" class="w-16 h-16 bg-brand-pink rounded-full -translate-y-6 border-[6px] border-[#EEEAF8] flex items-center justify-center text-white shadow-xl shadow-brand-pink/20 bouncy">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>
        
        <button onclick="showTab('tasks')" class="p-4 text-white/50 hover:text-white transition-all bouncy"><i data-lucide="clipboard-list"></i></button>
        <button onclick="showTab('mileage')" class="p-4 text-white/50 hover:text-white transition-all bouncy"><i data-lucide="navigation"></i></button>
    </nav>

    <script>
        // â”€â”€ Theme Toggle (runs immediately to prevent flash) â”€â”€
        (function() {
            const saved = localStorage.getItem('reseller_theme');
            if (saved === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();

        // â”€â”€ Toast & Confirm System â”€â”€
        function toast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const el = document.createElement('div');
            el.className = `toast toast-${type}`;
            el.textContent = message;
            container.appendChild(el);
            setTimeout(() => { if (el.parentNode) el.remove(); }, duration);
        }
        window.toast = toast;

        function confirmAction(message) {
            return new Promise((resolve) => {
                const existing = document.querySelector('.confirm-bar');
                if (existing) existing.remove();

                const bar = document.createElement('div');
                bar.className = 'confirm-bar';
                bar.innerHTML = `
                    <span>${message}</span>
                    <button class="cb-yes">Yes</button>
                    <button class="cb-no">Cancel</button>
                `;
                document.body.appendChild(bar);

                const cleanup = (result) => { bar.remove(); resolve(result); };
                bar.querySelector('.cb-yes').onclick = () => cleanup(true);
                bar.querySelector('.cb-no').onclick = () => cleanup(false);
            });
        }
        window.confirmAction = confirmAction;

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            
            if (next === 'dark') {
                html.setAttribute('data-theme', 'dark');
            } else {
                html.removeAttribute('data-theme');
            }
            
            localStorage.setItem('reseller_theme', next);
            updateThemeIcon();
        }
        window.toggleTheme = toggleTheme;

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
                icon.style.transform = 'rotate(360deg)';
                setTimeout(() => { icon.style.transform = ''; }, 400);
            }
        }

        // Set initial icon after DOM loads
        document.addEventListener('DOMContentLoaded', updateThemeIcon);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SUPABASE CLIENT + AUTH + CLOUD SYNC
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â”€â”€ CONFIG â€” Replace with your Supabase project values â”€â”€â”€â”€â”€â”€â”€â”€
        const SUPABASE_URL  = 'https://pglbroqrzchalfivhxju.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnbGJyb3FyemNoYWxmaXZoeGp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNzczNjksImV4cCI6MjA4Njg1MzM2OX0.txVH7ywpKEC1bGnufqF36bwqWLIiTdmNmx9ZYYN2n_Q';

        // â”€â”€ CONFIG â€” Groq API key stored in localStorage (never in code) â”€â”€
        function getGroqKey() {
            return localStorage.getItem('reseller_groq_key') || '';
        }
        function setGroqKey(key) {
            localStorage.setItem('reseller_groq_key', key.trim());
        }

        let sbClient = null;
        let currentUser = null;
        let authMode = 'login'; // 'login' or 'signup'
        let syncEnabled = false;
        let syncDebounceTimer = null;

        // Initialize Supabase client â€” tries now AND can retry later
        function initSupabase() {
            if (sbClient) return true; // already initialized

            // Check 1: did the user replace the placeholder keys?
            const hasKeys = SUPABASE_URL !== 'https://YOUR_PROJECT.supabase.co'
                         && SUPABASE_ANON !== 'YOUR_ANON_KEY';
            if (!hasKeys) return false;

            // Check 2: did the CDN script load?
            // The CDN exposes window.supabase as { createClient, ... }
            const sb = window.supabase;
            if (!sb) return false;

            // Find createClient â€” could be sb.createClient or sb.default.createClient
            const createFn = sb.createClient || (sb.default && sb.default.createClient);
            if (!createFn) return false;

            try {
                sbClient = createFn(SUPABASE_URL, SUPABASE_ANON);
                return true;
            } catch(e) {
                console.warn('Supabase init failed:', e);
                return false;
            }
        }

        // Try once on page load
        initSupabase();

        // â”€â”€ Sync Status Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setSyncStatus(status, label) {
            const el = document.getElementById('syncIndicator');
            const lb = document.getElementById('syncLabel');
            if (!el) return;
            el.className = 'sync-indicator ' + status;
            lb.textContent = label || status;
        }

        // â”€â”€ Auth UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateAuthUI() {
            const bar = document.getElementById('authBar');
            if (!bar) return; // auth bar removed from UI â€” silently skip
            if (currentUser) {
                const email = currentUser.email || '';
                const short = email.split('@')[0];
                bar.innerHTML = `
                    <div class="user-badge"><span class="user-dot"></span>${short}</div>
                    <button class="auth-btn" data-action="logout">Sign Out</button>
                `;
            } else {
                bar.innerHTML = `<button class="auth-btn" data-action="login">Sign In</button>`;
            }
        }

        // Event delegation for auth bar (handles dynamic buttons)
        const _authBar = document.getElementById('authBar');
        if (_authBar) _authBar.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            if (btn.dataset.action === 'login') showLoginModal();
            if (btn.dataset.action === 'logout') handleLogout();
        });

        function showLoginModal() {
            authMode = 'login';
            document.getElementById('loginOverlay').style.display = 'flex'; window._pushModalState && _pushModalState('loginOverlay');
            document.getElementById('loginTitle').textContent = 'Welcome Back';
            document.getElementById('loginSubtitle').textContent = 'Sign in to sync your data across devices';
            document.getElementById('authSubmitBtn').textContent = 'Sign In';
            document.getElementById('loginToggle').innerHTML = "Don't have an account? <a onclick=\"toggleAuthMode()\">Sign Up</a>";
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
        }
        window.showLoginModal = showLoginModal;

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'signup' : 'login';
            if (authMode === 'signup') {
                document.getElementById('loginTitle').textContent = 'Create Account';
                document.getElementById('loginSubtitle').textContent = 'Sign up to sync inventory across all your devices';
                document.getElementById('authSubmitBtn').textContent = 'Create Account';
                document.getElementById('loginToggle').innerHTML = "Already have an account? <a onclick=\"toggleAuthMode()\">Sign In</a>";
            } else {
                document.getElementById('loginTitle').textContent = 'Welcome Back';
                document.getElementById('loginSubtitle').textContent = 'Sign in to sync your data across devices';
                document.getElementById('authSubmitBtn').textContent = 'Sign In';
                document.getElementById('loginToggle').innerHTML = "Don't have an account? <a onclick=\"toggleAuthMode()\">Sign Up</a>";
            }
            document.getElementById('loginError').style.display = 'none';
        }
        window.toggleAuthMode = toggleAuthMode;

        function skipLogin() {
            document.getElementById('loginOverlay').style.display = 'none';
            syncEnabled = false;
            setSyncStatus('offline', 'Local Only');
        }
        window.skipLogin = skipLogin;

        async function handleAuth(event) {
            event.preventDefault();

            // Retry init in case CDN loaded after page script ran
            initSupabase();

            if (!sbClient) {
                const hasKeys = SUPABASE_URL !== 'https://YOUR_PROJECT.supabase.co'
                             && SUPABASE_ANON !== 'YOUR_ANON_KEY';
                if (!hasKeys) {
                    showAuthError('Step 4 not done yet: open this HTML file in a text editor, search for YOUR_PROJECT, and replace both lines with your Supabase URL and anon key.');
                } else if (!window.supabase || !window.supabase.createClient) {
                    showAuthError('Supabase library failed to load. Check your internet connection and refresh the page.');
                } else {
                    showAuthError('Supabase client could not initialize. Check your URL and key are correct.');
                }
                return;
            }

            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const btn = document.getElementById('authSubmitBtn');
            btn.disabled = true;
            btn.textContent = authMode === 'login' ? 'Signing inâ€¦' : 'Creating accountâ€¦';
            document.getElementById('loginError').style.display = 'none';

            let result;
            if (authMode === 'signup') {
                result = await sbClient.auth.signUp({ email, password });
            } else {
                result = await sbClient.auth.signInWithPassword({ email, password });
            }

            btn.disabled = false;
            btn.textContent = authMode === 'login' ? 'Sign In' : 'Create Account';

            if (result.error) {
                showAuthError(result.error.message);
                return;
            }

            if (authMode === 'signup' && result.data?.user && !result.data.session) {
                showAuthError('Check your email for a confirmation link!');
                document.getElementById('loginError').style.color = 'var(--emerald-500)';
                return;
            }

            currentUser = result.data.user;
            syncEnabled = true;
            document.getElementById('loginOverlay').style.display = 'none';
            updateAuthUI();

            // Pull cloud data and merge
            await loadFromCloud();
            init();
        }
        window.handleAuth = handleAuth;

        function showAuthError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.style.display = 'block';
            el.style.color = '';
        }

        async function handleLogout() {
            if (sbClient) await sbClient.auth.signOut();
            currentUser = null;
            syncEnabled = false;
            updateAuthUI();
            setSyncStatus('offline', 'Local Only');
        }
        window.handleLogout = handleLogout;

        // â”€â”€ Check existing session on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function checkSession() {
            initSupabase(); // retry in case CDN was slow
            if (!sbClient) {
                setSyncStatus('offline', 'Local Only');
                return;
            }
            try {
                const { data: { session } } = await sbClient.auth.getSession();
                if (session && session.user) {
                    currentUser = session.user;
                    syncEnabled = true;
                    updateAuthUI();
                    await loadFromCloud();
                    init();
                    startRealtimeSync();
                    startPolling();
                    return;
                }
            } catch(e) {
                console.warn('Session check failed:', e);
            }
            setSyncStatus('offline', 'Local Only');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SYNC ENGINE â€” pushes every change to Supabase, falls back
        // to localStorage when offline or not logged in
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Cloud table: reseller_data (one row per user, stores all data as JSONB)
        // Migration:
        //   CREATE TABLE reseller_data (
        //     user_id uuid PRIMARY KEY REFERENCES auth.users(id),
        //     inventory jsonb DEFAULT '[]',
        //     platforms jsonb DEFAULT '[]',
        //     tasks jsonb DEFAULT '[]',
        //     expenses jsonb DEFAULT '[]',
        //     mileage jsonb DEFAULT '[]',
        //     updated_at timestamptz DEFAULT now()
        //   );
        //   ALTER TABLE reseller_data ENABLE ROW LEVEL SECURITY;
        //   CREATE POLICY "Users manage own data" ON reseller_data
        //     FOR ALL USING (auth.uid() = user_id)
        //     WITH CHECK (auth.uid() = user_id);

        async function syncData() {
            // Always save to localStorage as the fallback (with photos)
            saveToLocalStorage();

            if (!syncEnabled || !sbClient || !currentUser) {
                setSyncStatus('offline', 'Local Only');
                return;
            }

            setSyncStatus('syncing', 'Syncingâ€¦');

            try {
                // Deep clone and strip base64 photos to keep payload small
                const cleanInventory = JSON.parse(JSON.stringify(inventory)).map(item => {
                    if (item.photos && item.photos.length > 0) {
                        item.photoCount = item.photos.length;
                        item.photos = []; // strip base64 from cloud payload
                    }
                    return item;
                });

                const payload = {
                    user_id: currentUser.id,
                    inventory: cleanInventory,
                    platforms: JSON.parse(JSON.stringify(platforms)),
                    tasks: JSON.parse(JSON.stringify(tasks)),
                    expenses: JSON.parse(JSON.stringify(expenses)),
                    mileage: JSON.parse(JSON.stringify(mileageTrips)),
                    updated_at: new Date().toISOString()
                };

                const { error } = await sbClient
                    .from('reseller_data')
                    .upsert(payload, { onConflict: 'user_id' });

                if (error) throw error;

                setSyncStatus('synced', 'Synced âœ“');
            } catch(e) {
                console.error('Sync failed:', e);
                setSyncStatus('error', 'Sync failed');
                // Data is safe in localStorage â€” will retry on next save
            }
        }

        // Flush pending sync before user leaves the page
        window.addEventListener('beforeunload', () => {
            if (syncDebounceTimer && syncEnabled && sbClient && currentUser) {
                clearTimeout(syncDebounceTimer);
                // Use sendBeacon for reliable last-chance sync
                try {
                    const cleanInventory = JSON.parse(JSON.stringify(inventory)).map(item => {
                        if (item.photos && item.photos.length > 0) {
                            item.photoCount = item.photos.length;
                            item.photos = [];
                        }
                        return item;
                    });
                    // At minimum, save to localStorage synchronously
                    saveToLocalStorage();
                } catch(e) {}
            }
        });

        // Debounced sync â€” batches rapid changes into one API call
        function debouncedSync() {
            clearTimeout(syncDebounceTimer);
            // Save to localStorage immediately
            saveToLocalStorage();
            // Sync to cloud with short debounce to batch rapid changes (300ms)
            syncDebounceTimer = setTimeout(syncData, 300);
        }

        async function loadFromCloud() {
            if (!sbClient || !currentUser) return;

            setSyncStatus('syncing', 'Loadingâ€¦');

            try {
                const { data, error } = await sbClient
                    .from('reseller_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows

                if (data) {
                    _lastCloudTs = data.updated_at || null;
                    // Build a lookup of local photos by name+sku so we can preserve them
                    const localPhotoMap = {};
                    inventory.forEach(item => {
                        if (item.photos && item.photos.length > 0) {
                            localPhotoMap[(item.name || '') + '|' + (item.sku || '')] = item.photos;
                        }
                    });

                    // Cloud data exists â€” use it (cloud is source of truth)
                    if (Array.isArray(data.inventory)) {
                        data.inventory.forEach(item => {
                            if (item.dateSold) item.dateSold = new Date(item.dateSold);
                            // Restore photos from localStorage if cloud doesn't have them
                            if ((!item.photos || item.photos.length === 0)) {
                                const key = (item.name || '') + '|' + (item.sku || '');
                                if (localPhotoMap[key]) {
                                    item.photos = localPhotoMap[key];
                                } else {
                                    item.photos = [];
                                }
                            }
                        });
                        inventory = data.inventory;
                    }
                    if (Array.isArray(data.platforms)) platforms = data.platforms;
                    if (Array.isArray(data.tasks)) tasks = data.tasks;
                    if (Array.isArray(data.expenses)) expenses = data.expenses;
                    if (Array.isArray(data.mileage)) mileageTrips = data.mileage;

                    // Also update localStorage as cache
                    saveToLocalStorage();
                    setSyncStatus('synced', 'Synced âœ“');

                    // Re-render everything so UI reflects latest data
                    renderInventory();
                    if (typeof currentView !== 'undefined' && currentView === 'grid') renderGallery();
                    if (typeof updateStats === 'function') updateStats();
                    if (typeof renderTasks === 'function') renderTasks();
                    if (typeof updateTaskLinkedItems === 'function') updateTaskLinkedItems();
                    if (typeof renderPlatforms === 'function') renderPlatforms();
                    if (typeof renderWeeklyAnalytics === 'function') renderWeeklyAnalytics();
                    if (typeof renderMonthlyAnalytics === 'function') renderMonthlyAnalytics();
                } else {
                    // No cloud data yet â€” push current localStorage data up
                    await syncData();
                }
            } catch(e) {
                console.error('Cloud load failed:', e);
                setSyncStatus('error', 'Load failed');
                // Fall through to localStorage data
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOCAL STORAGE (fallback + cache)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function saveToLocalStorage() {
            localStorage.setItem('reseller_inventory', JSON.stringify(inventory));
            localStorage.setItem('reseller_platforms', JSON.stringify(platforms));
            localStorage.setItem('reseller_tasks', JSON.stringify(tasks));
            localStorage.setItem('reseller_expenses', JSON.stringify(expenses));
            localStorage.setItem('reseller_mileage', JSON.stringify(mileageTrips));
        }

        // Load data from localStorage
        function loadFromStorage() {
            const savedInventory = localStorage.getItem('reseller_inventory');
            const savedPlatforms = localStorage.getItem('reseller_platforms');
            const savedTasks = localStorage.getItem('reseller_tasks');
            const savedExpenses = localStorage.getItem('reseller_expenses');
            const savedMileage = localStorage.getItem('reseller_mileage');
            
            let result = { inventory: null, platforms: null, tasks: null, expenses: null, mileage: null };
            
            if (savedInventory) {
                try {
                    const parsed = JSON.parse(savedInventory);
                    parsed.forEach(item => {
                        if (item.dateSold) item.dateSold = new Date(item.dateSold);
                    });
                    result.inventory = parsed;
                } catch (e) {
                    console.error('Error loading inventory:', e);
                }
            }
            
            if (savedPlatforms) {
                try { result.platforms = JSON.parse(savedPlatforms); } catch(e) {}
            }

            if (savedTasks) {
                try { result.tasks = JSON.parse(savedTasks); } catch(e) {}
            }

            if (savedExpenses) {
                try { result.expenses = JSON.parse(savedExpenses); } catch(e) {}
            }

            if (savedMileage) {
                try { result.mileage = JSON.parse(savedMileage); } catch(e) {}
            }
            
            return result;
        }

        // â”€â”€ REPLACEMENT: saveToStorage now syncs everything â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function saveToStorage() {
            saveToLocalStorage();
            // Signal other same-device tabs via localStorage event
            try { localStorage.setItem('reseller_pro_update', Date.now()); } catch(e) {}
            debouncedSync();
        }

        // â”€â”€ Cross-device polling: pull from cloud every 8s when signed in â”€
        let _pollInterval = null;
        let _lastCloudTs = null;

        function startPolling() {
            stopPolling();
            _pollInterval = setInterval(pollForChanges, 5000);
        }

        async function pollForChanges() {
            if (!syncEnabled || !sbClient || !currentUser) return;
            try {
                const { data } = await sbClient
                    .from('reseller_data')
                    .select('updated_at')
                    .eq('user_id', currentUser.id)
                    .single();
                if (data?.updated_at && data.updated_at !== _lastCloudTs) {
                    _lastCloudTs = data.updated_at;
                    await loadFromCloud();
                }
            } catch(e) {}
        }

        // Immediately re-sync when tab becomes visible again (handles mobile backgrounding)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && syncEnabled && sbClient && currentUser) {
                pollForChanges();
            }
        });

        function stopPolling() {
            if (_pollInterval) { clearInterval(_pollInterval); _pollInterval = null; }
        }

        const stored = loadFromStorage();
        
        let inventory = stored.inventory || [
            { name: "Vintage Leather Jacket", sku: "VLJ-001", category: "Accessories", source: "Poshmark", purchase: 44, purchaseShipping: 1, sale: 70, outboundShipping: 9.5, packaging: 1.5, profit: 14, platformFees: 0, taxReserve: 0, platform: "eBay", status: "Sold", days: 0, dateSold: new Date('2026-02-10'), photos: [] },
            { name: "Beauty Bundle", sku: "BB-002", category: "Beauty & Skincare", source: "eBay", purchase: 85, purchaseShipping: 1, sale: 465, outboundShipping: 10, packaging: 1.5, profit: 368.5, platformFees: 0, taxReserve: 0, platform: "Poshmark", status: "Sold", days: 0, dateSold: new Date('2026-02-02'), photos: [] },
            { name: "Electronics Lot", sku: "EL-003", category: "Electronics", source: "Goodwill", purchase: 33, purchaseShipping: 1, sale: 85, outboundShipping: 9.5, packaging: 1.5, profit: 40.5, platformFees: 0, taxReserve: 0, platform: "Mercari", status: "Sold", days: 0, dateSold: new Date('2026-01-15'), photos: [] },
            { name: "Auto Parts", sku: "AP-004", category: "Automotive", source: "Bid FTA", purchase: 43, purchaseShipping: 1, sale: 85, outboundShipping: 0, packaging: 0, profit: 42, platformFees: 0, taxReserve: 0, platform: "Etsy", status: "Sold", days: 0, dateSold: new Date('2026-01-20'), photos: [] },
            { name: "Kids Toys", sku: "KT-005", category: "Kids Collectibles", source: "Salvation Army", purchase: 23, purchaseShipping: 1, sale: null, outboundShipping: 0, packaging: 0, profit: null, platformFees: 0, taxReserve: 0, platform: "Depop", status: "Listed", days: 289, dateSold: null, photos: [] },
            { name: "Baby Clothes Bundle", sku: "BCB-006", category: "Baby Clothing", source: "Garage Sale", purchase: 33, purchaseShipping: 1, sale: 89, outboundShipping: 0, packaging: 0, profit: 56, platformFees: 0, taxReserve: 0, platform: "FB Marketplace", status: "Sold", days: 0, dateSold: new Date('2026-02-08'), photos: [] },
            { name: "Designer Dress", sku: "DD-007", category: "Womens Clothing", source: "Estate Sale", purchase: 12, purchaseShipping: 1, sale: 623, outboundShipping: 0, packaging: 0, profit: 611, platformFees: 0, taxReserve: 0, platform: "Mercari", status: "Sold", days: 0, dateSold: new Date('2026-02-12'), photos: [] },
            { name: "Laptop", sku: "LP-008", category: "Computers & Tech", source: "Walmart", purchase: 68, purchaseShipping: 1, sale: null, outboundShipping: 0, packaging: 0, profit: null, platformFees: 0, taxReserve: 0, platform: null, status: "Listed", days: 197, dateSold: null, photos: [] },
            { name: "Kitchen Set", sku: "KS-009", category: "Kitchen & Dining", source: "Amazon", purchase: 89, purchaseShipping: 1, sale: null, outboundShipping: 0, packaging: 0, profit: null, platformFees: 0, taxReserve: 0, platform: null, status: "Returned", days: 0, dateSold: null, photos: [] },
            { name: "Vinyl Records", sku: "VR-010", category: "Media", source: "Facebook", purchase: 12, purchaseShipping: 1, sale: 45, outboundShipping: 0, packaging: 0, profit: 33, platformFees: 0, taxReserve: 0, platform: "Etsy", status: "Sold", days: 0, dateSold: new Date('2026-01-25'), photos: [] },
            { name: "Men's Suit", sku: "MS-011", category: "Mens Clothing", source: "Estate Sale", purchase: 54, purchaseShipping: 1, sale: 90, outboundShipping: 0, packaging: 0, profit: 18, platformFees: 0, taxReserve: 0, platform: "Poshmark", status: "Sold", days: 0, dateSold: new Date('2026-02-05'), photos: [] },
            { name: "Gold Necklace", sku: "GN-012", category: "Jewelry", source: "Walmart", purchase: 40, purchaseShipping: 1, sale: null, outboundShipping: 0, packaging: 0, profit: null, platformFees: 0, taxReserve: 0, platform: "Whatnot", status: "Lost/Damaged", days: 0, dateSold: null, photos: [] },
            { name: "Rare Books", sku: "RB-013", category: "Books", source: "OfferUp", purchase: 3, purchaseShipping: 1, sale: 41, outboundShipping: 0, packaging: 0, profit: 38, platformFees: 0, taxReserve: 0, platform: "OfferUp", status: "Sold", days: 0, dateSold: new Date('2026-02-11'), photos: [] }
        ];

        const defaultPlatforms = [
            { name: "eBay", feePercent: 13.6, fixedFee: 0.40, avgDays: 15, successRate: 0.85, totalSales: 3 },
            { name: "Poshmark", feePercent: 20, fixedFee: 0, avgDays: 22, successRate: 0.78, totalSales: 5 },
            { name: "Mercari", feePercent: 10, fixedFee: 0, avgDays: 18, successRate: 0.82, totalSales: 4 },
            { name: "Etsy", feePercent: 9.5, fixedFee: 0.45, avgDays: 28, successRate: 0.65, totalSales: 2 },
            { name: "FB Marketplace", feePercent: 0, fixedFee: 0, avgDays: 12, successRate: 0.90, totalSales: 1 },
            { name: "Depop", feePercent: 10, fixedFee: 0, avgDays: 25, successRate: 0.60, totalSales: 0 },
            { name: "OfferUp", feePercent: 12.9, fixedFee: 0.45, avgDays: 8, successRate: 0.95, totalSales: 1 },
            { name: "Whatnot", feePercent: 8, fixedFee: 0, avgDays: 0, successRate: 0, totalSales: 0 }
        ];
        let platforms = stored.platforms || defaultPlatforms;

        let tasks = stored.tasks || [];

        const defaultExpenses = [
            { id: 'e1', date: '2026-01-05', description: 'Bubble mailers (100 pack)', category: 'Packaging Supplies', amount: 24.99, recurring: '', notes: 'Amazon' },
            { id: 'e2', date: '2026-01-10', description: 'Poshmark Pro subscription', category: 'Software / Subscriptions', amount: 9.99, recurring: 'monthly', notes: '' },
            { id: 'e3', date: '2026-01-15', description: 'Gas - estate sale run', category: 'Gas / Mileage', amount: 35.00, recurring: '', notes: '45 miles round trip' },
            { id: 'e4', date: '2026-01-22', description: 'Poly mailers (50 pack)', category: 'Shipping Supplies', amount: 12.49, recurring: '', notes: '' },
            { id: 'e5', date: '2026-02-01', description: 'Shipping scale', category: 'Equipment', amount: 29.99, recurring: '', notes: 'Digital postal scale' },
            { id: 'e6', date: '2026-02-05', description: 'Gas - Goodwill + Salvation Army', category: 'Gas / Mileage', amount: 22.00, recurring: '', notes: '' },
            { id: 'e7', date: '2026-02-08', description: 'Storage bins (4 pack)', category: 'Storage', amount: 39.96, recurring: '', notes: 'For staging area' },
            { id: 'e8', date: '2026-02-10', description: 'Poshmark Pro subscription', category: 'Software / Subscriptions', amount: 9.99, recurring: 'monthly', notes: '' },
            { id: 'e9', date: '2026-02-12', description: 'Tissue paper + thank you cards', category: 'Packaging Supplies', amount: 15.47, recurring: '', notes: '' },
            { id: 'e10', date: '2026-02-14', description: 'Bid FTA auction fee', category: 'Sourcing Fees', amount: 5.00, recurring: '', notes: '' },
        ];
        let expenses = stored.expenses || defaultExpenses;

        const IRS_MILEAGE_RATE = 0.70; // 2026 IRS standard mileage rate

        const defaultMileage = [
            { id: 'm1', date: '2026-01-15', miles: 45, purpose: 'Estate sale run â€” east side', deduction: 31.50 },
            { id: 'm2', date: '2026-01-22', miles: 12, purpose: 'Post office + supply pickup', deduction: 8.40 },
            { id: 'm3', date: '2026-02-05', miles: 28, purpose: 'Goodwill + Salvation Army loop', deduction: 19.60 },
            { id: 'm4', date: '2026-02-10', miles: 8, purpose: 'Drop-off at FedEx', deduction: 5.60 },
            { id: 'm5', date: '2026-02-14', miles: 52, purpose: 'Bid FTA warehouse pickup', deduction: 36.40 },
        ];
        let mileageTrips = stored.mileage || defaultMileage;

        let editingIndex = null;
        let editingPlatformIndex = null;
        let editingTaskIndex = null;
        let currentPeriod = 'weekly';
        let currentBarcodeType = 'barcode';
        let currentBarcodeItem = null;

        function generateSKU() {
            const category = document.getElementById('itemCategory').value || 'ITEM';
            const prefix = category.substring(0, 3).toUpperCase();
            const random = Math.floor(Math.random() * 9000) + 1000;
            const sku = `${prefix}-${random}`;
            document.getElementById('itemSKU').value = sku;
        }
        window.generateSKU = generateSKU;

        // Accumulated photo data URLs for the current form session
        let pendingPhotos = [];

        function addPhotoFromInput(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingPhotos.push(e.target.result);
                renderPhotoPreviews();
            };
            reader.readAsDataURL(file);
            // Reset so same camera can be used again
            input.value = '';
        }
        window.addPhotoFromInput = addPhotoFromInput;

        function addPhotosFromGallery(input) {
            if (!input.files) return;
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingPhotos.push(e.target.result);
                    renderPhotoPreviews();
                };
                reader.readAsDataURL(file);
            });
            input.value = '';
        }
        window.addPhotosFromGallery = addPhotosFromGallery;

        function renderPhotoPreviews() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            pendingPhotos.forEach((dataUrl, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${dataUrl}" alt="Photo ${index + 1}">
                    <button type="button" class="photo-remove-btn" onclick="removePendingPhoto(${index})">Ã—</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePendingPhoto(index) {
            pendingPhotos.splice(index, 1);
            renderPhotoPreviews();
        }
        window.removePendingPhoto = removePendingPhoto;

        // Process image files into pendingPhotos (shared by drag-drop, paste, file input)
        function processImageFiles(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingPhotos.push(e.target.result);
                    renderPhotoPreviews();
                };
                reader.readAsDataURL(file);
            });
        }

        // Drag and drop handlers for the drop zone
        function initPhotoDropZone() {
            const zone = document.getElementById('photoDropZone');
            if (!zone) return;

            zone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
            });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.remove('drag-over');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    processImageFiles(e.dataTransfer.files);
                }
            });
        }

        // Clipboard paste â€” works in modal, on gallery cards, or on selected list items
        document.addEventListener('paste', (e) => {
            const clipItems = e.clipboardData && e.clipboardData.items;
            if (!clipItems) return;

            const imageFiles = [];
            for (let i = 0; i < clipItems.length; i++) {
                if (clipItems[i].type.startsWith('image/')) {
                    const file = clipItems[i].getAsFile();
                    if (file) imageFiles.push(file);
                }
            }
            if (imageFiles.length === 0) return;

            // 1. If item modal is open â†’ add to pending photos
            const modal = document.getElementById('itemModal');
            if (modal && modal.classList.contains('active')) {
                e.preventDefault();
                processImageFiles(imageFiles);
                return;
            }

            // 2. If hovering a gallery card â†’ add to that item
            const hoveredCard = document.querySelector('.item-card:hover');
            if (hoveredCard) {
                const gallery = document.getElementById('galleryView');
                const allCards = Array.from(gallery.querySelectorAll('.item-card'));
                const cardIdx = allCards.indexOf(hoveredCard);
                if (cardIdx >= 0) {
                    const sortedIndices = getSortedIndices();
                    const idx = sortedIndices[cardIdx];
                    if (idx != null) {
                        e.preventDefault();
                        pastePhotosToItem(idx, imageFiles);
                        return;
                    }
                }
            }

            // 3. If items are selected in list/gallery â†’ add to first selected
            if (selectedItems.size > 0) {
                const idx = selectedItems.values().next().value;
                e.preventDefault();
                pastePhotosToItem(idx, imageFiles);
                return;
            }
        });

        function pastePhotosToItem(inventoryIdx, files) {
            const item = inventory[inventoryIdx];
            if (!item.photos) item.photos = [];
            let pending = files.length;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    item.photos.push(ev.target.result);
                    if (--pending === 0) {
                        renderInventory();
                        renderGallery();
                        saveToStorage();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Explicit paste button â€” reads clipboard via async API
        async function triggerPasteFromClipboard() {
            try {
                if (navigator.clipboard && navigator.clipboard.read) {
                    const clipboardItems = await navigator.clipboard.read();
                    for (const clipItem of clipboardItems) {
                        for (const type of clipItem.types) {
                            if (type.startsWith('image/')) {
                                const blob = await clipItem.getType(type);
                                processImageFiles([blob]);
                            }
                        }
                    }
                } else {
                    toast('Use Ctrl+V / Cmd+V to paste images', 'info');
                }
            } catch(err) {
                if (err.name === 'NotAllowedError') {
                    toast('Clipboard permission denied. Use Ctrl+V / Cmd+V', 'warn');
                } else {
                    console.error('Paste error:', err);
                    toast('No image found in clipboard', 'warn');
                }
            }
        }
        window.triggerPasteFromClipboard = triggerPasteFromClipboard;

        // Also allow dropping photos directly onto gallery cards (quick-add to existing items)
        function initGalleryDropListeners() {
            const gallery = document.getElementById('galleryView');
            if (!gallery) return;

            gallery.addEventListener('dragover', (e) => {
                const card = e.target.closest('.item-card');
                if (card && e.dataTransfer.types.includes('Files')) {
                    e.preventDefault();
                    card.style.outline = '2px solid var(--indigo-400)';
                    card.style.outlineOffset = '-2px';
                }
            });

            gallery.addEventListener('dragleave', (e) => {
                const card = e.target.closest('.item-card');
                if (card) {
                    card.style.outline = '';
                    card.style.outlineOffset = '';
                }
            });

            gallery.addEventListener('drop', (e) => {
                const card = e.target.closest('.item-card');
                if (!card || !e.dataTransfer.files || e.dataTransfer.files.length === 0) return;

                e.preventDefault();
                e.stopPropagation();
                card.style.outline = '';
                card.style.outlineOffset = '';

                // Find the inventory index from the card's onclick
                const allCards = Array.from(gallery.querySelectorAll('.item-card'));
                const cardIdx = allCards.indexOf(card);
                if (cardIdx < 0) return;

                const sortedIndices = getSortedIndices();
                const inventoryIdx = sortedIndices[cardIdx];
                if (inventoryIdx == null) return;

                const item = inventory[inventoryIdx];
                if (!item.photos) item.photos = [];

                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                let pending = files.length;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        item.photos.push(ev.target.result);
                        if (--pending === 0) { renderInventory(); renderGallery(); saveToStorage(); }
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        // Also allow dropping onto table rows in list view
        function initListDropListeners() {
            const tbody = document.getElementById('inventoryBody');
            if (!tbody) return;

            tbody.addEventListener('dragover', (e) => {
                const row = e.target.closest('tr');
                if (row && e.dataTransfer.types.includes('Files')) {
                    e.preventDefault();
                    row.style.outline = '2px solid var(--indigo-400)';
                    row.style.outlineOffset = '-2px';
                }
            });

            tbody.addEventListener('dragleave', (e) => {
                const row = e.target.closest('tr');
                if (row) {
                    row.style.outline = '';
                    row.style.outlineOffset = '';
                }
            });

            tbody.addEventListener('drop', (e) => {
                const row = e.target.closest('tr');
                if (!row || !e.dataTransfer.files || e.dataTransfer.files.length === 0) return;

                e.preventDefault();
                e.stopPropagation();
                row.style.outline = '';
                row.style.outlineOffset = '';

                const allRows = Array.from(tbody.querySelectorAll('tr'));
                const rowIdx = allRows.indexOf(row);
                if (rowIdx < 0) return;

                const sortedIndices = getSortedIndices();
                const inventoryIdx = sortedIndices[rowIdx];
                if (inventoryIdx == null) return;

                const item = inventory[inventoryIdx];
                if (!item.photos) item.photos = [];

                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                let pending = files.length;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        item.photos.push(ev.target.result);
                        if (--pending === 0) { renderInventory(); renderGallery(); saveToStorage(); }
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        function previewPhotos() {
            // Legacy â€” feeds into pendingPhotos from hidden input if used
            const files = document.getElementById('itemPhotos').files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingPhotos.push(e.target.result);
                    renderPhotoPreviews();
                };
                reader.readAsDataURL(file);
            });
        }
        window.previewPhotos = previewPhotos;

        function removePhoto(index) {
            const fileInput = document.getElementById('itemPhotos');
            const dt = new DataTransfer();
            const files = fileInput.files;
            
            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }
            
            fileInput.files = dt.files;
            previewPhotos();
        }
        window.removePhoto = removePhoto;

        function generateBarcode() {
            if (editingIndex === null) {
                toast('Save the item first before generating a barcode', 'warn');
                return;
            }
            
            currentBarcodeItem = inventory[editingIndex];
            
            // Populate label preview
            document.getElementById('labelItemName').textContent = currentBarcodeItem.name;
            document.getElementById('labelSKU').textContent = 'SKU: ' + (currentBarcodeItem.sku || 'N/A');
            document.getElementById('labelPrice').textContent = currentBarcodeItem.sale ? '$' + currentBarcodeItem.sale : '$' + currentBarcodeItem.purchase;
            document.getElementById('labelCategory').textContent = currentBarcodeItem.category;
            
            // Show modal and generate barcode
            document.getElementById('barcodeModal').classList.add('active'); window._pushModalState && _pushModalState('barcodeModal');
            renderBarcode();
        }
        window.generateBarcode = generateBarcode;

        function switchBarcodeType(type) {
            currentBarcodeType = type;
            
            if (type === 'barcode') {
                document.getElementById('barcodeTypeBtn').className = 'btn btn-primary';
                document.getElementById('qrcodeTypeBtn').className = 'btn btn-secondary';
            } else {
                document.getElementById('barcodeTypeBtn').className = 'btn btn-secondary';
                document.getElementById('qrcodeTypeBtn').className = 'btn btn-primary';
            }
            
            renderBarcode();
        }
        window.switchBarcodeType = switchBarcodeType;

        function renderBarcode() {
            if (!currentBarcodeItem) return;
            
            const canvas = document.getElementById('barcodeCanvas');
            const qrDiv = document.getElementById('qrcodeDiv');
            
            if (currentBarcodeType === 'barcode') {
                canvas.style.display = 'block';
                qrDiv.style.display = 'none';
                
                // Generate barcode
                try {
                    JsBarcode(canvas, currentBarcodeItem.sku || 'NO-SKU', {
                        format: 'CODE128',
                        width: 2,
                        height: 100,
                        displayValue: true,
                        fontSize: 16,
                        margin: 10
                    });
                } catch (error) {
                    console.error('Barcode generation error:', error);
                }
            } else {
                canvas.style.display = 'none';
                qrDiv.style.display = 'block';
                qrDiv.innerHTML = '';
                
                // Generate QR code with item data
                const itemData = JSON.stringify({
                    sku: currentBarcodeItem.sku,
                    name: currentBarcodeItem.name,
                    category: currentBarcodeItem.category,
                    price: currentBarcodeItem.sale || currentBarcodeItem.purchase,
                    platform: currentBarcodeItem.platform
                });
                
                new QRCode(qrDiv, {
                    text: itemData,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        function closeBarcodeModal() {
            document.getElementById('barcodeModal').classList.remove('active');
            currentBarcodeItem = null;
        }

        function printLabel() {
            const printWindow = window.open('', '_blank');
            const labelContent = document.getElementById('labelPreview').innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print Label - ${currentBarcodeItem.name}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                            margin: 0;
                            background: white;
                        }
                        .label {
                            border: 2px solid #000;
                            padding: 20px;
                            max-width: 400px;
                            text-align: center;
                        }
                        h3 { margin: 0 0 10px 0; }
                        p { margin: 5px 0; }
                        canvas, #qrcodeDiv { margin: 20px auto; }
                        @media print {
                            body { background: white; }
                            .label { border: 2px solid #000; }
                        }
                    </style>
                </head>
                <body>
                    <div class="label">
                        ${labelContent}
                    </div>
                    <scr` + `ipt>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 100);
                        }
                    </scr` + `ipt>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function downloadLabel() {
            const preview = document.getElementById('labelPreview');
            
            // Use html2canvas if available, otherwise create a basic canvas
            if (typeof html2canvas !== 'undefined') {
                html2canvas(preview).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `label-${currentBarcodeItem.sku || 'item'}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            } else {
                // Fallback: download just the barcode/QR code
                let canvas;
                if (currentBarcodeType === 'barcode') {
                    canvas = document.getElementById('barcodeCanvas');
                } else {
                    // For QR code, get the canvas from the QR div
                    const qrCanvas = document.querySelector('#qrcodeDiv canvas');
                    if (qrCanvas) canvas = qrCanvas;
                }
                
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = `${currentBarcodeType}-${currentBarcodeItem.sku || 'item'}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } else {
                    toast('Unable to download â€” use Print instead', 'warn');
                }
            }
        }

        // â”€â”€ EXPENSES TRACKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        let editingExpenseIndex = null;

        const EXPENSE_CAT_ICONS = {
            'Packaging Supplies': 'ğŸ“¦', 'Shipping Supplies': 'ğŸ“«', 'Gas / Mileage': 'â›½',
            'Software / Subscriptions': 'ğŸ’»', 'Equipment': 'ğŸ”§', 'Storage': 'ğŸ ',
            'Advertising': 'ğŸ“£', 'Sourcing Fees': 'ğŸŸï¸', 'Returns / Refunds': 'â†©ï¸', 'Other': 'ğŸ“'
        };

        const EXPENSE_CAT_COLORS = {
            'Packaging Supplies': '#8b5cf6', 'Shipping Supplies': '#6366f1', 'Gas / Mileage': '#f97316',
            'Software / Subscriptions': '#3b82f6', 'Equipment': '#64748b', 'Storage': '#14b8a6',
            'Advertising': '#ec4899', 'Sourcing Fees': '#eab308', 'Returns / Refunds': '#ef4444', 'Other': '#94a3b8'
        };

        function renderExpenses() {
            const tbody = document.getElementById('expensesBody');
            const empty = document.getElementById('expensesEmpty');
            tbody.innerHTML = '';

            // Sort by date descending
            const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                empty.style.display = 'block';
                tbody.parentElement.style.display = 'none';
            } else {
                empty.style.display = 'none';
                tbody.parentElement.style.display = '';
                
                sorted.forEach((exp, i) => {
                    const origIndex = expenses.indexOf(exp);
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => openEditExpenseModal(origIndex);

                    const catColor = EXPENSE_CAT_COLORS[exp.category] || '#94a3b8';
                    const icon = EXPENSE_CAT_ICONS[exp.category] || 'ğŸ“';
                    const recurLabel = exp.recurring === 'auto'
                        ? `<span style="font-size:10px;font-weight:600;color:var(--emerald-600);background:var(--emerald-50,rgba(5,150,105,0.08));padding:2px 6px;border-radius:4px;margin-left:6px;">âš¡ auto-updated</span>`
                        : exp.recurring ? `<span style="font-size:10px;font-weight:600;color:var(--indigo-500);background:var(--indigo-50);padding:2px 6px;border-radius:4px;margin-left:6px;">ğŸ”„ ${exp.recurring}</span>` : '';

                    const d = new Date(exp.date + 'T12:00:00');
                    const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                    row.innerHTML = `
                        <td style="white-space:nowrap;">${dateStr}</td>
                        <td style="font-weight:600;">${exp.description}${recurLabel}</td>
                        <td><span style="font-size:12px;font-weight:600;color:${catColor};background:${catColor}18;padding:3px 10px;border-radius:6px;">${icon} ${exp.category}</span></td>
                        <td style="font-weight:700;color:var(--rose-500);">-$${exp.amount.toFixed(2)}</td>
                        <td style="font-size:12px;color:var(--text-tertiary, var(--slate-400));">${exp.notes || 'â€”'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateExpenseStats();
        }

        function updateExpenseStats() {
            const totalAll = expenses.reduce((s, e) => s + e.amount, 0);
            
            // This month
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonth = expenses.filter(e => new Date(e.date + 'T12:00:00') >= monthStart);
            const monthTotal = thisMonth.reduce((s, e) => s + e.amount, 0);
            
            // Last month for comparison
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            const lastMonth = expenses.filter(e => { const d = new Date(e.date + 'T12:00:00'); return d >= lastMonthStart && d <= lastMonthEnd; });
            const lastMonthTotal = lastMonth.reduce((s, e) => s + e.amount, 0);

            // Top category
            const catTotals = {};
            expenses.forEach(e => { catTotals[e.category] = (catTotals[e.category] || 0) + e.amount; });
            const topCat = Object.entries(catTotals).sort((a, b) => b[1] - a[1])[0];

            // Adjusted profit = inventory profit - total expenses
            const sold = inventory.filter(i => i.status === 'Sold');
            const invProfit = sold.reduce((s, i) => s + (i.profit || 0), 0);
            const adjusted = invProfit - totalAll;

            document.getElementById('totalExpenses').textContent = '$' + totalAll.toFixed(0);
            document.getElementById('monthExpenses').textContent = '$' + monthTotal.toFixed(0);
            
            if (lastMonthTotal > 0) {
                const pctChange = ((monthTotal - lastMonthTotal) / lastMonthTotal * 100);
                document.getElementById('monthExpenseChange').textContent = (pctChange >= 0 ? 'â†‘ ' : 'â†“ ') + Math.abs(pctChange).toFixed(0) + '% vs last month';
                document.getElementById('monthExpenseChange').className = 'stat-change ' + (pctChange <= 0 ? 'positive' : '');
            } else {
                document.getElementById('monthExpenseChange').textContent = thisMonth.length + ' expense' + (thisMonth.length !== 1 ? 's' : '');
            }

            if (topCat) {
                const icon = EXPENSE_CAT_ICONS[topCat[0]] || '';
                document.getElementById('topExpenseCategory').textContent = icon + ' ' + topCat[0];
                document.getElementById('topExpenseCategoryAmt').textContent = '$' + topCat[1].toFixed(0) + ' total';
            }

            document.getElementById('adjustedProfit').textContent = (adjusted >= 0 ? '$' : '-$') + Math.abs(adjusted).toFixed(0);
            document.getElementById('adjustedProfit').style.color = adjusted >= 0 ? 'var(--emerald-500)' : 'var(--rose-500)';

            // Category breakdown bars
            renderExpenseCategoryBreakdown(catTotals, totalAll);
        }

        function renderExpenseCategoryBreakdown(catTotals, total) {
            const container = document.getElementById('expenseCatBreakdown');
            if (Object.keys(catTotals).length === 0) { container.innerHTML = ''; return; }

            const sorted = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);
            const maxVal = sorted[0][1] || 1;

            let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
            sorted.forEach(([cat, amount]) => {
                const color = EXPENSE_CAT_COLORS[cat] || '#94a3b8';
                const icon = EXPENSE_CAT_ICONS[cat] || 'ğŸ“';
                const pct = total > 0 ? (amount / total * 100).toFixed(0) : 0;
                const barWidth = (amount / maxVal * 100).toFixed(1);
                html += `
                    <div style="background:var(--bg-surface, white);border:1px solid var(--border-primary, var(--slate-200));border-radius:10px;padding:12px 14px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-size:12px;font-weight:600;color:var(--text-primary, var(--slate-900));">${icon} ${cat}</span>
                            <span style="font-size:12px;font-weight:700;color:${color};">$${amount.toFixed(2)} <span style="font-size:10px;color:var(--text-tertiary, var(--slate-400));font-weight:500;">(${pct}%)</span></span>
                        </div>
                        <div style="height:6px;background:var(--bg-inset, var(--slate-100));border-radius:3px;overflow:hidden;">
                            <div style="height:100%;width:${barWidth}%;background:${color};border-radius:3px;transition:width 0.5s;"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function openExpenseModal() {
            editingExpenseIndex = null;
            document.getElementById('expenseModalTitle').textContent = 'Add Expense';
            document.getElementById('expenseSubmitBtn').textContent = 'Add Expense';
            document.getElementById('expenseDeleteBtn').style.display = 'none';
            document.getElementById('expenseForm').reset();
            // Default to today
            const today = new Date();
            document.getElementById('expenseDate').value = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
            document.getElementById('expenseModal').classList.add('active'); window._pushModalState && _pushModalState('expenseModal');
        }
        window.openExpenseModal = openExpenseModal;

        function openEditExpenseModal(index) {
            editingExpenseIndex = index;
            const exp = expenses[index];
            document.getElementById('expenseModalTitle').textContent = 'Edit Expense';
            document.getElementById('expenseSubmitBtn').textContent = 'Update Expense';
            document.getElementById('expenseDeleteBtn').style.display = 'block';
            
            document.getElementById('expenseDate').value = exp.date;
            document.getElementById('expenseAmount').value = exp.amount;
            document.getElementById('expenseDescription').value = exp.description;
            document.getElementById('expenseCategory').value = exp.category;
            document.getElementById('expenseRecurring').value = exp.recurring || '';
            document.getElementById('expenseNotes').value = exp.notes || '';
            
            document.getElementById('expenseModal').classList.add('active'); window._pushModalState && _pushModalState('expenseModal');
        }
        window.openEditExpenseModal = openEditExpenseModal;

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('active');
            document.getElementById('expenseForm').reset();
            editingExpenseIndex = null;
        }
        window.closeExpenseModal = closeExpenseModal;

        function saveExpense(event) {
            event.preventDefault();
            
            const data = {
                id: editingExpenseIndex !== null ? expenses[editingExpenseIndex].id : 'e' + Date.now(),
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDescription').value.trim(),
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
                recurring: document.getElementById('expenseRecurring').value,
                notes: document.getElementById('expenseNotes').value.trim()
            };
            
            if (editingExpenseIndex !== null) {
                expenses[editingExpenseIndex] = data;
            } else {
                expenses.push(data);
            }
            
            renderExpenses();
            saveToStorage();
            closeExpenseModal();
        }
        window.saveExpense = saveExpense;

        async function deleteExpense() {
            if (editingExpenseIndex === null) return;
            if (!await confirmAction('Delete this expense?')) return;
            expenses.splice(editingExpenseIndex, 1);
            renderExpenses();
            saveToStorage();
            closeExpenseModal();
            toast('Expense deleted');
        }
        window.deleteExpense = deleteExpense;

        // Close expense modal on backdrop click
        document.getElementById('expenseModal').addEventListener('click', function(e) {
            if (e.target === this) closeExpenseModal();
        });

        // â”€â”€ MILEAGE TRACKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // â”€â”€ MILEAGE TRACKER (Start Trip + Timer + Geolocation + Auto-Stop Agent) â”€â”€

        let tripActive = false;
        let tripStartTimestamp = null;
        let tripTimerInterval = null;
        let tripStartLocation = null;

        // â”€â”€ Auto-Stop Location Agent state â”€â”€
        let gpsWatchId = null;
        let tripCoords = [];           // all GPS breadcrumbs during trip
        let stationaryAnchor = null;   // { lat, lng, since: timestamp }
        let stationaryCheckInterval = null;
        let autoStopPrompted = false;  // prevent repeat prompts per stop
        const STATIONARY_RADIUS_M = 50;
        const STATIONARY_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes

        function toggleTrip() {
            if (tripActive) {
                showTripEndForm();
            } else {
                startTrip();
            }
        }
        window.toggleTrip = toggleTrip;

        function startTrip() {
            tripActive = true;
            tripStartTimestamp = Date.now();
            tripCoords = [];
            stationaryAnchor = null;
            autoStopPrompted = false;

            // Update button
            document.getElementById('tripBtnIcon').textContent = 'â¹';
            document.getElementById('tripBtnText').textContent = 'End Trip';
            document.getElementById('startTripBtn').style.background = 'var(--rose-500)';

            // Show banner, hide end form
            const banner = document.getElementById('liveTripBanner');
            banner.style.display = 'block';
            document.getElementById('tripEndForm').style.display = 'none';
            document.getElementById('tripBannerLive').style.display = 'flex';

            // Start time display
            const startTime = new Date(tripStartTimestamp);
            document.getElementById('tripStartTime').textContent = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            // Start timer
            tripTimerInterval = setInterval(updateTripTimer, 1000);
            updateTripTimer();

            // Geolocation â€” continuous watch for GPS agent
            document.getElementById('tripLocation').textContent = 'ğŸ“ Getting locationâ€¦';
            if (navigator.geolocation) {
                gpsWatchId = navigator.geolocation.watchPosition(
                    function(pos) {
                        const coord = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now() };
                        tripCoords.push(coord);

                        // Set start location from first fix
                        if (!tripStartLocation) {
                            tripStartLocation = { lat: coord.lat, lng: coord.lng };
                            reverseGeocode(coord.lat, coord.lng, 'tripLocation');
                        }

                        // Update current location display
                        document.getElementById('tripLocation').textContent = 'ğŸ“ ' + coord.lat.toFixed(4) + ', ' + coord.lng.toFixed(4);

                        // â”€â”€ Auto-Stop Agent: stationary detection â”€â”€
                        checkStationary(coord);
                    },
                    function(err) {
                        document.getElementById('tripLocation').textContent = 'ğŸ“ Location unavailable';
                        tripStartLocation = null;
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000 }
                );
            } else {
                document.getElementById('tripLocation').textContent = 'ğŸ“ Geolocation not supported';
            }

            toast('Trip started â€” GPS tracking active', 'info');
        }
        window.startTrip = startTrip;

        // â”€â”€ Haversine distance (meters) â”€â”€
        function haversineM(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // â”€â”€ Stationary detection logic â”€â”€
        function checkStationary(coord) {
            if (!tripActive || autoStopPrompted) return;

            if (!stationaryAnchor) {
                stationaryAnchor = { lat: coord.lat, lng: coord.lng, since: coord.ts };
                return;
            }

            const dist = haversineM(stationaryAnchor.lat, stationaryAnchor.lng, coord.lat, coord.lng);

            if (dist > STATIONARY_RADIUS_M) {
                // Moved â€” reset anchor
                stationaryAnchor = { lat: coord.lat, lng: coord.lng, since: coord.ts };
                return;
            }

            // Still within radius â€” check time
            const dwellMs = coord.ts - stationaryAnchor.since;
            if (dwellMs >= STATIONARY_TIMEOUT_MS) {
                autoStopPrompted = true;
                promptAutoStop();
            }
        }

        // â”€â”€ Auto-stop prompt â”€â”€
        async function promptAutoStop() {
            const isSourcing = await confirmAction('You\'ve been stationary for 10+ min. Are you sourcing here?');
            if (isSourcing && tripActive) {
                // Auto-stop with "Sourcing" purpose
                autoEndTrip('Sourcing');
            } else if (tripActive) {
                // User said no â€” allow them to keep going, but don't re-prompt for this stop
                toast('Trip continues â€” will check again if you stop elsewhere', 'info');
                // Reset anchor so it can detect a NEW stationary point
                stationaryAnchor = null;
                autoStopPrompted = false;
            }
        }

        function autoEndTrip(purpose) {
            if (!tripActive) return;

            clearInterval(tripTimerInterval);
            tripTimerInterval = null;
            stopGpsWatch();

            const elapsed = Math.floor((Date.now() - tripStartTimestamp) / 1000);
            const estimatedMiles = estimateTripMiles();

            tripActive = false;
            document.getElementById('tripBtnIcon').textContent = 'â–¶ï¸';
            document.getElementById('tripBtnText').textContent = 'Start Trip';
            document.getElementById('startTripBtn').style.background = '';

            // Show end form pre-filled
            document.getElementById('tripBannerLive').style.display = 'none';
            document.getElementById('tripEndForm').style.display = 'block';
            document.getElementById('tripEndMiles').value = estimatedMiles > 0 ? estimatedMiles.toFixed(1) : '';
            document.getElementById('tripEndPurpose').value = purpose || '';
            document.getElementById('tripEndElapsed').textContent = formatDuration(elapsed);
            document.getElementById('tripEndForm').dataset.elapsed = elapsed;
        }

        function showTripEndForm() {
            if (!tripActive) return;

            clearInterval(tripTimerInterval);
            tripTimerInterval = null;
            stopGpsWatch();

            const elapsed = Math.floor((Date.now() - tripStartTimestamp) / 1000);
            const estimatedMiles = estimateTripMiles();

            tripActive = false;
            document.getElementById('tripBtnIcon').textContent = 'â–¶ï¸';
            document.getElementById('tripBtnText').textContent = 'Start Trip';
            document.getElementById('startTripBtn').style.background = '';

            // Show inline end form
            document.getElementById('tripBannerLive').style.display = 'none';
            document.getElementById('tripEndForm').style.display = 'block';
            document.getElementById('tripEndMiles').value = estimatedMiles > 0 ? estimatedMiles.toFixed(1) : '';
            document.getElementById('tripEndPurpose').value = '';
            document.getElementById('tripEndElapsed').textContent = formatDuration(elapsed);
            document.getElementById('tripEndForm').dataset.elapsed = elapsed;
        }

        function stopGpsWatch() {
            if (gpsWatchId !== null) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            stationaryAnchor = null;
            autoStopPrompted = false;
        }

        // â”€â”€ Estimate miles from GPS breadcrumbs â”€â”€
        function estimateTripMiles() {
            if (tripCoords.length < 2) return 0;
            let totalM = 0;
            for (let i = 1; i < tripCoords.length; i++) {
                totalM += haversineM(tripCoords[i-1].lat, tripCoords[i-1].lng, tripCoords[i].lat, tripCoords[i].lng);
            }
            return totalM / 1609.34; // meters to miles
        }

        // â”€â”€ Save trip from inline form â”€â”€
        function saveTripFromForm() {
            const milesVal = parseFloat(document.getElementById('tripEndMiles').value);
            if (!milesVal || milesVal <= 0) {
                toast('Enter miles driven', 'error');
                return;
            }
            const purpose = document.getElementById('tripEndPurpose').value.trim() || 'Business trip';
            const elapsed = parseInt(document.getElementById('tripEndForm').dataset.elapsed) || 0;
            const deduction = Math.round(milesVal * IRS_MILEAGE_RATE * 100) / 100;
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

            const trip = {
                id: 'm' + Date.now(),
                date: dateStr,
                miles: milesVal,
                purpose: purpose,
                deduction: deduction,
                duration: elapsed,
                startLocation: tripStartLocation ? (tripStartLocation.lat.toFixed(4) + ', ' + tripStartLocation.lng.toFixed(4)) : null
            };
            mileageTrips.push(trip);

            // Auto-sync the consolidated Vehicle Expenses entry
            updateVehicleExpenseSummary();

            // Reset
            tripStartTimestamp = null;
            tripStartLocation = null;
            tripCoords = [];
            document.getElementById('liveTripBanner').style.display = 'none';
            document.getElementById('tripEndForm').style.display = 'none';

            renderMileage();
            renderExpenses();
            updateStats();
            saveToStorage();
            toast('Trip saved â€” $' + deduction.toFixed(2) + ' deduction');
        }
        window.saveTripFromForm = saveTripFromForm;

        // â”€â”€ Recurring "Vehicle Expenses" summary entry â”€â”€
        // Maintains a single auto-updating expense that totals all mileage deductions
        function cancelTripEnd() {
            tripStartTimestamp = null;
            tripStartLocation = null;
            tripCoords = [];
            document.getElementById('liveTripBanner').style.display = 'none';
            document.getElementById('tripEndForm').style.display = 'none';
            toast('Trip discarded', 'info');
        }
        window.cancelTripEnd = cancelTripEnd;

        function reverseGeocode(lat, lng, elementId) {
            fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng)
                .then(r => r.json())
                .then(data => {
                    if (data && data.display_name) {
                        const parts = data.display_name.split(',').slice(0, 3).join(',');
                        document.getElementById(elementId).textContent = 'ğŸ“ ' + parts;
                    }
                })
                .catch(() => {});
        }

        function updateTripTimer() {
            if (!tripStartTimestamp) return;
            const elapsed = Math.floor((Date.now() - tripStartTimestamp) / 1000);
            const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const s = String(elapsed % 60).padStart(2, '0');
            document.getElementById('tripTimer').textContent = h + ':' + m + ':' + s;
        }

        function stopTrip() {
            showTripEndForm();
        }
        window.stopTrip = stopTrip;

        function formatDuration(secs) {
            if (!secs || secs <= 0) return 'â€”';
            const h = Math.floor(secs / 3600);
            const m = Math.floor((secs % 3600) / 60);
            if (h > 0) return h + 'h ' + m + 'm';
            return m + 'm';
        }

        function openManualTripModal() {
            document.getElementById('manualTripForm').reset();
            document.getElementById('manualTripModalTitle').textContent = 'Log Trip';
            const today = new Date();
            document.getElementById('mileageQuickDate').value = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
            document.getElementById('mileageQuickCalc').style.display = 'none';
            document.getElementById('manualTripModal').classList.add('active'); window._pushModalState && _pushModalState('manualTripModal');
        }
        window.openManualTripModal = openManualTripModal;

        function closeManualTripModal() {
            document.getElementById('manualTripModal').classList.remove('active');
        }
        window.closeManualTripModal = closeManualTripModal;

        function saveManualTrip(event) {
            event.preventDefault();
            const miles = parseFloat(document.getElementById('mileageQuickMiles').value);
            const purpose = document.getElementById('mileageQuickPurpose').value.trim();
            const date = document.getElementById('mileageQuickDate').value;

            if (!miles || miles <= 0) { toast('Enter miles driven', 'error'); return; }
            if (!purpose) { toast('Enter a trip purpose', 'error'); return; }
            if (!date) { toast('Select a date', 'error'); return; }

            const deduction = Math.round(miles * IRS_MILEAGE_RATE * 100) / 100;
            mileageTrips.push({ id: 'm' + Date.now(), date: date, miles: miles, purpose: purpose, deduction: deduction, duration: null, startLocation: null });

            updateVehicleExpenseSummary();
            renderMileage();
            renderExpenses();
            updateStats();
            saveToStorage();
            closeManualTripModal();
        }
        window.saveManualTrip = saveManualTrip;

        async function deleteMileageTrip(tripId) {
            if (!await confirmAction('Delete this trip?')) return;
            mileageTrips = mileageTrips.filter(t => t.id !== tripId);
            updateVehicleExpenseSummary();
            renderMileage();
            renderExpenses();
            updateStats();
            saveToStorage();
            toast('Trip deleted');
        }
        window.deleteMileageTrip = deleteMileageTrip;

        function renderMileage() {
            const totalMiles = mileageTrips.reduce((s, t) => s + t.miles, 0);
            const totalDeduction = mileageTrips.reduce((s, t) => s + t.deduction, 0);
            const avgMiles = mileageTrips.length > 0 ? (totalMiles / mileageTrips.length).toFixed(1) : 0;

            // This month
            const now = new Date();
            const mStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthTrips = mileageTrips.filter(t => new Date(t.date + 'T12:00:00') >= mStart);
            const mMiles = monthTrips.reduce((s, t) => s + t.miles, 0);
            const mDed = monthTrips.reduce((s, t) => s + t.deduction, 0);

            // Update stats inside mileage tab
            document.getElementById('totalMiles').textContent = totalMiles.toFixed(1);
            document.getElementById('totalMileageDeduction').textContent = '$' + totalDeduction.toFixed(2);
            document.getElementById('totalTrips').textContent = mileageTrips.length;
            const avgEl = document.getElementById('avgMilesTrip');
            if (avgEl) avgEl.textContent = avgMiles > 0 ? ('Avg ' + avgMiles + ' mi/trip') : 'â€”';
            const mmEl = document.getElementById('monthMiles');
            if (mmEl) mmEl.textContent = mMiles.toFixed(1);
            const mdEl = document.getElementById('monthMilesDed');
            if (mdEl) mdEl.textContent = '$' + mDed.toFixed(2) + ' deduction';

            // Update header stat card
            const headerStat = document.getElementById('mileageDeductionStat');
            if (headerStat) headerStat.textContent = '$' + totalDeduction.toFixed(0);
            const headerSub = document.getElementById('mileageDeductionSub');
            if (headerSub) headerSub.textContent = mileageTrips.length + ' trip' + (mileageTrips.length !== 1 ? 's' : '') + ' Â· $0.70/mi';

            // Render trip log table
            const tbody = document.getElementById('mileageTripLog');
            const empty = document.getElementById('mileageEmpty');

            if (mileageTrips.length === 0) {
                tbody.innerHTML = '';
                if (empty) empty.style.display = 'block';
                tbody.parentElement.style.display = 'none';
                return;
            }

            if (empty) empty.style.display = 'none';
            tbody.parentElement.style.display = '';

            const sorted = [...mileageTrips].sort((a, b) => new Date(b.date) - new Date(a.date));
            tbody.innerHTML = '';

            sorted.forEach(trip => {
                const d = new Date(trip.date + 'T12:00:00');
                const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const durStr = trip.duration ? formatDuration(trip.duration) : 'â€”';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="white-space:nowrap;">${dateStr}</td>
                    <td style="font-weight:600;">
                        ${trip.purpose}
                        ${trip.startLocation ? '<div style="font-size:10px;color:var(--text-tertiary, var(--slate-400));margin-top:2px;">ğŸ“ ' + trip.startLocation + '</div>' : ''}
                    </td>
                    <td style="font-weight:700;font-variant-numeric:tabular-nums;">${trip.miles.toFixed(1)} mi</td>
                    <td style="font-weight:700;color:var(--emerald-500);font-variant-numeric:tabular-nums;">$${trip.deduction.toFixed(2)}</td>
                    <td style="color:var(--text-tertiary, var(--slate-400));">${durStr}</td>
                    <td><button onclick="deleteMileageTrip('${trip.id}')" style="background:none;border:none;color:var(--text-tertiary, var(--slate-400));cursor:pointer;font-size:14px;opacity:0.5;transition:opacity 0.15s;" onmouseover="this.style.opacity='1';this.style.color='var(--rose-500)'" onmouseout="this.style.opacity='0.5';this.style.color='var(--text-tertiary, var(--slate-400))'">ğŸ—‘</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Live calc preview for manual trip modal
        document.addEventListener('DOMContentLoaded', function() {
            const milesInput = document.getElementById('mileageQuickMiles');
            if (milesInput) {
                milesInput.addEventListener('input', function() {
                    const miles = parseFloat(this.value) || 0;
                    const calc = document.getElementById('mileageQuickCalc');
                    const amt = document.getElementById('mileageQuickAmt');
                    if (miles > 0) { calc.style.display = 'block'; amt.textContent = '$' + (miles * IRS_MILEAGE_RATE).toFixed(2); }
                    else { calc.style.display = 'none'; }
                });
            }
            // Close manual trip modal on backdrop
            document.getElementById('manualTripModal').addEventListener('click', function(e) { if (e.target === this) closeManualTripModal(); });
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BARCODE / QR CODE SCANNER + PRODUCT LOOKUP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let html5QrCode = null;
        let lastScanResult = null; // stores the looked-up product data

        function openScanModal() {
            document.getElementById('scanOverlay').style.display = 'flex'; window._pushModalState && _pushModalState('scanOverlay');
            document.getElementById('scanStatus').textContent = 'Starting cameraâ€¦';
            document.getElementById('scanStatus').className = 'scan-status loading';
            document.getElementById('scanResultPreview').classList.remove('visible');
            document.getElementById('scanActions').style.display = 'none';
            document.getElementById('manualBarcode').value = '';
            lastScanResult = null;
            startScanner();
        }

        function closeScanModal() {
            stopScanner();
            document.getElementById('scanOverlay').style.display = 'none';
        }
        window.closeScanModal = closeScanModal;

        async function startScanner() {
            if (typeof Html5Qrcode === 'undefined') {
                setScanStatus('Scanner library failed to load. Use manual entry below.', 'error');
                return;
            }

            try {
                html5QrCode = new Html5Qrcode('scanReader');

                await html5QrCode.start(
                    { facingMode: 'environment' }, // back camera
                    {
                        fps: 10,
                        qrbox: { width: 280, height: 160 },
                        aspectRatio: 1.5
                    },
                    onScanSuccess,
                    () => {} // ignore scan failures (happens every frame without a code)
                );

                setScanStatus('Point your camera at a barcode or QR code', '');
            } catch (err) {
                console.warn('Camera start failed:', err);
                setScanStatus('Camera not available â€” type the barcode number below', 'error');
            }
        }

        async function stopScanner() {
            if (html5QrCode) {
                try {
                    const state = html5QrCode.getState();
                    if (state === 2) { // Html5QrcodeState.SCANNING
                        await html5QrCode.stop();
                    }
                } catch(e) { /* already stopped */ }
                try { html5QrCode.clear(); } catch(e) {}
                html5QrCode = null;
            }
        }

        function setScanStatus(msg, type) {
            const el = document.getElementById('scanStatus');
            el.textContent = msg;
            el.className = 'scan-status' + (type ? ' ' + type : '');
        }

        async function onScanSuccess(decodedText) {
            // Pause scanner while we look up
            try { await html5QrCode.pause(true); } catch(e) {}

            setScanStatus('Code detected: ' + decodedText + ' â€” looking upâ€¦', 'loading');
            await lookupBarcode(decodedText);
        }

        function lookupManualBarcode() {
            const code = document.getElementById('manualBarcode').value.trim();
            if (!code) return;
            setScanStatus('Looking up: ' + code + 'â€¦', 'loading');
            lookupBarcode(code);
        }
        window.lookupManualBarcode = lookupManualBarcode;

        async function lookupBarcode(code) {
            document.getElementById('scanResultPreview').classList.remove('visible');
            document.getElementById('scanActions').style.display = 'none';

            try {
                // UPCitemdb free trial API â€” no key required, 100 lookups/day
                const resp = await fetch(
                    'https://api.upcitemdb.com/prod/trial/lookup?upc=' + encodeURIComponent(code)
                );

                if (resp.status === 429) {
                    setScanStatus('Rate limited â€” wait a moment and try again', 'error');
                    resumeScanner();
                    return;
                }

                if (!resp.ok) throw new Error('API returned ' + resp.status);

                const data = await resp.json();

                if (!data.items || data.items.length === 0) {
                    setScanStatus('No product found for: ' + code + ' â€” try another or fill manually', 'error');
                    lastScanResult = { barcode: code, title: '', brand: '', category: '', price: null };
                    showScanPreview(lastScanResult);
                    resumeScanner();
                    return;
                }

                const item = data.items[0];

                // Map UPCitemdb category to our closest category
                const mappedCategory = mapCategory(item.category || '');

                // Find a reasonable price from offers
                let avgPrice = null;
                if (item.offers && item.offers.length > 0) {
                    const prices = item.offers
                        .map(o => parseFloat(o.price))
                        .filter(p => !isNaN(p) && p > 0);
                    if (prices.length > 0) {
                        avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                    }
                }
                // Fallback to lowest_recorded_price
                if (!avgPrice && item.lowest_recorded_price) {
                    avgPrice = parseFloat(item.lowest_recorded_price);
                }

                lastScanResult = {
                    barcode: code,
                    title: item.title || '',
                    brand: item.brand || '',
                    category: mappedCategory,
                    price: avgPrice,
                    rawCategory: item.category || '',
                    description: item.description || '',
                    ean: item.ean || '',
                    upc: item.upc || ''
                };

                setScanStatus('âœ… Product found!', 'found');
                showScanPreview(lastScanResult);

            } catch (err) {
                console.error('Barcode lookup error:', err);
                // Still let user fill what we have
                lastScanResult = { barcode: code, title: '', brand: '', category: '', price: null };
                setScanStatus('Lookup failed â€” you can still auto-fill the barcode', 'error');
                showScanPreview(lastScanResult);
                resumeScanner();
            }
        }

        function resumeScanner() {
            if (html5QrCode) {
                try { html5QrCode.resume(); } catch(e) {}
            }
        }

        function showScanPreview(result) {
            document.getElementById('scanProductName').textContent = result.title || '(unknown product)';
            document.getElementById('scanBrand').textContent = result.brand || 'â€”';
            document.getElementById('scanCategory').textContent = result.rawCategory || result.category || 'â€”';
            document.getElementById('scanBarcode').textContent = result.barcode || 'â€”';
            document.getElementById('scanPrice').textContent = result.price ? '$' + result.price.toFixed(2) : 'â€”';

            document.getElementById('scanResultPreview').classList.add('visible');
            document.getElementById('scanActions').style.display = 'flex';
        }

        function fillFormFromScan() {
            if (!lastScanResult) return;

            closeScanModal();
            openModal(); // opens the Add Item modal

            // Give the modal a moment to render, then fill fields
            setTimeout(() => {
                const r = lastScanResult;

                if (r.title) {
                    document.getElementById('itemName').value = r.title;
                }

                // Use barcode as SKU
                if (r.barcode) {
                    document.getElementById('itemSKU').value = r.barcode;
                }

                // Set category dropdown
                if (r.category) {
                    const sel = document.getElementById('itemCategory');
                    for (let i = 0; i < sel.options.length; i++) {
                        if (sel.options[i].value === r.category) {
                            sel.selectedIndex = i;
                            break;
                        }
                    }
                }

                // Set source to brand if available
                if (r.brand) {
                    document.getElementById('itemSource').value = r.brand;
                }

                // Set purchase price hint if we have avg market price
                // (User will adjust â€” this is a starting reference)
                if (r.price && r.price > 0) {
                    // Leave purchase price blank but pre-fill sale price as market reference
                    document.getElementById('salePrice').value = r.price.toFixed(2);
                }

                // Flash the form to show it was auto-filled
                const form = document.getElementById('itemForm');
                form.style.transition = 'box-shadow 0.3s';
                form.style.boxShadow = '0 0 0 3px var(--indigo-300)';
                setTimeout(() => { form.style.boxShadow = ''; }, 1500);

            }, 200);
        }
        window.fillFormFromScan = fillFormFromScan;

        function scanAnother() {
            lastScanResult = null;
            document.getElementById('scanResultPreview').classList.remove('visible');
            document.getElementById('scanActions').style.display = 'none';
            setScanStatus('Point your camera at a barcode or QR code', '');
            resumeScanner();
        }
        window.scanAnother = scanAnother;

        // Map UPCitemdb categories to our dropdown values
        function mapCategory(apiCategory) {
            if (!apiCategory) return '';
            const c = apiCategory.toLowerCase();
            const map = [
                [['electronics', 'computer', 'laptop', 'phone', 'tablet', 'tech'], 'Electronics'],
                [['book', 'magazine', 'novel'], 'Books'],
                [['beauty', 'skincare', 'cosmetic', 'makeup'], 'Beauty & Skincare'],
                [['jewelry', 'jewel', 'necklace', 'ring', 'bracelet'], 'Jewelry'],
                [['toy', 'game', 'kid', 'children', 'collectible'], 'Kids Collectibles'],
                [['baby', 'infant', 'toddler'], 'Baby'],
                [['kitchen', 'dining', 'cookware'], 'Kitchen & Dining'],
                [['automotive', 'car', 'vehicle'], 'Automotive'],
                [['media', 'dvd', 'cd', 'vinyl', 'music', 'movie', 'video'], 'Media'],
                [['men', 'mens'], 'Mens Clothing'],
                [['women', 'womens', 'dress'], 'Womens Clothing'],
                [['health', 'wellness', 'vitamin', 'supplement'], 'Health & Wellness'],
                [['home', 'decor', 'furniture'], 'Home Decor'],
                [['accessori', 'bag', 'hat', 'sunglasses', 'watch'], 'Accessories'],
            ];
            for (const [keywords, value] of map) {
                if (keywords.some(kw => c.includes(kw))) return value;
            }
            return 'Other';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CSV IMPORT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let importParsedRows = [];
        let importColumnMap = {};

        // Our inventory fields and their display names
        const IMPORT_FIELDS = [
            { key: 'name', label: 'Item Name', required: true },
            { key: 'sku', label: 'SKU' },
            { key: 'qty', label: 'Quantity', numeric: true },
            { key: 'category', label: 'Category' },
            { key: 'source', label: 'Source' },
            { key: 'purchase', label: 'Purchase Price', numeric: true },
            { key: 'purchaseShipping', label: 'Purchase Shipping', numeric: true },
            { key: 'sale', label: 'Sale Price', numeric: true },
            { key: 'outboundShipping', label: 'Outbound Shipping', numeric: true },
            { key: 'packaging', label: 'Packaging Cost', numeric: true },
            { key: 'platformFees', label: 'Platform Fees', numeric: true },
            { key: 'taxReserve', label: 'Tax Reserve', numeric: true },
            { key: 'platform', label: 'Platform' },
            { key: 'status', label: 'Status' },
            { key: 'days', label: 'Days Listed', numeric: true },
            { key: 'dateSold', label: 'Date Sold' },
            { key: '_skip', label: 'â€” Skip this column â€”' }
        ];

        // Fuzzy match CSV headers to our fields
        function guessFieldMapping(header) {
            const h = header.toLowerCase().replace(/[^a-z0-9]/g, '');
            const guesses = [
                [/^(item|name|title|product|description)/, 'name'],
                [/^(sku|code|barcode|upc|itemcode|id)/, 'sku'],
                [/^(qty|quantity|stock|count|units|amount)/, 'qty'],
                [/^(cat|category|type)/, 'category'],
                [/^(source|store|supplier|vendor|from|bought)/, 'source'],
                [/^(purchase|cost|paid|buyprice|purchaseprice|cog)/, 'purchase'],
                [/^(purchaseship|inboundship|shippingin)/, 'purchaseShipping'],
                [/^(sale|sell|sold|price|saleprice|sellprice|revenue)/, 'sale'],
                [/^(outbound|shipout|shippingout|outboundship)/, 'outboundShipping'],
                [/^(pack|packaging)/, 'packaging'],
                [/^(fee|platformfee|sellingfee)/, 'platformFees'],
                [/^(tax|taxreserve)/, 'taxReserve'],
                [/^(platform|marketplace|channel|listedon|soldon)/, 'platform'],
                [/^(status|state|condition)/, 'status'],
                [/^(day|dayslisted|daysactive|age)/, 'days'],
                [/^(datesold|solddate|saledate|sold)/, 'dateSold'],
                [/^(profit)/, '_skip'], // we compute profit, don't import it
            ];
            for (const [regex, field] of guesses) {
                if (regex.test(h)) return field;
            }
            return '_skip';
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            if (lines.length < 2) return { headers: [], rows: [] };

            // Detect delimiter
            const firstLine = lines[0];
            const delim = firstLine.includes('\t') ? '\t' : ',';

            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (inQuotes) {
                        if (ch === '"' && line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else if (ch === '"') {
                            inQuotes = false;
                        } else {
                            current += ch;
                        }
                    } else {
                        if (ch === '"') {
                            inQuotes = true;
                        } else if (ch === delim) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += ch;
                        }
                    }
                }
                result.push(current.trim());
                return result;
            }

            const headers = parseLine(lines[0]);
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const vals = parseLine(lines[i]);
                if (vals.length > 0 && vals.some(v => v)) {
                    const row = {};
                    headers.forEach((h, idx) => { row[h] = vals[idx] || ''; });
                    rows.push(row);
                }
            }
            return { headers, rows };
        }

        function openImportModal(file) {
            document.getElementById('importOverlay').style.display = 'flex'; window._pushModalState && _pushModalState('importOverlay');
            document.getElementById('importStatus').textContent = 'Parsing your fileâ€¦';
            document.getElementById('importStatus').className = 'scan-status loading';
            document.getElementById('importMappingArea').style.display = 'none';
            document.getElementById('importActions').style.display = 'none';
            importParsedRows = [];
            importColumnMap = {};

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const { headers, rows } = parseCSV(text);

                if (headers.length === 0 || rows.length === 0) {
                    document.getElementById('importStatus').textContent = 'Could not parse any rows. Check your CSV format.';
                    document.getElementById('importStatus').className = 'scan-status error';
                    return;
                }

                importParsedRows = rows;

                // Auto-guess mappings
                headers.forEach(h => {
                    importColumnMap[h] = guessFieldMapping(h);
                });

                // Build mapping UI
                buildMappingUI(headers, rows);

                document.getElementById('importStatus').textContent = 'âœ… File parsed â€” review column mapping below';
                document.getElementById('importStatus').className = 'scan-status found';
                document.getElementById('importMappingArea').style.display = 'block';
                document.getElementById('importActions').style.display = 'flex';
            };
            reader.onerror = function() {
                document.getElementById('importStatus').textContent = 'Failed to read file.';
                document.getElementById('importStatus').className = 'scan-status error';
            };
            reader.readAsText(file);
        }

        function buildMappingUI(headers, rows) {
            const container = document.getElementById('importMappingRows');
            container.innerHTML = '';

            headers.forEach(csvHeader => {
                const sample = rows.slice(0, 3).map(r => r[csvHeader]).filter(Boolean).join(', ');
                const row = document.createElement('div');
                row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-primary,#e2e8f0);flex-wrap:wrap;';
                row.innerHTML = `
                    <div style="flex:1;min-width:120px;">
                        <div style="font-size:13px;font-weight:600;color:var(--text-primary,#0f172a);">${csvHeader}</div>
                        <div style="font-size:11px;color:var(--text-tertiary,#94a3b8);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:160px;" title="${sample}">e.g. ${sample || '(empty)'}</div>
                    </div>
                    <div style="font-size:12px;color:var(--text-tertiary,#94a3b8);">â†’</div>
                    <select class="form-input import-map-select" data-csv-header="${csvHeader}" style="flex:1;min-width:140px;padding:8px 10px;font-size:13px;border-radius:8px;">
                        ${IMPORT_FIELDS.map(f =>
                            `<option value="${f.key}" ${importColumnMap[csvHeader] === f.key ? 'selected' : ''}>${f.label}</option>`
                        ).join('')}
                    </select>
                `;
                container.appendChild(row);
            });

            // Listen for mapping changes
            container.querySelectorAll('.import-map-select').forEach(sel => {
                sel.addEventListener('change', function() {
                    importColumnMap[this.dataset.csvHeader] = this.value;
                });
            });

            // Preview count & dupe check
            document.getElementById('importPreviewCount').textContent = rows.length;
            const existingNames = new Set(inventory.map(i => i.name.toLowerCase().trim()));
            const dupes = rows.filter(r => {
                const nameCol = Object.keys(importColumnMap).find(k => importColumnMap[k] === 'name');
                return nameCol && existingNames.has((r[nameCol] || '').toLowerCase().trim());
            });
            if (dupes.length > 0) {
                document.getElementById('importDupeWarning').style.display = 'inline';
                document.getElementById('importDupeCount').textContent = dupes.length;
            } else {
                document.getElementById('importDupeWarning').style.display = 'none';
            }
        }

        function confirmImport() {
            if (importParsedRows.length === 0) return;

            // Build reverse map: our field -> csv column
            const fieldToCSV = {};
            for (const [csvCol, ourField] of Object.entries(importColumnMap)) {
                if (ourField !== '_skip' && !fieldToCSV[ourField]) {
                    fieldToCSV[ourField] = csvCol;
                }
            }

            // Validate: must have at least a name mapping
            if (!fieldToCSV.name) {
                document.getElementById('importStatus').textContent = 'âŒ You must map at least one column to "Item Name"';
                document.getElementById('importStatus').className = 'scan-status error';
                return;
            }

            const validStatuses = ['Listed', 'Sold', 'Shipped', 'Returned', 'Lost/Damaged', 'Unlisted'];
            let imported = 0;
            let skipped = 0;

            importParsedRows.forEach(row => {
                const name = (row[fieldToCSV.name] || '').trim();
                if (!name) { skipped++; return; }

                function getVal(field) { return fieldToCSV[field] ? (row[fieldToCSV[field]] || '').trim() : ''; }
                function getNum(field) {
                    const v = getVal(field);
                    const n = parseFloat(v.replace(/[$,]/g, ''));
                    return isNaN(n) ? 0 : n;
                }
                function getNumOrNull(field) {
                    const v = getVal(field);
                    if (!v) return null;
                    const n = parseFloat(v.replace(/[$,]/g, ''));
                    return isNaN(n) ? null : n;
                }

                const purchase = getNum('purchase');
                const purchaseShipping = getNum('purchaseShipping');
                const sale = getNumOrNull('sale');
                const outboundShipping = getNum('outboundShipping');
                const packaging = getNum('packaging');
                const platformFees = getNum('platformFees');
                const taxReserve = getNum('taxReserve');
                const profit = sale !== null ? sale - purchase - purchaseShipping - outboundShipping - packaging - platformFees - taxReserve : null;

                let status = getVal('status') || 'Listed';
                if (!validStatuses.includes(status)) {
                    // Try to match loosely
                    const sl = status.toLowerCase();
                    if (sl.includes('sold')) status = 'Sold';
                    else if (sl.includes('ship')) status = 'Shipped';
                    else if (sl.includes('return')) status = 'Returned';
                    else if (sl.includes('lost') || sl.includes('damage')) status = 'Lost/Damaged';
                    else if (sl.includes('unlist')) status = 'Unlisted';
                    else status = 'Listed';
                }

                let dateSold = null;
                const ds = getVal('dateSold');
                if (ds) {
                    const parsed = new Date(ds);
                    if (!isNaN(parsed.getTime())) dateSold = parsed;
                }

                const item = {
                    name: name,
                    sku: getVal('sku') || generateImportSKU(getVal('category') || 'IMP'),
                    qty: parseInt(getVal('qty')) || 1,
                    category: getVal('category') || 'Other',
                    source: getVal('source') || '',
                    purchase: purchase,
                    purchaseShipping: purchaseShipping,
                    sale: sale,
                    outboundShipping: outboundShipping,
                    packaging: packaging,
                    profit: profit,
                    platformFees: platformFees,
                    taxReserve: taxReserve,
                    platform: getVal('platform') || null,
                    status: status,
                    days: status === 'Sold' ? 0 : parseInt(getVal('days')) || 0,
                    dateSold: dateSold,
                    photos: []
                };

                inventory.push(item);
                imported++;
            });

            // Save and refresh
            saveToStorage();
            init();

            document.getElementById('importStatus').textContent = `âœ… Imported ${imported} items` + (skipped > 0 ? ` (${skipped} skipped â€” no name)` : '');
            document.getElementById('importStatus').className = 'scan-status found';
            document.getElementById('importActions').style.display = 'none';
            document.getElementById('importMappingArea').style.display = 'none';

            // Auto-close after a moment
            setTimeout(closeImportModal, 2000);
        }
        window.confirmImport = confirmImport;

        function generateImportSKU(category) {
            const prefix = (category || 'IMP').substring(0, 3).toUpperCase();
            const random = Math.floor(Math.random() * 9000) + 1000;
            return prefix + '-' + random;
        }

        function closeImportModal() {
            document.getElementById('importOverlay').style.display = 'none';
            importParsedRows = [];
            importColumnMap = {};
            // Reset file input so the same file can be re-selected
            document.getElementById('csvFileInput').value = '';
        }
        window.closeImportModal = closeImportModal;

        function init() {
            updateVehicleExpenseSummary();
            renderInventory();
            renderGallery();
            renderPlatforms();
            populateCategories();
            updateStats();
            updatePlatformDropdowns();
            renderWeeklyAnalytics();
            renderMonthlyAnalytics();
            renderCategoriesAnalytics();
            renderTasks();
            renderExpenses();
            renderMileage();
            checkStaleItems();
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function switchPeriod(period) {
            currentPeriod = period;
            
            // Hide all breakdowns
            document.getElementById('weeklyBreakdown').style.display = 'none';
            document.getElementById('monthlyBreakdown').style.display = 'none';
            document.getElementById('categoriesBreakdown').style.display = 'none';
            
            // Reset all buttons to secondary
            document.getElementById('weeklyBtn').className = 'btn btn-secondary';
            document.getElementById('monthlyBtn').className = 'btn btn-secondary';
            document.getElementById('categoriesBtn').className = 'btn btn-secondary';
            
            // Show selected breakdown and highlight button
            if (period === 'weekly') {
                document.getElementById('weeklyBreakdown').style.display = 'block';
                document.getElementById('weeklyBtn').className = 'btn btn-primary';
            } else if (period === 'monthly') {
                document.getElementById('monthlyBreakdown').style.display = 'block';
                document.getElementById('monthlyBtn').className = 'btn btn-primary';
            } else if (period === 'categories') {
                document.getElementById('categoriesBreakdown').style.display = 'block';
                document.getElementById('categoriesBtn').className = 'btn btn-primary';
                renderCategoriesAnalytics();
            }
        }

        function renderWeeklyAnalytics() {
            const soldItems = inventory.filter(item => item.status === 'Sold' && item.dateSold);
            
            // Get current week data
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            weekStart.setHours(0, 0, 0, 0);
            
            const thisWeekItems = soldItems.filter(item => {
                return item.dateSold >= weekStart;
            });
            
            const thisWeekRevenue = thisWeekItems.reduce((sum, item) => sum + (item.sale || 0), 0);
            const thisWeekAvg = thisWeekItems.length > 0 ? thisWeekRevenue / thisWeekItems.length : 0;
            
            document.getElementById('thisWeekRevenue').textContent = '$' + thisWeekRevenue.toFixed(0);
            document.getElementById('thisWeekItems').textContent = thisWeekItems.length;
            document.getElementById('thisWeekAvg').textContent = '$' + thisWeekAvg.toFixed(0);
            
            // Day breakdown (last 7 days)
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayData = {};
            
            days.forEach(day => {
                dayData[day] = { items: 0, revenue: 0, profit: 0 };
            });
            
            soldItems.forEach(item => {
                if (item.dateSold) {
                    const dayName = days[item.dateSold.getDay()];
                    dayData[dayName].items++;
                    dayData[dayName].revenue += item.sale || 0;
                    dayData[dayName].profit += item.profit || 0;
                }
            });
            
            const tbody = document.getElementById('weeklyBody');
            tbody.innerHTML = '';
            
            days.forEach(day => {
                const data = dayData[day];
                const avgProfit = data.items > 0 ? data.profit / data.items : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${day}</td>
                    <td>${data.items}</td>
                    <td class="price">$${data.revenue.toFixed(2)}</td>
                    <td class="profit-positive">$${data.profit.toFixed(2)}</td>
                    <td>$${avgProfit.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Best days
            const bestDays = Object.entries(dayData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 3);
            
            const bestDaysBody = document.getElementById('bestDaysBody');
            bestDaysBody.innerHTML = '';
            
            bestDays.forEach(([day, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${day}</td>
                    <td class="price">$${data.revenue.toFixed(2)}</td>
                    <td>${data.items}</td>
                `;
                bestDaysBody.appendChild(row);
            });
            
            // Selling times (mock data for demo)
            document.getElementById('morningCount').textContent = Math.floor(thisWeekItems.length * 0.25) + ' sales';
            document.getElementById('afternoonCount').textContent = Math.floor(thisWeekItems.length * 0.35) + ' sales';
            document.getElementById('eveningCount').textContent = Math.floor(thisWeekItems.length * 0.30) + ' sales';
            document.getElementById('nightCount').textContent = Math.floor(thisWeekItems.length * 0.10) + ' sales';
        }

        function renderMonthlyAnalytics() {
            const soldItems = inventory.filter(item => item.status === 'Sold' && item.dateSold);
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            
            const monthData = {};
            months.forEach(month => {
                monthData[month] = { items: 0, revenue: 0, profit: 0 };
            });
            
            soldItems.forEach(item => {
                if (item.dateSold) {
                    const monthName = months[item.dateSold.getMonth()];
                    monthData[monthName].items++;
                    monthData[monthName].revenue += item.sale || 0;
                    monthData[monthName].profit += item.profit || 0;
                }
            });
            
            // Current month stats
            const now = new Date();
            const currentMonthName = months[now.getMonth()];
            const currentMonth = monthData[currentMonthName];
            
            document.getElementById('thisMonthRevenue').textContent = '$' + currentMonth.revenue.toFixed(0);
            document.getElementById('thisMonthItems').textContent = currentMonth.items;
            
            // Find best month
            const bestMonth = Object.entries(monthData)
                .sort((a, b) => b[1].revenue - a[1].revenue)[0];
            document.getElementById('bestMonth').textContent = bestMonth ? bestMonth[0] : '-';
            
            // Render monthly table
            const tbody = document.getElementById('monthlyBody');
            tbody.innerHTML = '';
            
            let prevRevenue = 0;
            months.forEach(month => {
                const data = monthData[month];
                const avgProfit = data.items > 0 ? data.profit / data.items : 0;
                const growth = prevRevenue > 0 ? ((data.revenue - prevRevenue) / prevRevenue * 100) : 0;
                const growthClass = growth > 0 ? 'profit-positive' : growth < 0 ? 'profit-negative' : '';
                const growthSymbol = growth > 0 ? 'â†‘' : growth < 0 ? 'â†“' : 'â†’';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month}</td>
                    <td>${data.items}</td>
                    <td class="price">$${data.revenue.toFixed(2)}</td>
                    <td class="profit-positive">$${data.profit.toFixed(2)}</td>
                    <td>$${avgProfit.toFixed(2)}</td>
                    <td class="${growthClass}">${data.revenue > 0 ? growthSymbol + ' ' + Math.abs(growth).toFixed(1) + '%' : '-'}</td>
                `;
                tbody.appendChild(row);
                
                if (data.revenue > 0) prevRevenue = data.revenue;
            });
            
            // Year totals
            const yearRevenue = soldItems.reduce((sum, item) => sum + (item.sale || 0), 0);
            const yearProfit = soldItems.reduce((sum, item) => sum + (item.profit || 0), 0);
            const monthsWithSales = Object.values(monthData).filter(m => m.revenue > 0).length;
            const avgMonthly = monthsWithSales > 0 ? yearRevenue / monthsWithSales : 0;
            
            document.getElementById('yearRevenue').textContent = '$' + yearRevenue.toFixed(2);
            document.getElementById('yearProfit').textContent = '$' + yearProfit.toFixed(2);
            document.getElementById('avgMonthlyRevenue').textContent = '$' + avgMonthly.toFixed(2);
            document.getElementById('yearItems').textContent = soldItems.length;
            
            // Category performance
            const categoryData = {};
            soldItems.forEach(item => {
                if (!categoryData[item.category]) {
                    categoryData[item.category] = { items: 0, revenue: 0 };
                }
                categoryData[item.category].items++;
                categoryData[item.category].revenue += item.sale || 0;
            });
            
            const topCategories = Object.entries(categoryData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            const categoryBody = document.getElementById('categoryBody');
            categoryBody.innerHTML = '';
            
            topCategories.forEach(([category, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category}</td>
                    <td>${data.items}</td>
                    <td class="price">$${data.revenue.toFixed(2)}</td>
                `;
                categoryBody.appendChild(row);
            });
        }

        function renderCategoriesAnalytics() {
            // Collect all categories
            const categoryStats = {};
            
            inventory.forEach(item => {
                if (!categoryStats[item.category]) {
                    categoryStats[item.category] = {
                        total: 0,
                        sold: 0,
                        listed: 0,
                        revenue: 0,
                        profit: 0,
                        totalCost: 0,
                        days: []
                    };
                }
                
                const cat = categoryStats[item.category];
                cat.total++;
                
                if (item.status === 'Sold') {
                    cat.sold++;
                    cat.revenue += item.sale || 0;
                    cat.profit += item.profit || 0;
                    cat.totalCost += item.purchase || 0;
                    if (item.days) cat.days.push(item.days);
                } else if (item.status === 'Listed') {
                    cat.listed++;
                }
            });
            
            // Summary stats
            const totalCategories = Object.keys(categoryStats).length;
            const bestPerformer = Object.entries(categoryStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)[0];
            
            const categoriesWithROI = Object.entries(categoryStats)
                .filter(([_, data]) => data.totalCost > 0)
                .map(([name, data]) => ({
                    name,
                    roi: (data.profit / data.totalCost) * 100
                }))
                .sort((a, b) => b.roi - a.roi);
            
            const allDays = Object.values(categoryStats).flatMap(cat => cat.days);
            const avgDays = allDays.length > 0 ? allDays.reduce((a, b) => a + b, 0) / allDays.length : 0;
            
            document.getElementById('totalCategories').textContent = totalCategories;
            document.getElementById('bestCategory').textContent = bestPerformer ? bestPerformer[0] : '-';
            document.getElementById('bestROI').textContent = categoriesWithROI.length > 0 
                ? categoriesWithROI[0].name : '-';
            document.getElementById('avgSellTime').textContent = avgDays.toFixed(0) + 'd';
            
            // Main table
            const tbody = document.getElementById('categoriesTableBody');
            tbody.innerHTML = '';
            
            Object.entries(categoryStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .forEach(([category, data]) => {
                    const sellThrough = data.total > 0 ? (data.sold / data.total * 100) : 0;
                    const avgROI = data.totalCost > 0 ? (data.profit / data.totalCost * 100) : 0;
                    const avgDays = data.days.length > 0 ? data.days.reduce((a, b) => a + b, 0) / data.days.length : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight: 600;">${category}</td>
                        <td>${data.total}</td>
                        <td class="profit-positive">${data.sold}</td>
                        <td class="price">${data.listed}</td>
                        <td>${sellThrough.toFixed(1)}%</td>
                        <td class="price">$${data.revenue.toFixed(2)}</td>
                        <td class="profit-positive">$${data.profit.toFixed(2)}</td>
                        <td class="${avgROI > 50 ? 'profit-positive' : ''}">${avgROI.toFixed(1)}%</td>
                        <td>${avgDays > 0 ? avgDays.toFixed(0) + 'd' : '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            
            // Top categories chart
            const topCategories = Object.entries(categoryStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            const maxRevenue = topCategories[0] ? topCategories[0][1].revenue : 1;
            
            const chartDiv = document.getElementById('topCategoriesChart');
            chartDiv.innerHTML = '';
            
            topCategories.forEach(([category, data]) => {
                const percentage = (data.revenue / maxRevenue) * 100;
                const barDiv = document.createElement('div');
                barDiv.style.marginBottom = '20px';
                barDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">${category}</span>
                        <span style="color: var(--success);">$${data.revenue.toFixed(2)}</span>
                    </div>
                    <div style="width: 100%; height: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.5s ease;"></div>
                    </div>
                `;
                chartDiv.appendChild(barDiv);
            });
            
            // Quick stats
            const mostListed = Object.entries(categoryStats)
                .sort((a, b) => b[1].total - a[1].total)[0];
            document.getElementById('mostListed').textContent = mostListed ? mostListed[0] : '-';
            
            const fastestSelling = Object.entries(categoryStats)
                .filter(([_, data]) => data.days.length > 0)
                .map(([name, data]) => ({
                    name,
                    avgDays: data.days.reduce((a, b) => a + b, 0) / data.days.length
                }))
                .sort((a, b) => a.avgDays - b.avgDays)[0];
            document.getElementById('fastestSelling').textContent = fastestSelling 
                ? `${fastestSelling.name} (${fastestSelling.avgDays.toFixed(0)}d)` : '-';
            
            const highestPrice = Object.entries(categoryStats)
                .filter(([_, data]) => data.sold > 0)
                .map(([name, data]) => ({
                    name,
                    avgPrice: data.revenue / data.sold
                }))
                .sort((a, b) => b.avgPrice - a.avgPrice)[0];
            document.getElementById('highestPrice').textContent = highestPrice 
                ? `${highestPrice.name} ($${highestPrice.avgPrice.toFixed(0)})` : '-';
            
            const mostProfitable = inventory
                .filter(item => item.status === 'Sold')
                .sort((a, b) => (b.profit || 0) - (a.profit || 0))[0];
            document.getElementById('mostProfitableItem').textContent = mostProfitable 
                ? `${mostProfitable.name} ($${mostProfitable.profit.toFixed(0)})` : '-';
            
            const categoriesWithStock = Object.values(categoryStats)
                .filter(data => data.listed > 0).length;
            document.getElementById('categoriesWithStock').textContent = categoriesWithStock;
            
            // Category trends over time
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const categoryTrends = {};
            
            inventory.filter(item => item.status === 'Sold' && item.dateSold).forEach(item => {
                if (!categoryTrends[item.category]) {
                    categoryTrends[item.category] = { Jan: 0, Feb: 0, Mar: 0, Apr: 0, May: 0, Jun: 0 };
                }
                const monthName = months[item.dateSold.getMonth()];
                if (monthName) categoryTrends[item.category][monthName]++;
            });
            
            const trendsBody = document.getElementById('categoryTrendsBody');
            trendsBody.innerHTML = '';
            
            Object.entries(categoryTrends)
                .sort((a, b) => {
                    const aTotal = Object.values(a[1]).reduce((sum, val) => sum + val, 0);
                    const bTotal = Object.values(b[1]).reduce((sum, val) => sum + val, 0);
                    return bTotal - aTotal;
                })
                .slice(0, 8)
                .forEach(([category, monthData]) => {
                    const values = months.map(m => monthData[m]);
                    const trend = values[values.length - 1] > values[0] ? 'ğŸ“ˆ' : 
                                 values[values.length - 1] < values[0] ? 'ğŸ“‰' : 'â¡ï¸';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight: 600;">${category}</td>
                        ${months.map(m => `<td>${monthData[m] || '-'}</td>`).join('')}
                        <td style="font-size: 1.2em;">${trend}</td>
                    `;
                    trendsBody.appendChild(row);
                });
        }

        function getSortedIndices() {
            // Build array of [originalIndex, item] then sort, return indices
            const indices = inventory.map((item, i) => i);
            
            if (!sortColumn) return indices;
            
            const getValue = (item) => {
                const cost = (item.purchase || 0) + (item.purchaseShipping || 0);
                const fees = (item.platformFees || 0) + (item.outboundShipping || 0) + (item.packaging || 0);
                switch (sortColumn) {
                    case 'name': return (item.name || '').toLowerCase();
                    case 'qty': return item.qty || 1;
                    case 'category': return (item.category || '').toLowerCase();
                    case 'cost': return cost;
                    case 'sale': return item.sale || 0;
                    case 'fees': return fees;
                    case 'profit': return item.profit || 0;
                    case 'tax': return item.taxReserve || 0;
                    case 'platform': return (item.platform || '').toLowerCase();
                    case 'status': return item.status || '';
                    default: return 0;
                }
            };
            
            indices.sort((a, b) => {
                const va = getValue(inventory[a]);
                const vb = getValue(inventory[b]);
                let cmp = 0;
                if (typeof va === 'string') {
                    cmp = va.localeCompare(vb);
                } else {
                    cmp = va - vb;
                }
                return sortDirection === 'desc' ? -cmp : cmp;
            });
            
            return indices;
        }

        function sortInventory(column) {
            if (sortColumn === column) {
                // Toggle direction
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update header arrows
            document.querySelectorAll('#inventoryTable th.sortable').forEach(th => {
                th.classList.remove('sort-active', 'sort-desc');
            });
            const activeHeaders = document.querySelectorAll('#inventoryTable th.sortable');
            activeHeaders.forEach(th => {
                if (th.getAttribute('onclick') && th.getAttribute('onclick').includes("'" + column + "'")) {
                    th.classList.add('sort-active');
                    if (sortDirection === 'desc') th.classList.add('sort-desc');
                }
            });
            
            // Clear selection since indices change visually
            selectedItems.clear();
            updateBulkBar();
            const cb = document.getElementById('selectAllCb');
            if (cb) { cb.checked = false; cb.indeterminate = false; }
            
            renderInventory();
            if (currentView === 'grid') renderGallery();
        }
        window.sortInventory = sortInventory;

        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            const sortedIndices = getSortedIndices();
            
            sortedIndices.forEach((index) => {
                const item = inventory[index];
                const row = document.createElement('tr');
                const statusClass = item.status.toLowerCase().replace(/[\/\s]/g, '-');
                const profitClass = item.profit > 0 ? 'profit-positive' : item.profit < 0 ? 'profit-negative' : '';
                
                const totalCost = (item.purchase || 0) + (item.purchaseShipping || 0);
                const totalFees = (item.platformFees || 0) + (item.outboundShipping || 0) + (item.packaging || 0);
                
                const isSelected = selectedItems.has(index);
                if (isSelected) row.classList.add('row-selected');
                
                // Create photo thumbnails
                let photoHTML = '';
                if (item.photos && item.photos.length > 0) {
                    photoHTML = '<div class="item-photo-gallery">';
                    item.photos.slice(0, 3).forEach(photo => {
                        photoHTML += `<img src="${photo}" class="item-photo-thumb" onclick="viewItemPhotos(${index})" title="Click to view all photos">`;
                    });
                    if (item.photos.length > 3) {
                        photoHTML += `<span style="font-size: 12px; color: var(--primary);">+${item.photos.length - 3}</span>`;
                    }
                    photoHTML += '</div>';
                } else {
                    photoHTML = '<span style="opacity: 0.5; font-size: 12px;">No photos</span>';
                }
                
                row.innerHTML = `
                    <td style="width:36px;" onclick="event.stopPropagation();">
                        <input type="checkbox" style="width:16px;height:16px;accent-color:var(--indigo-600);cursor:pointer;" ${isSelected ? 'checked' : ''} onchange="toggleItemSelect(${index}, this.checked)">
                    </td>
                    <td>${photoHTML}</td>
                    <td>${item.name}</td>
                    <td onclick="event.stopPropagation();">
                        <div class="qty-stepper">
                            <button onclick="adjustQty(${index}, -1)">âˆ’</button>
                            <span data-qty-idx="${index}">${item.qty || 1}</span>
                            <button onclick="adjustQty(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td>${item.category}</td>
                    <td class="price" title="Purchase: $${item.purchase || 0} + Shipping: $${item.purchaseShipping || 0}">$${totalCost.toFixed(2)}</td>
                    <td class="price">${item.sale ? '$' + item.sale : '-'}</td>
                    <td title="Platform: $${(item.platformFees || 0).toFixed(2)} + Shipping: $${item.outboundShipping || 0} + Packaging: $${item.packaging || 0}">$${totalFees.toFixed(2)}</td>
                    <td class="${profitClass}">${item.profit ? '$' + item.profit.toFixed(2) : '-'}</td>
                    <td>${item.taxReserve ? '$' + item.taxReserve.toFixed(2) : '-'}</td>
                    <td>${item.platform || '-'}</td>
                    <td><span class="status-badge status-${statusClass}">${item.status}</span></td>
                `;
                row.onclick = (e) => {
                    if (!e.target.classList.contains('item-photo-thumb') && e.target.type !== 'checkbox') {
                        openEditModal(index);
                    }
                };
                tbody.appendChild(row);
            });
        }

        function adjustQty(index, delta) {
            const item = inventory[index];
            item.qty = Math.max(0, (item.qty || 1) + delta);
            // Update in-place â€” find all steppers for this index and update the span
            document.querySelectorAll(`[data-qty-idx="${index}"]`).forEach(span => {
                span.textContent = item.qty;
            });
            updateStats();
            saveToStorage();
        }
        window.adjustQty = adjustQty;

        function renderPlatforms() {
            const tbody = document.getElementById('platformsBody');
            tbody.innerHTML = '';
            
            platforms.forEach((platform, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${platform.name}</td>
                    <td>${platform.feePercent}%</td>
                    <td>$${platform.fixedFee.toFixed(2)}</td>
                    <td>${platform.avgDays || '-'} days</td>
                    <td>${(platform.successRate * 100).toFixed(0)}%</td>
                    <td>${platform.totalSales}</td>
                `;
                row.onclick = () => openEditPlatformModal(index);
                tbody.appendChild(row);
            });
        }

        function populateCategories() {
            const categories = [...new Set(inventory.map(item => item.category))].sort();
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            
            // Populate platform filter
            const platNames = [...new Set(inventory.map(item => item.platform).filter(Boolean))].sort();
            const platSelect = document.getElementById('platformFilter');
            platSelect.innerHTML = '<option value="">All Platforms</option>';
            platNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                platSelect.appendChild(option);
            });
        }

        function updateStats() {
            const sold = inventory.filter(i => i.status === 'Sold');
            const listed = inventory.filter(i => i.status === 'Listed');
            const totalRevenue = sold.reduce((sum, i) => sum + (i.sale || 0), 0);
            const totalProfit = sold.reduce((sum, i) => sum + (i.profit || 0), 0);
            const totalTaxReserve = sold.reduce((sum, i) => sum + (i.taxReserve || 0), 0);
            const totalCost = sold.reduce((sum, i) => sum + ((i.purchase || 0) + (i.purchaseShipping || 0)), 0);

            // Separate mileage from other expenses to avoid double-counting
            const mileageDeduction = mileageTrips.reduce((s, t) => s + (t.deduction || 0), 0);
            const nonMileageExpenses = expenses.filter(e => e.id !== 'auto_vehicle_expense').reduce((s, e) => s + (e.amount || 0), 0);
            
            // Net Profit = item profits - non-mileage expenses - mileage deduction
            const adjustedProfit = totalProfit - nonMileageExpenses - mileageDeduction;
            const roi = totalCost > 0 ? ((adjustedProfit / totalCost) * 100) : 0;
            
            document.getElementById('itemsSold').textContent = sold.length;
            document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString();
            document.getElementById('netProfit').textContent = (adjustedProfit >= 0 ? '$' : '-$') + Math.abs(adjustedProfit).toFixed(0);
            document.getElementById('netProfit').style.color = adjustedProfit >= 0 ? '' : 'var(--rose-500)';
            document.getElementById('netProfitChange').textContent = (roi >= 0 ? 'â†‘ ' : 'â†“ ') + Math.abs(roi).toFixed(1) + '% ROI (after expenses + mileage)';
            document.getElementById('netProfitChange').className = 'stat-change ' + (adjustedProfit >= 0 ? 'positive' : 'negative');
            document.getElementById('taxReserveTotal').textContent = '$' + totalTaxReserve.toFixed(0);

            // Update mileage deduction stat card
            document.getElementById('mileageDeductionStat').textContent = '$' + mileageDeduction.toFixed(0);
            document.getElementById('mileageDeductionSub').textContent = mileageTrips.length + ' trips Â· $' + IRS_MILEAGE_RATE.toFixed(2) + '/mi';
        }

        // â”€â”€ Bridge mileage â†’ expenses: auto-sync Vehicle Expenses entry â”€â”€
        function updateVehicleExpenseSummary() {
            const mileageDeduction = mileageTrips.reduce((s, t) => s + (t.deduction || 0), 0);
            const totalMiles = mileageTrips.reduce((s, t) => s + (t.miles || 0), 0);
            const tripCount = mileageTrips.length;

            // Find or create the auto-managed "Vehicle Expenses" recurring entry
            const VEHICLE_EXPENSE_ID = 'auto_vehicle_expense';
            let existing = expenses.find(e => e.id === VEHICLE_EXPENSE_ID);

            if (tripCount === 0) {
                // No trips â€” remove the auto entry if it exists
                if (existing) {
                    expenses = expenses.filter(e => e.id !== VEHICLE_EXPENSE_ID);
                }
                return;
            }

            const today = new Date();
            const dateStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

            if (existing) {
                // Update in place
                existing.amount = mileageDeduction;
                existing.date = dateStr;
                existing.description = 'Vehicle Expenses â€” ' + tripCount + ' trips, ' + totalMiles.toFixed(1) + ' mi';
                existing.notes = 'Auto-updated from Mileage Log Â· ' + totalMiles.toFixed(1) + ' miles Ã— $' + IRS_MILEAGE_RATE.toFixed(2) + '/mi';
            } else {
                // Create new
                expenses.push({
                    id: VEHICLE_EXPENSE_ID,
                    date: dateStr,
                    description: 'Vehicle Expenses â€” ' + tripCount + ' trips, ' + totalMiles.toFixed(1) + ' mi',
                    category: 'Gas / Mileage',
                    amount: mileageDeduction,
                    recurring: 'auto',
                    notes: 'Auto-updated from Mileage Log Â· ' + totalMiles.toFixed(1) + ' miles Ã— $' + IRS_MILEAGE_RATE.toFixed(2) + '/mi'
                });
            }
        }

        function updatePlatformDropdowns() {
            const platformSelect = document.getElementById('platform');
            platformSelect.innerHTML = '<option value="">Not Listed Yet</option>';
            
            platforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform.name;
                option.textContent = platform.name;
                platformSelect.appendChild(option);
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const platformFilter = document.getElementById('platformFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const rows = document.querySelectorAll('#inventoryBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const category = row.cells[3] ? row.cells[3].textContent : '';
                const platform = row.cells[9] ? row.cells[9].textContent.trim() : '';
                const status = row.cells[10] ? row.cells[10].textContent : '';
                
                const matchesSearch = text.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;
                const matchesPlatform = !platformFilter || platform === platformFilter;
                const matchesStatus = !statusFilter || status.includes(statusFilter);
                
                row.style.display = matchesSearch && matchesCategory && matchesPlatform && matchesStatus ? '' : 'none';
            });
        }

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            window._pushTabState && _pushTabState(tabName);
        }

        // Item Modal Functions
        function openModal() {
            editingIndex = null;
            pendingPhotos = [];
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('modalTitle').textContent = 'Add New Item';
            document.getElementById('submitBtn').textContent = 'Add Item';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('barcodeBtn').style.display = 'none';
            document.getElementById('itemForm').reset();
            document.getElementById('taxReserve').value = 'Auto-calculated';
            document.getElementById('itemModal').classList.add('active');
            window._pushModalState && _pushModalState('itemModal');
            
            // Init drag-drop zone
            setTimeout(initPhotoDropZone, 50);
            
            // Add event listener for dynamic tax calculation
            setupTaxCalculation();
        }
        window.openModal = openModal;

        function setupTaxCalculation() {
            const fields = ['salePrice', 'purchasePrice', 'purchaseShipping', 'outboundShipping', 'packagingCosts'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', calculateTaxPreview);
                }
            });
            
            document.getElementById('platform').addEventListener('change', calculateTaxPreview);
            
            // Auto-fill date sold when status switches to "Sold"
            document.getElementById('status').addEventListener('change', function() {
                const dateSoldInput = document.getElementById('dateSold');
                if (this.value === 'Sold' && !dateSoldInput.value) {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    dateSoldInput.value = `${yyyy}-${mm}-${dd}`;
                } else if (this.value !== 'Sold') {
                    dateSoldInput.value = '';
                }
            });
        }

        function calculateTaxPreview() {
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const purchaseShipping = parseFloat(document.getElementById('purchaseShipping').value) || 0;
            const outboundShipping = parseFloat(document.getElementById('outboundShipping').value) || 0;
            const packagingCosts = parseFloat(document.getElementById('packagingCosts').value) || 0;
            const platformName = document.getElementById('platform').value;
            
            if (!salePrice) {
                document.getElementById('taxReserve').value = 'Auto-calculated';
                return;
            }
            
            let platformFees = 0;
            if (platformName) {
                const platform = platforms.find(p => p.name === platformName);
                if (platform) {
                    platformFees = (salePrice * (platform.feePercent / 100)) + platform.fixedFee;
                } else {
                    platformFees = salePrice * 0.1;
                }
            } else {
                platformFees = salePrice * 0.1;
            }
            
            const totalCost = purchasePrice + purchaseShipping;
            const profit = salePrice - totalCost - platformFees - outboundShipping - packagingCosts;
            
            if (profit > 0) {
                const taxReserve = profit * 0.153;
                document.getElementById('taxReserve').value = '$' + taxReserve.toFixed(2) + ' (15.3% of profit)';
            } else {
                document.getElementById('taxReserve').value = '$0.00 (no profit)';
            }
        }

        function openEditModal(index) {
            editingIndex = index;
            const item = inventory[index];
            
            document.getElementById('modalTitle').textContent = 'Edit Item';
            document.getElementById('submitBtn').textContent = 'Update Item';
            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('barcodeBtn').style.display = 'block';
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemSKU').value = item.sku || '';
            document.getElementById('itemQty').value = item.qty || 1;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemSource').value = item.source || '';
            document.getElementById('purchasePrice').value = item.purchase;
            document.getElementById('purchaseShipping').value = item.purchaseShipping || 0;
            document.getElementById('salePrice').value = item.sale || '';
            document.getElementById('outboundShipping').value = item.outboundShipping || 0;
            document.getElementById('packagingCosts').value = item.packaging || 0;
            document.getElementById('platform').value = item.platform || '';
            document.getElementById('status').value = item.status;
            
            // Populate date sold picker
            if (item.dateSold) {
                const d = item.dateSold instanceof Date ? item.dateSold : new Date(item.dateSold);
                if (!isNaN(d.getTime())) {
                    const yyyy = d.getFullYear();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    document.getElementById('dateSold').value = `${yyyy}-${mm}-${dd}`;
                } else {
                    document.getElementById('dateSold').value = '';
                }
            } else {
                document.getElementById('dateSold').value = '';
            }
            
            if (item.taxReserve) {
                document.getElementById('taxReserve').value = '$' + item.taxReserve.toFixed(2);
            } else {
                document.getElementById('taxReserve').value = 'Auto-calculated';
            }
            
            document.getElementById('itemModal').classList.add('active');
            window._pushModalState && _pushModalState('itemModal');
            setupTaxCalculation();

            // Load existing photos into pendingPhotos for preview
            pendingPhotos = item.photos ? [...item.photos] : [];
            renderPhotoPreviews();

            // Init drag-drop zone
            setTimeout(initPhotoDropZone, 50);
        }

        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
            document.getElementById('itemForm').reset();
            editingIndex = null;
        }

        function saveItem(event) {
            event.preventDefault();
            
            const salePrice = parseFloat(document.getElementById('salePrice').value) || null;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            const purchaseShipping = parseFloat(document.getElementById('purchaseShipping').value) || 0;
            const outboundShipping = parseFloat(document.getElementById('outboundShipping').value) || 0;
            const packagingCosts = parseFloat(document.getElementById('packagingCosts').value) || 0;
            const platformName = document.getElementById('platform').value;
            const status = document.getElementById('status').value;
            let sku = document.getElementById('itemSKU').value.trim();
            
            // Auto-generate SKU if empty
            if (!sku) {
                const category = document.getElementById('itemCategory').value || 'ITEM';
                const prefix = category.substring(0, 3).toUpperCase();
                const random = Math.floor(Math.random() * 9000) + 1000;
                sku = `${prefix}-${random}`;
            }
            
            let profit = null;
            let platformFees = 0;
            let taxReserve = 0;
            let totalCost = purchasePrice + purchaseShipping;
            
            if (salePrice && platformName) {
                const platform = platforms.find(p => p.name === platformName);
                if (platform) {
                    const percentFee = salePrice * (platform.feePercent / 100);
                    platformFees = percentFee + platform.fixedFee;
                } else {
                    platformFees = salePrice * 0.1;
                }
            } else if (salePrice) {
                platformFees = salePrice * 0.1;
            }
            
            if (salePrice) {
                profit = salePrice - totalCost - platformFees - outboundShipping - packagingCosts;
                
                if (profit > 0) {
                    taxReserve = profit * 0.153;
                }
            }
            
            let dateSold = null;
            const dateSoldVal = document.getElementById('dateSold').value;
            if (dateSoldVal) {
                // User explicitly picked a date
                dateSold = new Date(dateSoldVal + 'T12:00:00');
            } else if (status === 'Sold' && salePrice) {
                // No date picked but status is Sold â€” default to today
                dateSold = new Date();
            }
            
            const itemData = {
                name: document.getElementById('itemName').value,
                sku: sku,
                qty: parseInt(document.getElementById('itemQty').value) || 1,
                category: document.getElementById('itemCategory').value,
                source: document.getElementById('itemSource').value,
                purchase: purchasePrice,
                purchaseShipping: purchaseShipping,
                sale: salePrice,
                outboundShipping: outboundShipping,
                packaging: packagingCosts,
                profit: profit,
                platformFees: platformFees,
                taxReserve: taxReserve,
                platform: platformName || null,
                status: status,
                days: 0,
                dateSold: dateSold,
                photos: []
            };
            
            // Handle photos from pendingPhotos array (camera + gallery)
            if (pendingPhotos.length > 0) {
                itemData.photos = [...pendingPhotos];
            } else if (editingIndex !== null && inventory[editingIndex].photos) {
                // Editing with no new photos â€” keep existing
                itemData.photos = inventory[editingIndex].photos;
            }

            const wasEditing = editingIndex !== null; // true if we were editing an existing item

            if (editingIndex !== null) {
                inventory[editingIndex] = itemData;
            } else {
                inventory.unshift(itemData);
                editingIndex = 0;
            }

            renderInventory();
            updateStats();
            renderWeeklyAnalytics();
            renderMonthlyAnalytics();
            renderCategoriesAnalytics();
            saveToStorage();
            updateTaskLinkedItems();

            // Auto-create "List this item" task for newly added OR edited-to-Unlisted items
            const needsListingTask = !['Listed','Sold','Returned','Lost/Damaged'].includes(itemData.status);
            if (needsListingTask) {
                const alreadyHasTask = tasks.some(t =>
                    t.linkedItem === itemData.sku && t.title === 'List item for sale' && t.status !== 'completed'
                );
                if (!alreadyHasTask) {
                    tasks.push({
                        id: 't' + Date.now(),
                        title: 'List item for sale',
                        description: 'Item is in inventory but not yet listed.',
                        linkedItem: itemData.sku,
                        status: 'todo',
                        createdAt: new Date().toISOString()
                    });
                    saveToStorage();
                    renderTasks();
                    if (!wasEditing) toast('ğŸ“‹ Task created: List "' + itemData.name + '"', 'info');
                }
            }

            // Auto-complete "List item for sale" task when item is marked Listed/Sold/etc
            if (['Listed','Sold','Returned','Lost/Damaged'].includes(itemData.status)) {
                let taskCompleted = false;
                tasks.forEach(t => {
                    if (t.linkedItem === itemData.sku && t.title === 'List item for sale' && t.status !== 'completed') {
                        t.status = 'completed';
                        taskCompleted = true;
                    }
                });
                if (taskCompleted) { saveToStorage(); renderTasks(); }
            }

            toast(wasEditing ? 'Item saved!' : 'Item added!');
            pendingPhotos = [];
            closeModal();
        }

        async function deleteItem() {
            if (editingIndex !== null && await confirmAction('Delete this item?')) {
                const deletedSku = inventory[editingIndex].sku;
                inventory.splice(editingIndex, 1);
                // Remove any tasks linked to this item
                const before = tasks.length;
                tasks = tasks.filter(t => t.linkedItem !== deletedSku);
                renderInventory();
                updateStats();
                renderWeeklyAnalytics();
                renderMonthlyAnalytics();
                renderCategoriesAnalytics();
                saveToStorage();
                updateTaskLinkedItems();
                renderTasks();
                closeModal();
                toast('Item deleted');
            }
        }

        // Platform Modal Functions
        function openPlatformModal() {
            editingPlatformIndex = null;
            document.getElementById('platformModalTitle').textContent = 'Add New Platform';
            document.getElementById('platformSubmitBtn').textContent = 'Add Platform';
            document.getElementById('platformDeleteBtn').style.display = 'none';
            document.getElementById('platformForm').reset();
            document.getElementById('platformModal').classList.add('active'); window._pushModalState && _pushModalState('platformModal');
        }

        function openEditPlatformModal(index) {
            editingPlatformIndex = index;
            const platform = platforms[index];
            
            document.getElementById('platformModalTitle').textContent = 'Edit Platform';
            document.getElementById('platformSubmitBtn').textContent = 'Update Platform';
            document.getElementById('platformDeleteBtn').style.display = 'block';
            
            document.getElementById('platformName').value = platform.name;
            document.getElementById('platformFeePercent').value = platform.feePercent;
            document.getElementById('platformFixedFee').value = platform.fixedFee;
            
            document.getElementById('platformModal').classList.add('active'); window._pushModalState && _pushModalState('platformModal');
        }

        function closePlatformModal() {
            document.getElementById('platformModal').classList.remove('active');
            document.getElementById('platformForm').reset();
            editingPlatformIndex = null;
        }

        function savePlatform(event) {
            event.preventDefault();
            
            const platformData = {
                name: document.getElementById('platformName').value,
                feePercent: parseFloat(document.getElementById('platformFeePercent').value),
                fixedFee: parseFloat(document.getElementById('platformFixedFee').value),
                avgDays: 0,
                successRate: 0,
                totalSales: 0
            };
            
            if (editingPlatformIndex !== null) {
                const oldName = platforms[editingPlatformIndex].name;
                platforms[editingPlatformIndex] = {
                    ...platforms[editingPlatformIndex],
                    ...platformData
                };
                
                if (oldName !== platformData.name) {
                    inventory.forEach(item => {
                        if (item.platform === oldName) {
                            item.platform = platformData.name;
                        }
                    });
                    renderInventory();
                }
            } else {
                platforms.push(platformData);
            }
            
            renderPlatforms();
            updatePlatformDropdowns();
            saveToStorage();
            closePlatformModal();
            toast(editingPlatformIndex !== null ? 'Platform updated!' : 'Platform added!');
        }

        async function deletePlatform() {
            if (editingPlatformIndex !== null) {
                const platform = platforms[editingPlatformIndex];
                const itemsUsingPlatform = inventory.filter(item => item.platform === platform.name).length;
                
                if (itemsUsingPlatform > 0) {
                    if (!await confirmAction(`${itemsUsingPlatform} item(s) use this platform. Delete anyway?`)) {
                        return;
                    }
                    inventory.forEach(item => {
                        if (item.platform === platform.name) {
                            item.platform = null;
                        }
                    });
                    renderInventory();
                } else if (!await confirmAction('Delete this platform?')) {
                    return;
                }
                
                platforms.splice(editingPlatformIndex, 1);
                renderPlatforms();
                updatePlatformDropdowns();
                saveToStorage();
                closePlatformModal();
                toast('Platform deleted');
            }
        }

        async function exportData() {
            const useJSON = await confirmAction('Export as JSON (with photos)? Cancel for CSV.');
            if (useJSON) {
                exportJSON();
            } else {
                exportCSV();
            }
        }

        function exportCSV() {
            let csv = 'Item,SKU,Qty,Category,Source,Purchase,Sale,Profit,Platform,Status,Days,PhotoCount\n';
            inventory.forEach(item => {
                const photoCount = (item.photos && item.photos.length) || 0;
                csv += `"${(item.name||'').replace(/"/g,'""')}","${item.sku || ''}",${item.qty || 1},"${item.category || ''}","${item.source || ''}",${item.purchase || 0},${item.sale || ''},${item.profit || ''},"${item.platform || ''}","${item.status || ''}",${item.days || 0},${photoCount}\n`;
            });
            downloadFile(csv, 'inventory_export.csv', 'text/csv');
        }

        function exportJSON() {
            const data = {
                exportDate: new Date().toISOString(),
                version: 1,
                inventory: inventory,
                platforms: platforms,
                expenses: expenses,
                mileage: mileageTrips,
                tasks: tasks
            };
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'inventory_export.json', 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        let currentPhotoIndex = 0;
        let currentPhotoItem = null;

        function viewItemPhotos(index) {
            currentPhotoItem = inventory[index];
            currentPhotoIndex = 0;
            
            if (!currentPhotoItem.photos || currentPhotoItem.photos.length === 0) {
                toast('No photos for this item', 'info');
                return;
            }
            
            document.getElementById('photoModalTitle').textContent = currentPhotoItem.name;
            showPhoto(0);
            document.getElementById('photoModal').classList.add('active'); window._pushModalState && _pushModalState('photoModal');
        }

        function showPhoto(index) {
            if (!currentPhotoItem || !currentPhotoItem.photos) return;
            
            currentPhotoIndex = index;
            document.getElementById('photoViewerMain').src = currentPhotoItem.photos[index];
            
            const thumbContainer = document.getElementById('photoThumbnails');
            thumbContainer.innerHTML = '';
            currentPhotoItem.photos.forEach((photo, i) => {
                const thumb = document.createElement('img');
                thumb.src = photo;
                thumb.style.width = '80px';
                thumb.style.height = '80px';
                thumb.style.objectFit = 'cover';
                thumb.style.borderRadius = '8px';
                thumb.style.cursor = 'pointer';
                thumb.style.border = i === index ? '3px solid var(--primary)' : '2px solid rgba(255,255,255,0.2)';
                thumb.onclick = () => showPhoto(i);
                thumbContainer.appendChild(thumb);
            });
        }

        function nextPhoto() {
            if (!currentPhotoItem || !currentPhotoItem.photos) return;
            const nextIndex = (currentPhotoIndex + 1) % currentPhotoItem.photos.length;
            showPhoto(nextIndex);
        }

        function prevPhoto() {
            if (!currentPhotoItem || !currentPhotoItem.photos) return;
            const prevIndex = (currentPhotoIndex - 1 + currentPhotoItem.photos.length) % currentPhotoItem.photos.length;
            showPhoto(prevIndex);
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
            currentPhotoItem = null;
        }

        async function deleteCurrentPhoto() {
            if (!currentPhotoItem || !currentPhotoItem.photos || currentPhotoItem.photos.length === 0) return;
            
            if (!await confirmAction('Delete this photo?')) return;
            
            // Find the item in inventory
            const itemIndex = inventory.findIndex(item => item.sku === currentPhotoItem.sku);
            if (itemIndex === -1) return;
            
            // Remove the current photo
            inventory[itemIndex].photos.splice(currentPhotoIndex, 1);
            currentPhotoItem.photos.splice(currentPhotoIndex, 1);
            
            // If no photos left, close modal
            if (currentPhotoItem.photos.length === 0) {
                toast('All photos deleted');
                closePhotoModal();
                renderInventory();
                return;
            }
            
            // Adjust index if needed
            if (currentPhotoIndex >= currentPhotoItem.photos.length) {
                currentPhotoIndex = currentPhotoItem.photos.length - 1;
            }
            
            // Refresh the viewer
            showPhoto(currentPhotoIndex);
            renderInventory();
        }
        window.deleteCurrentPhoto = deleteCurrentPhoto;
        
        // Task/Kanban Functions
        function renderTasks() {
            const todoCards = document.getElementById('todoCards');
            const progressCards = document.getElementById('progressCards');
            const completedCards = document.getElementById('completedCards');
            
            todoCards.innerHTML = '';
            progressCards.innerHTML = '';
            completedCards.innerHTML = '';
            
            let todoCnt = 0, progressCnt = 0, completedCnt = 0;
            
            tasks.forEach((task, index) => {
                const card = createTaskCard(task, index);
                
                if (task.status === 'todo') {
                    todoCards.appendChild(card);
                    todoCnt++;
                } else if (task.status === 'progress') {
                    progressCards.appendChild(card);
                    progressCnt++;
                } else if (task.status === 'completed') {
                    completedCards.appendChild(card);
                    completedCnt++;
                }
            });
            
            document.getElementById('todoCount').textContent = todoCnt;
            document.getElementById('progressCount').textContent = progressCnt;
            document.getElementById('completedCount').textContent = completedCnt;
            
            saveToStorage();
            
            // Refresh Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function createTaskCard(task, index) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.draggable = true;
            card.dataset.index = index;
            card.style.cursor = 'pointer';

            card.ondragstart = (e) => {
                e.dataTransfer.setData('text/plain', index);
                card.classList.add('task-dragging');
            };

            card.ondragend = () => {
                card.classList.remove('task-dragging');
            };

            // Click card body â†’ open linked item if exists, otherwise edit task
            card.onclick = function(e) {
                if (e.target.closest('.task-actions')) return;
                if (task.linkedItem) {
                    const itemIndex = inventory.findIndex(i => i.sku === task.linkedItem);
                    if (itemIndex !== -1) {
                        // Activate inventory tab then open item modal
                        const inventoryTab = document.querySelector('.tab[onclick*="inventory"]');
                        if (inventoryTab) inventoryTab.click();
                        setTimeout(() => openEditModal(itemIndex), 80);
                        return;
                    }
                }
                openEditTaskModal(index);
            };

            let linkedItemHTML = '';
            if (task.linkedItem) {
                const item = inventory.find(i => i.sku === task.linkedItem);
                if (item) {
                    const photoHTML = item.photos && item.photos.length > 0
                        ? `<img src="${item.photos[0]}" alt="${item.name}">`
                        : 'ğŸ“¦';
                    linkedItemHTML = `
                        <div class="task-linked-item">
                            ${photoHTML}
                            <span>${item.name}</span>
                        </div>
                    `;
                }
            }

            card.innerHTML = `
                <div class="task-card-header">
                    <div class="task-title">${task.title}</div>
                    <div class="task-actions">
                        <button class="task-btn" onclick="event.stopPropagation(); openEditTaskModal(${index})" title="Edit">âœ</button>
                        <button class="task-btn" onclick="event.stopPropagation(); deleteTaskDirect(${index})" title="Delete">Ã—</button>
                    </div>
                </div>
                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                ${linkedItemHTML}
            `;

            return card;
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function drop(e, newStatus) {
            e.preventDefault();
            const taskIndex = e.dataTransfer.getData('text/plain');
            tasks[taskIndex].status = newStatus;
            renderTasks();
            saveToStorage();
        }
        window.allowDrop = allowDrop;
        window.drop = drop;

        function updateTaskLinkedItems() {
            const select = document.getElementById('taskLinkedItem');
            const currentValue = select.value;
            select.innerHTML = '<option value="">No item linked</option>';
            
            inventory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.sku;
                option.textContent = `${item.name} (${item.sku})`;
                select.appendChild(option);
            });
            
            if (currentValue) select.value = currentValue;
        }

        function openTaskModal() {
            editingTaskIndex = null;
            document.getElementById('taskModalTitle').textContent = 'Add New Task';
            document.getElementById('taskSubmitBtn').textContent = 'Add Task';
            document.getElementById('taskDeleteBtn').style.display = 'none';
            document.getElementById('taskForm').reset();
            updateTaskLinkedItems();
            document.getElementById('taskModal').classList.add('active'); window._pushModalState && _pushModalState('taskModal');
        }
        window.openTaskModal = openTaskModal;

        function openEditTaskModal(index) {
            editingTaskIndex = index;
            const task = tasks[index];
            
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskSubmitBtn').textContent = 'Update Task';
            document.getElementById('taskDeleteBtn').style.display = 'block';
            
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskStatus').value = task.status;
            
            updateTaskLinkedItems();
            document.getElementById('taskLinkedItem').value = task.linkedItem || '';
            
            document.getElementById('taskModal').classList.add('active'); window._pushModalState && _pushModalState('taskModal');
        }
        window.openEditTaskModal = openEditTaskModal;

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            document.getElementById('taskForm').reset();
            editingTaskIndex = null;
        }
        window.closeTaskModal = closeTaskModal;

        function saveTask(event) {
            event.preventDefault();
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                linkedItem: document.getElementById('taskLinkedItem').value,
                status: document.getElementById('taskStatus').value,
                createdAt: new Date().toISOString()
            };
            
            if (editingTaskIndex !== null) {
                tasks[editingTaskIndex] = { ...tasks[editingTaskIndex], ...taskData };
            } else {
                tasks.push(taskData);
            }
            
            renderTasks();
            saveToStorage();
            closeTaskModal();
            toast(editingTaskIndex !== null ? 'Task updated!' : 'Task added!');
        }
        window.saveTask = saveTask;

        async function deleteTask() {
            if (editingTaskIndex !== null && await confirmAction('Delete this task?')) {
                tasks.splice(editingTaskIndex, 1);
                renderTasks();
                saveToStorage();
                closeTaskModal();
                toast('Task deleted');
            }
        }
        window.deleteTask = deleteTask;

        async function deleteTaskDirect(index) {
            if (await confirmAction('Delete this task?')) {
                tasks.splice(index, 1);
                renderTasks();
                saveToStorage();
                toast('Task deleted');
            }
        }
        window.deleteTaskDirect = deleteTaskDirect;
        
        let selectedItems = new Set();
        let currentView = 'grid';
        let sortColumn = null;
        let sortDirection = 'asc'; // 'asc' or 'desc'
        
        const CATEGORY_COLORS = {
            "Accessories":"#8b5cf6","Automotive":"#6366f1","Baby":"#ec4899",
            "Baby Clothing":"#f472b6","Beauty & Skincare":"#a855f7","Books":"#0ea5e9",
            "Childrens Clothing":"#14b8a6","Computers & Tech":"#3b82f6","Electronics":"#6366f1",
            "Health & Wellness":"#10b981","Home Decor":"#f59e0b","Jewelry":"#eab308",
            "Kids Collectibles":"#f97316","Kitchen & Dining":"#ef4444","Media":"#8b5cf6",
            "Mens Clothing":"#64748b","Womens Clothing":"#ec4899","Other":"#94a3b8"
        };

        function switchView(mode) {
            currentView = mode;
            document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
            document.getElementById('galleryView').style.display = mode === 'grid' ? 'grid' : 'none';
            document.getElementById('listView').style.display = mode === 'list' ? 'block' : 'none';
            if (mode === 'grid') renderGallery();
        }
        window.switchView = switchView;

        function renderGallery() {
            const container = document.getElementById('galleryView');
            container.innerHTML = '';
            
            const sortedIndices = getSortedIndices();
            
            sortedIndices.forEach((index) => {
                const item = inventory[index];
                const totalCost = (item.purchase || 0) + (item.purchaseShipping || 0);
                const isSelected = selectedItems.has(index);
                const catColor = CATEGORY_COLORS[item.category] || '#94a3b8';
                const linkedTasks = tasks.filter(t => t.linkedItem === item.sku);
                const statusClass = item.status.toLowerCase().replace(/[\/\s]/g, '-');
                
                // Days since listed
                let daysListed = null;
                if (item.status === 'Listed' && item.dateSold === null) {
                    // Approximate
                    daysListed = item.days || 0;
                }
                
                let photoHTML;
                if (item.photos && item.photos.length > 0) {
                    photoHTML = `<img src="${item.photos[0]}" alt="${item.name}">`;
                } else {
                    photoHTML = `<div class="card-photo-placeholder"><svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg><span>No photo</span></div>`;
                }
                
                const card = document.createElement('div');
                card.className = `item-card${isSelected ? ' card-selected' : ''}`;
                card.onclick = (e) => {
                    if (e.target.type === 'checkbox') return;
                    openEditModal(index);
                };
                
                const profitHTML = item.profit != null ? `
                    <div><span class="cf-label">Profit</span><span class="cf-value" style="color:${item.profit >= 0 ? 'var(--emerald-600)' : 'var(--rose-600)'}">${item.profit >= 0 ? '$' : '-$'}${Math.abs(item.profit).toFixed(2)}</span></div>
                    <div><span class="cf-label">ROI</span><span class="cf-value" style="color:${item.profit >= 0 ? 'var(--emerald-600)' : 'var(--rose-600)'}">${totalCost > 0 ? (item.profit / totalCost * 100).toFixed(0) + '%' : 'â€”'}</span></div>
                ` : '';
                
                card.innerHTML = `
                    <div class="card-photo">
                        ${photoHTML}
                        <div class="card-checkbox">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelect(${index}, this.checked); event.stopPropagation();">
                        </div>
                        <div class="card-status"><span class="status-badge status-${statusClass}" style="font-size:10px;padding:2px 8px;">${item.status}</span></div>
                        ${item.photos && item.photos.length > 1 ? `<div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.6);color:white;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;">ğŸ“· ${item.photos.length}</div>` : ''}
                        <div class="card-cat-stripe" style="background:${catColor};"></div>
                    </div>
                    <div class="card-body">
                        <div class="card-title">${item.name}</div>
                        <div class="card-meta">
                            <span class="card-sku">${item.sku}</span>
                            <span class="card-category" style="color:${catColor}">${item.category}</span>
                        </div>
                        <div style="display:flex;align-items:center;justify-content:space-between;margin:6px 0;" onclick="event.stopPropagation();">
                            <span style="font-size:11px;font-weight:600;color:var(--text-secondary,var(--slate-500));">Stock</span>
                            <div class="qty-stepper">
                                <button onclick="adjustQty(${index}, -1)">âˆ’</button>
                                <span data-qty-idx="${index}">${item.qty || 1}</span>
                                <button onclick="adjustQty(${index}, 1)">+</button>
                            </div>
                        </div>
                        <div class="card-financials">
                            <div><span class="cf-label">Cost</span><span class="cf-value">$${totalCost.toFixed(2)}</span></div>
                            <div><span class="cf-label">Sale</span><span class="cf-value">${item.sale ? '$' + item.sale.toFixed(2) : 'â€”'}</span></div>
                            ${profitHTML}
                        </div>
                        <div class="card-footer">
                            ${item.platform ? `<span class="card-platform">${item.platform}</span>` : '<span></span>'}
                            <div class="card-badges">
                                ${linkedTasks.length > 0 ? `<span class="card-badge card-badge-link">ğŸ”— ${linkedTasks.length}</span>` : ''}
                                ${daysListed && daysListed > 30 ? `<span class="card-badge card-badge-stale">â± ${daysListed}d</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function checkStaleItems() {
            const staleItems = inventory.filter(i => i.status === 'Listed' && i.days > 30);
            const alertEl = document.getElementById('staleAlert');
            if (staleItems.length > 0) {
                alertEl.style.display = 'flex';
                document.getElementById('staleAlertText').textContent = 
                    staleItems.length + ' item' + (staleItems.length > 1 ? 's' : '') + ' listed 30+ days: ' + staleItems.map(i => i.name).join(', ');
            } else {
                alertEl.style.display = 'none';
            }
        }

        // â”€â”€ Bulk Actions â”€â”€
        function toggleItemSelect(index, checked) {
            if (checked) { selectedItems.add(index); }
            else { selectedItems.delete(index); }
            updateBulkBar();
            // Highlight rows
            const rows = document.querySelectorAll('#inventoryBody tr');
            if (rows[index]) rows[index].classList.toggle('row-selected', checked);
            // Update cards if in gallery
            if (currentView === 'grid') renderGallery();
            // Sync select all
            const cb = document.getElementById('selectAllCb');
            if (cb) {
                cb.checked = selectedItems.size === inventory.length && inventory.length > 0;
                cb.indeterminate = selectedItems.size > 0 && selectedItems.size < inventory.length;
            }
        }
        window.toggleItemSelect = toggleItemSelect;

        function toggleSelectAll() {
            const cb = document.getElementById('selectAllCb');
            if (selectedItems.size === inventory.length) {
                selectedItems.clear();
                if (cb) cb.checked = false;
            } else {
                inventory.forEach((_, i) => selectedItems.add(i));
                if (cb) cb.checked = true;
            }
            if (cb) cb.indeterminate = false;
            renderInventory();
            if (currentView === 'grid') renderGallery();
            updateBulkBar();
        }
        window.toggleSelectAll = toggleSelectAll;

        function clearSelection() {
            selectedItems.clear();
            const cb = document.getElementById('selectAllCb');
            if (cb) { cb.checked = false; cb.indeterminate = false; }
            renderInventory();
            if (currentView === 'grid') renderGallery();
            updateBulkBar();
        }
        window.clearSelection = clearSelection;

        function updateBulkBar() {
            const bar = document.getElementById('bulkBar');
            const count = document.getElementById('bulkCount');
            if (selectedItems.size > 0) {
                bar.classList.add('visible');
                count.textContent = selectedItems.size;
            } else {
                bar.classList.remove('visible');
                document.getElementById('bulkDropdown').classList.remove('show');
            }
        }

        function toggleBulkDropdown() {
            document.getElementById('bulkDropdown').classList.toggle('show');
        }
        window.toggleBulkDropdown = toggleBulkDropdown;

        async function bulkChangeStatus(newStatus) {
            const count = selectedItems.size;
            if (!count || !await confirmAction(`Change ${count} item(s) to "${newStatus}"?`)) return;
            Array.from(selectedItems).forEach(index => {
                inventory[index].status = newStatus;
                if (newStatus === 'Sold' && !inventory[index].dateSold) {
                    inventory[index].dateSold = new Date();
                }
                if (newStatus === 'Sold' && inventory[index].sale) {
                    const item = inventory[index];
                    const totalCost = (item.purchase || 0) + (item.purchaseShipping || 0);
                    let pFees = 0;
                    if (item.platform) {
                        const p = platforms.find(pl => pl.name === item.platform);
                        pFees = p ? (item.sale * (p.feePercent / 100)) + p.fixedFee : item.sale * 0.1;
                    } else { pFees = item.sale * 0.1; }
                    item.platformFees = pFees;
                    item.profit = item.sale - totalCost - pFees - (item.outboundShipping || 0) - (item.packaging || 0);
                    item.taxReserve = item.profit > 0 ? item.profit * 0.153 : 0;
                }
            });
            selectedItems.clear();
            document.getElementById('bulkDropdown').classList.remove('show');
            refreshAll();
            toast(`${count} item(s) â†’ "${newStatus}"`);
        }
        window.bulkChangeStatus = bulkChangeStatus;

        async function bulkDelete() {
            const count = selectedItems.size;
            if (!count || !await confirmAction(`Delete ${count} item(s)? This cannot be undone.`)) return;
            const indices = Array.from(selectedItems).sort((a, b) => b - a);
            indices.forEach(i => inventory.splice(i, 1));
            selectedItems.clear();
            refreshAll();
            toast(`${count} item(s) deleted`);
        }
        window.bulkDelete = bulkDelete;

        function refreshAll() {
            renderInventory();
            if (currentView === 'grid') renderGallery();
            updateStats();
            renderWeeklyAnalytics();
            renderMonthlyAnalytics();
            renderCategoriesAnalytics();
            renderTasks();
            renderExpenses();
            checkStaleItems();
            updateBulkBar();
            saveToStorage();
            const cb = document.getElementById('selectAllCb');
            if (cb) { cb.checked = false; cb.indeterminate = false; }
        }

        function filterAll() {
            filterTable();
            // If in gallery mode, also filter gallery
            if (currentView === 'grid') {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;
                const platformFilter = document.getElementById('platformFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const cards = document.querySelectorAll('#galleryView .item-card');
                const sortedIndices = getSortedIndices();
                cards.forEach((card, i) => {
                    const item = inventory[sortedIndices[i]];
                    if (!item) { card.style.display = 'none'; return; }
                    const matchSearch = !searchTerm || item.name.toLowerCase().includes(searchTerm) || item.sku.toLowerCase().includes(searchTerm) || (item.source || '').toLowerCase().includes(searchTerm);
                    const matchCategory = !categoryFilter || item.category === categoryFilter;
                    const matchPlatform = !platformFilter || item.platform === platformFilter;
                    const matchStatus = !statusFilter || item.status === statusFilter;
                    card.style.display = matchSearch && matchCategory && matchPlatform && matchStatus ? '' : 'none';
                });
            }
        }
        window.filterAll = filterAll;

        // Close bulk dropdown on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.bulk-dropdown') && !e.target.closest('.bulk-btn-status')) {
                document.getElementById('bulkDropdown').classList.remove('show');
            }
        });

        // Make all functions globally accessible
        window.exportData = exportData;
        window.switchTab = switchTab;
        window.switchPeriod = switchPeriod;
        window.filterTable = filterTable;
        window.closeModal = closeModal;
        window.openEditModal = openEditModal;
        window.saveItem = saveItem;
        window.deleteItem = deleteItem;
        window.openPlatformModal = openPlatformModal;
        window.closePlatformModal = closePlatformModal;
        window.savePlatform = savePlatform;
        window.deletePlatform = deletePlatform;
        window.closeBarcodeModal = closeBarcodeModal;
        window.printLabel = printLabel;
        window.downloadLabel = downloadLabel;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AI ITEM SCANNER â€” uses Claude vision to identify items
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let aiScanImageDataUrl = null;
        let aiScanResult = null;

        function openAIScanModal() {
            if (!getGroqKey()) {
                const key = prompt('Enter your Groq API key to enable AI scanning.\n\nGet one free at console.groq.com â†’ API Keys\n\nThis is saved only on this device â€” never uploaded anywhere.');
                if (!key || !key.trim()) return;
                setGroqKey(key);
                toast('Groq API key saved to this device âœ“', 'success');
            }
            aiScanImageDataUrl = null;
            aiScanResult = null;
            document.getElementById('aiScanStep1').style.display = 'block';
            document.getElementById('aiScanStep2').style.display = 'none';
            document.getElementById('aiScanStep3').style.display = 'none';
            document.getElementById('aiScanError').style.display = 'none';
            document.getElementById('aiScanPreviewBox').style.display = 'none';
            document.getElementById('aiScanAnalyzeRow').style.display = 'none';
            document.getElementById('aiScanGalleryInput').value = '';
            document.getElementById('aiScanOverlay').style.display = 'flex'; window._pushModalState && _pushModalState('aiScanOverlay');
        }
        window.openAIScanModal = openAIScanModal;

        function closeAIScanModal() {
            document.getElementById('aiScanOverlay').style.display = 'none';
        }
        window.closeAIScanModal = closeAIScanModal;

        // aiScanOverlay is injected after this script block â€” attach listener after DOM ready
        window.addEventListener('load', function() {
            const aiOverlay = document.getElementById('aiScanOverlay');
            if (aiOverlay) aiOverlay.addEventListener('click', function(e) {
                if (e.target === this) window._closeModal ? window._closeModal('aiScanOverlay') : closeAIScanModal();
            });
        });

        // Compress image to max 800px and quality 0.7 before sending to API
        function compressImage(dataUrl, maxDim, quality) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = function() {
                    let w = img.width, h = img.height;
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                        else { w = Math.round(w * maxDim / h); h = maxDim; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }

        function aiScanPhotoSelected(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                // Compress before storing â€” faster preview and faster API
                const compressed = await compressImage(e.target.result, 800, 0.75);
                aiScanImageDataUrl = compressed;
                document.getElementById('aiScanPreviewImg').src = compressed;
                document.getElementById('aiScanPreviewBox').style.display = 'block';
                document.getElementById('aiScanAnalyzeRow').style.display = 'none'; // hidden â€” auto-runs
                // Auto-trigger scan immediately after photo selected
                runAIScan();
            };
            reader.readAsDataURL(file);
        }
        window.aiScanPhotoSelected = aiScanPhotoSelected;

        // â”€â”€ Desktop webcam capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let desktopStream = null;

        async function openDesktopCamera() {
            const overlay = document.getElementById('aiScanOverlay');
            // Build inline webcam UI
            let camBox = document.getElementById('aiDesktopCamBox');
            if (!camBox) {
                camBox = document.createElement('div');
                camBox.id = 'aiDesktopCamBox';
                camBox.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:3500;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;';
                camBox.innerHTML = `
                    <video id="aiDesktopVideo" autoplay playsinline muted style="max-width:90vw;max-height:70vh;border-radius:12px;background:#000;"></video>
                    <div style="display:flex;gap:12px;">
                        <button onclick="captureDesktopPhoto()" style="padding:14px 32px;border:none;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;font-size:16px;font-weight:700;cursor:pointer;">ğŸ“¸ Capture</button>
                        <button onclick="closeDesktopCamera()" style="padding:14px 24px;border:none;border-radius:12px;background:rgba(255,255,255,0.15);color:white;font-size:15px;cursor:pointer;">Cancel</button>
                    </div>
                `;
                document.body.appendChild(camBox);
            } else {
                camBox.style.display = 'flex';
            }

            try {
                desktopStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                document.getElementById('aiDesktopVideo').srcObject = desktopStream;
            } catch(err) {
                closeDesktopCamera();
                toast('Camera not available: ' + (err.message || err.name), 'error');
            }
        }
        window.openDesktopCamera = openDesktopCamera;

        function captureDesktopPhoto() {
            const video = document.getElementById('aiDesktopVideo');
            if (!video) return;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            closeDesktopCamera();
            // Compress and auto-scan
            compressImage(canvas.toDataURL('image/jpeg', 0.9), 800, 0.75).then(compressed => {
                aiScanImageDataUrl = compressed;
                document.getElementById('aiScanPreviewImg').src = compressed;
                document.getElementById('aiScanPreviewBox').style.display = 'block';
                document.getElementById('aiScanAnalyzeRow').style.display = 'none';
                runAIScan();
            });
        }
        window.captureDesktopPhoto = captureDesktopPhoto;

        function closeDesktopCamera() {
            if (desktopStream) {
                desktopStream.getTracks().forEach(t => t.stop());
                desktopStream = null;
            }
            const camBox = document.getElementById('aiDesktopCamBox');
            if (camBox) camBox.style.display = 'none';
        }
        window.closeDesktopCamera = closeDesktopCamera;

        async function runAIScan() {
            if (!aiScanImageDataUrl) return;

            // Show loading
            document.getElementById('aiScanStep1').style.display = 'none';
            document.getElementById('aiScanStep2').style.display = 'block';
            document.getElementById('aiScanStep3').style.display = 'none';
            document.getElementById('aiScanError').style.display = 'none';

            const VALID_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            const mediaType = aiScanImageDataUrl.split(';')[0].split(':')[1] || 'image/jpeg';
            if (!VALID_TYPES.includes(mediaType)) {
                document.getElementById('aiScanStep2').style.display = 'none';
                document.getElementById('aiScanError').style.display = 'block';
                document.getElementById('aiScanErrorMsg').textContent = 'Unsupported image type. Please use JPG, PNG, or WebP.';
                return;
            }

            const categoryList = [
                'Accessories','Automotive','Baby','Baby Clothing','Beauty & Skincare','Books',
                'Childrens Clothing','Computers & Tech','Electronics','Health & Wellness',
                'Home Decor','Jewelry','Kids Collectibles','Kitchen & Dining','Media',
                'Mens Clothing','Womens Clothing','Other'
            ].join(',');

            const prompt = `You are a reseller assistant. Look at this item image and respond with ONLY a JSON object. No explanation, no markdown, no code blocks. Just the raw JSON.

{"name":"product name","brand":"brand name or empty string","category":"one of: ${categoryList}","condition":"New or Like New or Good or Fair or Poor","estimatedPurchasePrice":0,"estimatedSalePrice":0,"notes":"brief description"}

Use null instead of 0 if you cannot estimate a price. All keys must use double quotes.`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getGroqKey()
                    },
                    body: JSON.stringify({
                        model: 'meta-llama/llama-4-scout-17b-16e-instruct',
                        max_tokens: 256,
                        temperature: 0.1,
                        response_format: { type: 'json_object' },
                        messages: [{
                            role: 'user',
                            content: [
                                { type: 'image_url', image_url: { url: aiScanImageDataUrl } },
                                { type: 'text', text: prompt }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error?.message || 'API error ' + response.status);
                }

                const data = await response.json();
                let rawText = data.choices?.[0]?.message?.content || '';

                // Strip markdown fences if present
                rawText = rawText.replace(/```json|```/gi, '').trim();

                // Extract first JSON object found in the string â€” handles extra surrounding text
                const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('No JSON found in response');

                aiScanResult = JSON.parse(jsonMatch[0]);
                showAIScanResults(aiScanResult);

            } catch (err) {
                console.error('AI scan error:', err);
                document.getElementById('aiScanStep2').style.display = 'none';
                document.getElementById('aiScanError').style.display = 'block';
                document.getElementById('aiScanErrorMsg').textContent = 'Scan failed: ' + (err.message || 'unknown error');
            }
        }
        window.runAIScan = runAIScan;

        function showAIScanResults(result) {
            document.getElementById('aiScanStep2').style.display = 'none';
            document.getElementById('aiScanStep3').style.display = 'block';

            const fields = [
                { key: 'name',                  label: 'Item Name',             type: 'text' },
                { key: 'brand',                 label: 'Brand / Source',        type: 'text' },
                { key: 'category',              label: 'Category',              type: 'text' },
                { key: 'condition',             label: 'Condition',             type: 'text' },
                { key: 'estimatedPurchasePrice',label: 'Est. Purchase Price $', type: 'number' },
                { key: 'estimatedSalePrice',    label: 'Est. Sale Price $',     type: 'number' },
                { key: 'notes',                 label: 'Notes',                 type: 'text' },
            ];

            const container = document.getElementById('aiScanResultFields');
            container.innerHTML = '';
            fields.forEach(f => {
                const val = result[f.key];
                if (val === null || val === undefined || val === '') return;
                const row = document.createElement('div');
                row.style.cssText = 'display:flex;flex-direction:column;gap:4px;';
                row.innerHTML = `
                    <label style="font-size:11px;font-weight:600;color:var(--text-tertiary,var(--slate-400));text-transform:uppercase;letter-spacing:0.04em;">${f.label}</label>
                    <input type="${f.type}" data-ai-key="${f.key}" value="${val}" class="form-input" style="font-size:13px;padding:8px 10px;">
                `;
                container.appendChild(row);
            });
        }

        function applyAIScanResults() {
            // Read back any edits the user made to the result fields
            const inputs = document.querySelectorAll('#aiScanResultFields input[data-ai-key]');
            const edited = {};
            inputs.forEach(inp => { edited[inp.dataset.aiKey] = inp.value; });

            // Fill item form
            if (edited.name) document.getElementById('itemName').value = edited.name;
            if (edited.brand) document.getElementById('itemSource').value = edited.brand;
            if (edited.estimatedPurchasePrice) document.getElementById('purchasePrice').value = parseFloat(edited.estimatedPurchasePrice).toFixed(2);
            if (edited.estimatedSalePrice) document.getElementById('salePrice').value = parseFloat(edited.estimatedSalePrice).toFixed(2);

            // Category â€” match to dropdown
            if (edited.category) {
                const sel = document.getElementById('itemCategory');
                for (let i = 0; i < sel.options.length; i++) {
                    if (sel.options[i].value.toLowerCase() === edited.category.toLowerCase()) {
                        sel.selectedIndex = i;
                        break;
                    }
                }
            }

            // Add the scanned image as a pending photo
            if (aiScanImageDataUrl) {
                pendingPhotos.push(aiScanImageDataUrl);
                renderPhotoPreviews();
            }

            closeAIScanModal();
            calculateTaxPreview();

            // Flash the form
            const form = document.getElementById('itemForm');
            form.style.transition = 'box-shadow 0.3s';
            form.style.boxShadow = '0 0 0 3px rgba(124,58,237,0.35)';
            setTimeout(() => { form.style.boxShadow = ''; }, 1500);

            toast('AI filled in ' + Object.keys(edited).length + ' fields âœ¨', 'success');
        }
        window.applyAIScanResults = applyAIScanResults;

        function aiScanRetry() {
            aiScanImageDataUrl = null;
            aiScanResult = null;
            document.getElementById('aiScanStep1').style.display = 'block';
            document.getElementById('aiScanStep2').style.display = 'none';
            document.getElementById('aiScanStep3').style.display = 'none';
            document.getElementById('aiScanError').style.display = 'none';
            document.getElementById('aiScanPreviewBox').style.display = 'none';
            document.getElementById('aiScanAnalyzeRow').style.display = 'none';
            document.getElementById('aiScanGalleryInput').value = '';
        }
        window.aiScanRetry = aiScanRetry;

        // â”€â”€ Boot: render from localStorage instantly, then check cloud â”€â”€

        // â”€â”€ Back Button Modal Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function() {
            const CLOSERS = {
                'itemModal':       () => closeModal(),
                'scanOverlay':     () => closeScanModal(),
                'aiScanOverlay':   () => closeAIScanModal(),
                'importOverlay':   () => closeImportModal(),
                'barcodeModal':    () => closeBarcodeModal(),
                'expenseModal':    () => closeExpenseModal(),
                'platformModal':   () => closePlatformModal(),
                'taskModal':       () => closeTaskModal(),
                'manualTripModal': () => closeManualTripModal(),
                'photoModal':      () => closePhotoModal(),
                'loginOverlay':    () => skipLogin(),
            };

            window._pushModalState = function(id) {
                const currentTab = history.state?.tab || 'inventory';
                history.pushState({ modal: id, prevTab: currentTab }, '');
            };

            window._pushTabState = function(tabName) {
                history.replaceState({ tab: tabName }, '');
            };

            // Wrap every close function: if history shows this modal is open, pop the state first
            window._closeModal = function(id) {
                if (history.state?.modal === id) {
                    // popstate will handle the actual close call
                    history.back();
                } else {
                    // Modal was closed by X/backdrop â€” just pop if we're on a stale modal state
                    if (history.state?.modal) history.back();
                    CLOSERS[id] && CLOSERS[id]();
                }
            };

            // On page load, set initial tab state
            history.replaceState({ tab: 'inventory' }, '');

            window.addEventListener('popstate', function(e) {
                const id = e.state?.modal;
                if (id && CLOSERS[id]) {
                    CLOSERS[id]();
                    // After closing, restore the tab that was active when modal opened
                    const prevTab = e.state?.prevTab || 'inventory';
                    history.replaceState({ tab: prevTab }, '');
                    const tabBtn = document.querySelector(`.tab[onclick*="'${prevTab}'"]`);
                    if (tabBtn && !document.getElementById(prevTab)?.classList.contains('active')) {
                        tabBtn.click();
                    }
                    return;
                }
                // Fallback: close any open modal
                for (const [mid, fn] of Object.entries(CLOSERS)) {
                    const el = document.getElementById(mid);
                    if (!el) continue;
                    if (el.classList.contains('active') || el.style.display === 'flex') {
                        fn();
                        return;
                    }
                }
            });
        })();

        // â”€â”€ Cross-tab sync: storage event â€” registered after variables exist â”€
        window.addEventListener('storage', function(e) {
            if (e.key !== 'reseller_pro_update') return;
            const fresh = loadFromStorage();
            const localPhotoMap = {};
            inventory.forEach(item => { if (item.photos?.length) localPhotoMap[item.sku] = item.photos; });
            inventory = (fresh.inventory || []).map(item => ({
                ...item,
                photos: localPhotoMap[item.sku] || item.photos || [],
                dateSold: item.dateSold ? new Date(item.dateSold) : null
            }));
            platforms = fresh.platforms || platforms;
            tasks = fresh.tasks || tasks;
            expenses = fresh.expenses || expenses;
            mileageTrips = fresh.mileage || mileageTrips;
            renderInventory();
            if (currentView === 'grid') renderGallery();
            updateStats();
            renderTasks();
            updateTaskLinkedItems();
        });
        init();
        initGalleryDropListeners();
        initListDropListeners();
        (async function boot() {
            await checkSession();
            if (sbClient) {
                sbClient.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        syncEnabled = true;
                        updateAuthUI();
                        await loadFromCloud();
                        init();
                        startRealtimeSync();
                        startPolling();
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        syncEnabled = false;
                        updateAuthUI();
                        setSyncStatus('offline', 'Local Only');
                        stopRealtimeSync();
                        stopPolling();
                    }
                });
            }
        })();

        let _realtimeChannel = null;
        function startRealtimeSync() {
            if (!sbClient || !currentUser) return;
            stopRealtimeSync();
            _realtimeChannel = sbClient
                .channel('reseller_data_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'reseller_data',
                    filter: `user_id=eq.${currentUser.id}`
                }, async (payload) => {
                    // Another device pushed an update â€” pull fresh data
                    await loadFromCloud();
                })
                .subscribe();
        }
        function stopRealtimeSync() {
            if (_realtimeChannel) {
                try { sbClient.removeChannel(_realtimeChannel); } catch(e) {}
                _realtimeChannel = null;
            }
        }

        document.getElementById('itemModal').addEventListener('click', function(e) {
            if (e.target === this) window._closeModal ? window._closeModal('itemModal') : closeModal();
        });

        document.getElementById('platformModal').addEventListener('click', function(e) {
            if (e.target === this) window._closeModal ? window._closeModal('platformModal') : closePlatformModal();
        });

        document.getElementById('barcodeModal').addEventListener('click', function(e) {
            if (e.target === this) window._closeModal ? window._closeModal('barcodeModal') : closeBarcodeModal();
        });

        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) window._closeModal ? window._closeModal('photoModal') : closePhotoModal();
        });

        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) window._closeModal ? window._closeModal('taskModal') : closeTaskModal();
        });

        document.getElementById('loginOverlay').addEventListener('click', function(e) {
            if (e.target === this) window._closeModal ? window._closeModal('loginOverlay') : skipLogin();
        });

        document.getElementById('scanBtn').addEventListener('click', function() {
            openScanModal();
        });

        document.getElementById('scanOverlay').addEventListener('click', function(e) {
            if (e.target === this) window._closeModal ? window._closeModal('scanOverlay') : closeScanModal();
        });

        document.getElementById('importBtn').addEventListener('click', function() {
            document.getElementById('csvFileInput').click();
        });

        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                if (file.name.endsWith('.json')) {
                    importJSON(file);
                } else {
                    openImportModal(file);
                }
                this.value = ''; // reset so same file can be re-imported
            }
        });

        function importJSON(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let imported = 0;

                    if (data.inventory && Array.isArray(data.inventory)) {
                        data.inventory.forEach(item => {
                            if (item.dateSold) item.dateSold = new Date(item.dateSold);
                            if (!item.photos) item.photos = [];
                            if (!item.qty) item.qty = 1;
                        });
                        const mergeMode = await confirmAction(
                            `Found ${data.inventory.length} items. Merge with existing? (Cancel = replace all)`
                        );
                        if (mergeMode) {
                            inventory.push(...data.inventory);
                        } else {
                            inventory = data.inventory;
                        }
                        imported += data.inventory.length;
                    }
                    if (data.platforms && Array.isArray(data.platforms)) {
                        platforms = data.platforms;
                    }
                    if (data.expenses && Array.isArray(data.expenses)) {
                        expenses = data.expenses;
                    }
                    if (data.mileage && Array.isArray(data.mileage)) {
                        mileageTrips = data.mileage;
                    }
                    if (data.tasks && Array.isArray(data.tasks)) {
                        tasks = data.tasks;
                    }

                    init();
                    saveToStorage();
                    toast(`${imported} items imported with photos!`);
                } catch(err) {
                    toast('Error reading JSON: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('importOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeImportModal();
        });

    </script>

    <!-- AI Item Scan Modal -->
    <div class="scan-overlay" id="aiScanOverlay" style="display:none;">
        <div class="scan-card" style="max-width:480px;">
            <div class="scan-header">
                <h3>ğŸ¤– AI Item Scanner</h3>
                <button class="close-btn" onclick="window._closeModal?window._closeModal('aiScanOverlay'):closeAIScanModal()">&times;</button>
            </div>
            <div class="scan-body">
                <!-- Step 1: capture -->
                <div id="aiScanStep1">
                    <div style="text-align:center;padding:16px 0 8px;">
                        <div style="font-size:13px;color:var(--text-secondary,var(--slate-600));margin-bottom:16px;">
                            Take or upload a photo â€” AI identifies the item and fills in the details instantly.
                        </div>
                        <div id="aiScanPreviewBox" style="display:none;margin-bottom:16px;">
                            <img id="aiScanPreviewImg" src="" style="max-width:100%;max-height:220px;border-radius:12px;object-fit:contain;border:2px solid var(--border-primary,var(--slate-200));">
                        </div>
                        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                            <!-- Desktop: opens webcam via getUserMedia. Mobile: opens native camera via capture -->
                            <button type="button" class="btn btn-primary" onclick="openDesktopCamera()" style="background:linear-gradient(135deg,#7c3aed,#4f46e5);">
                                ğŸ“· Take Photo
                            </button>
                            <label class="btn btn-secondary" style="cursor:pointer;">
                                ğŸ–¼ Choose Image
                                <input type="file" id="aiScanGalleryInput" accept="image/*" style="display:none;" onchange="aiScanPhotoSelected(this)">
                            </label>
                        </div>
                    </div>
                    <!-- Analyze row hidden â€” scan triggers automatically on photo select -->
                    <div id="aiScanAnalyzeRow" style="display:none;"></div>
                </div>
                <!-- Step 2: loading -->
                <div id="aiScanStep2" style="display:none;text-align:center;padding:32px 16px;">
                    <div style="font-size:36px;margin-bottom:12px;animation:spin 1s linear infinite;display:inline-block;">âš™ï¸</div>
                    <div style="font-weight:600;color:var(--text-primary,var(--slate-900));">Identifying itemâ€¦</div>
                    <div style="font-size:12px;color:var(--text-tertiary,var(--slate-400));margin-top:6px;">Groq AI is analyzing the image at lightning speed</div>
                </div>
                <!-- Step 3: results -->
                <div id="aiScanStep3" style="display:none;">
                    <div style="font-size:13px;font-weight:600;color:var(--text-secondary,var(--slate-600));margin-bottom:12px;">AI detected the following â€” edit anything before filling:</div>
                    <div style="display:flex;flex-direction:column;gap:10px;" id="aiScanResultFields">
                        <!-- filled dynamically -->
                    </div>
                    <div style="display:flex;gap:10px;margin-top:16px;">
                        <button class="btn btn-primary" onclick="applyAIScanResults()" style="flex:1;background:linear-gradient(135deg,#7c3aed,#4f46e5);">âœ… Fill Form</button>
                        <button class="btn btn-secondary" onclick="aiScanRetry()" style="flex:1;">ğŸ”„ Scan Again</button>
                    </div>
                </div>
                <!-- Error -->
                <div id="aiScanError" style="display:none;text-align:center;padding:16px;">
                    <div style="color:var(--rose-500);font-weight:600;font-size:13px;" id="aiScanErrorMsg"></div>
                    <button class="btn btn-secondary" onclick="aiScanRetry()" style="margin-top:12px;">Try Again</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

</body>
</html>
