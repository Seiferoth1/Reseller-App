<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Reseller Pro - Inventory Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // Prevent flash — apply saved theme before paint
        try { if (localStorage.getItem('reseller_theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark'); } catch(e) {}
    </script>
    <style>
        :root {
            --indigo-50: #eef2ff;
            --indigo-100: #e0e7ff;
            --indigo-200: #c7d2fe;
            --indigo-300: #a5b4fc;
            --indigo-400: #818cf8;
            --indigo-500: #6366f1;
            --indigo-600: #4f46e5;
            --indigo-700: #4338ca;
            --indigo-800: #3730a3;
            --indigo-900: #312e81;
            
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            
            --emerald-500: #10b981;
            --emerald-600: #059669;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --rose-500: #f43f5e;
            --rose-600: #e11d48;

            /* Semantic tokens — light mode defaults */
            --bg-body: var(--slate-50);
            --bg-surface: #ffffff;
            --bg-surface-hover: var(--slate-50);
            --bg-inset: var(--slate-100);
            --bg-input: #ffffff;
            --border-primary: var(--slate-200);
            --border-secondary: var(--slate-100);
            --text-primary: var(--slate-900);
            --text-secondary: var(--slate-600);
            --text-tertiary: var(--slate-400);
            --text-on-primary: #ffffff;
            --shadow-card: 0 1px 3px rgba(0,0,0,0.06);
        }

        /* ── Dark Mode ── */
        [data-theme="dark"] {
            --bg-body: #0c1222;
            --bg-surface: #151e30;
            --bg-surface-hover: #1a2540;
            --bg-inset: #0f1829;
            --bg-input: #1a2540;
            --border-primary: #1e2d45;
            --border-secondary: #182338;
            --text-primary: #e8edf5;
            --text-secondary: #8896ab;
            --text-tertiary: #566882;
            --text-on-primary: #ffffff;
            --shadow-card: 0 2px 8px rgba(0,0,0,0.3);

            --slate-50: #0f1829;
            --slate-100: #151e30;
            --slate-200: #1e2d45;
            --slate-300: #2a3f5f;
            --slate-400: #566882;
            --slate-500: #6b7f99;
            --slate-600: #8896ab;
            --slate-700: #a3b1c6;
            --slate-800: #c5cdd8;
            --slate-900: #e8edf5;

            --indigo-50: rgba(99,102,241,0.08);
            --indigo-100: rgba(99,102,241,0.12);
            --indigo-200: rgba(99,102,241,0.2);
            --indigo-300: #818cf8;
        }

        [data-theme="dark"] body {
            background: var(--bg-body);
            color: var(--text-primary);
        }

        [data-theme="dark"] header {
            border-color: var(--border-primary);
        }

        [data-theme="dark"] .stat-card,
        [data-theme="dark"] .table-container,
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .kanban-column {
            background: var(--bg-surface);
            border-color: var(--border-primary);
            box-shadow: var(--shadow-card);
        }

        [data-theme="dark"] .stat-card:hover {
            border-color: var(--indigo-300);
        }

        [data-theme="dark"] .stat-label {
            color: var(--text-tertiary);
        }

        [data-theme="dark"] .stat-value {
            color: var(--text-primary);
        }

        [data-theme="dark"] .tabs {
            background: var(--bg-inset);
        }

        [data-theme="dark"] .tab {
            color: var(--text-tertiary);
        }

        [data-theme="dark"] .tab:hover {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
        }

        [data-theme="dark"] .tab.active {
            background: var(--bg-surface);
            color: var(--indigo-300);
            box-shadow: var(--shadow-card);
        }

        [data-theme="dark"] th {
            color: var(--text-tertiary);
            border-color: var(--border-primary);
        }

        [data-theme="dark"] thead tr {
            border-color: var(--border-primary);
        }

        [data-theme="dark"] tbody tr {
            border-color: var(--border-secondary);
        }

        [data-theme="dark"] tbody tr:hover {
            background: var(--bg-surface-hover);
        }

        [data-theme="dark"] td {
            color: var(--text-secondary);
        }

        [data-theme="dark"] td:first-child {
            color: var(--text-primary);
        }

        [data-theme="dark"] .price {
            color: var(--text-primary);
        }

        [data-theme="dark"] .search-input,
        [data-theme="dark"] .filter-select,
        [data-theme="dark"] .form-input,
        [data-theme="dark"] textarea.form-input {
            background: var(--bg-input);
            border-color: var(--border-primary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .search-input:focus,
        [data-theme="dark"] .filter-select:focus,
        [data-theme="dark"] .form-input:focus,
        [data-theme="dark"] textarea.form-input:focus {
            background: var(--bg-surface-hover);
            border-color: var(--indigo-400);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
        }

        [data-theme="dark"] .search-input::placeholder {
            color: var(--text-tertiary);
        }

        [data-theme="dark"] .form-group label {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .modal-content {
            background: var(--bg-surface);
        }

        [data-theme="dark"] .modal-header {
            border-color: var(--border-primary);
        }

        [data-theme="dark"] .modal-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .close-btn {
            color: var(--text-tertiary);
        }

        [data-theme="dark"] .close-btn:hover {
            color: var(--text-primary);
        }

        [data-theme="dark"] .btn-secondary {
            background: var(--bg-surface);
            color: var(--text-secondary);
            border-color: var(--border-primary);
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: var(--bg-surface-hover);
            border-color: var(--slate-400);
        }

        [data-theme="dark"] .kanban-header {
            border-color: var(--border-primary) !important;
        }

        [data-theme="dark"] .task-card {
            background: var(--bg-surface);
            border-color: var(--border-primary);
        }

        [data-theme="dark"] .task-card:hover {
            border-color: var(--indigo-300);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] .task-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .task-description {
            color: var(--text-tertiary);
        }

        [data-theme="dark"] .task-count {
            background: var(--bg-surface);
            border-color: var(--border-primary);
            color: var(--text-secondary);
        }

        [data-theme="dark"] .task-linked-item {
            background: rgba(99,102,241,0.1);
            border-color: rgba(99,102,241,0.25);
            color: var(--indigo-300);
        }

        [data-theme="dark"] .status-sold {
            background: rgba(16,185,129,0.12);
            color: #34d399;
        }

        [data-theme="dark"] .status-listed {
            background: rgba(245,158,11,0.12);
            color: #fbbf24;
        }

        [data-theme="dark"] .status-returned,
        [data-theme="dark"] .status-lost-damaged {
            background: rgba(244,63,94,0.12);
            color: #fb7185;
        }

        [data-theme="dark"] .status-unlisted {
            background: rgba(148,163,184,0.12);
            color: #94a3b8;
        }

        [data-theme="dark"] .profit-positive { color: #34d399; }
        [data-theme="dark"] .profit-negative { color: #fb7185; }

        /* Dark mode for gallery cards */
        [data-theme="dark"] .item-card {
            background: var(--bg-surface);
            border-color: var(--border-primary);
        }

        [data-theme="dark"] .item-card:hover {
            border-color: var(--indigo-300);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }

        [data-theme="dark"] .item-card.card-selected {
            border-color: var(--indigo-400);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.2);
        }

        [data-theme="dark"] .card-photo {
            background: var(--bg-inset);
        }

        [data-theme="dark"] .card-title { color: var(--text-primary); }
        [data-theme="dark"] .card-sku { background: var(--bg-inset); color: var(--text-tertiary); }
        [data-theme="dark"] .card-footer { border-color: var(--border-secondary); }
        [data-theme="dark"] .card-platform { background: rgba(99,102,241,0.12); color: var(--indigo-300); }
        [data-theme="dark"] .cf-value { color: var(--text-primary) !important; }

        [data-theme="dark"] .view-toggle { background: var(--bg-inset); }
        [data-theme="dark"] .view-toggle button { color: var(--text-tertiary); }
        [data-theme="dark"] .view-toggle button.active { background: var(--bg-surface); color: var(--indigo-300); }

        [data-theme="dark"] .stale-alert {
            background: rgba(245,158,11,0.06);
            border-color: rgba(245,158,11,0.15);
        }
        [data-theme="dark"] .stale-alert h4 { color: #fbbf24; }
        [data-theme="dark"] .stale-alert p { color: #d97706; }

        [data-theme="dark"] tbody tr.row-selected {
            background: rgba(99,102,241,0.1) !important;
        }

        /* Dark mode toggle button */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-primary);
            border-radius: 10px;
            background: var(--bg-surface);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .theme-toggle:hover {
            border-color: var(--indigo-400);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }

        .theme-toggle .theme-icon {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--slate-50);
            color: var(--slate-900);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 0;
            margin-bottom: 32px;
            border-bottom: 1px solid var(--slate-200);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--slate-900);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1 .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--indigo-600), var(--indigo-500));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--indigo-600);
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-primary:hover {
            background: var(--indigo-700);
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.15);
        }

        .btn-secondary {
            background: white;
            color: var(--slate-700);
            border: 1px solid var(--slate-300);
        }

        .btn-secondary:hover {
            background: var(--slate-50);
            border-color: var(--slate-400);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--indigo-300);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--slate-600);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-change {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--emerald-600);
        }

        .stat-change.negative {
            color: var(--rose-600);
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--slate-100);
            padding: 4px;
            border-radius: 10px;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--slate-600);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            color: var(--slate-900);
            background: var(--slate-50);
        }

        .tab.active {
            background: white;
            color: var(--indigo-600);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-container {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 10px 16px;
            background: var(--slate-50);
            border: 1px solid var(--slate-300);
            border-radius: 8px;
            color: var(--slate-900);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            background: white;
            border-color: var(--indigo-500);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-input::placeholder {
            color: var(--slate-400);
        }

        .filter-select {
            padding: 10px 16px;
            background: var(--slate-50);
            border: 1px solid var(--slate-300);
            border-radius: 8px;
            color: var(--slate-900);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--indigo-500);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead tr {
            border-bottom: 1px solid var(--slate-200);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--slate-600);
            border-bottom: 1px solid var(--slate-200);
        }

        tbody tr {
            border-bottom: 1px solid var(--slate-100);
            transition: background 0.2s ease;
            cursor: pointer;
        }

        tbody tr:hover {
            background: var(--slate-50);
        }

        td {
            padding: 14px 16px;
            font-size: 14px;
            color: var(--slate-700);
        }

        td:first-child {
            font-weight: 500;
            color: var(--slate-900);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-sold {
            background: var(--emerald-50);
            color: var(--emerald-700);
        }

        .status-listed {
            background: var(--amber-50);
            color: var(--amber-700);
        }

        .status-returned, .status-lost-damaged {
            background: var(--rose-50);
            color: var(--rose-700);
        }

        .status-unlisted {
            background: var(--slate-100);
            color: var(--slate-600);
        }

        .price {
            font-weight: 600;
            color: var(--slate-900);
        }

        .profit-positive {
            color: var(--emerald-600);
            font-weight: 600;
        }

        .profit-negative {
            color: var(--rose-600);
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--slate-200);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--slate-900);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--slate-400);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--slate-600);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--slate-700);
        }

        .form-input, textarea.form-input {
            width: 100%;
            padding: 10px 14px;
            background: white;
            border: 1px solid var(--slate-300);
            border-radius: 8px;
            color: var(--slate-900);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus, textarea.form-input:focus {
            outline: none;
            border-color: var(--indigo-500);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .photo-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-remove-btn:hover {
            background: var(--danger);
        }

        .item-photo-gallery {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .item-photo-thumb {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        .item-photo-thumb:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .kanban-column {
            background: var(--slate-50);
            border: 1px solid var(--slate-200);
            border-radius: 12px;
            padding: 16px;
            min-height: 500px;
        }

        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .kanban-header h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-count {
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            border: 1px solid var(--slate-200);
        }

        .kanban-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 400px;
        }

        .task-card {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 10px;
            padding: 16px;
            cursor: grab;
            transition: all 0.2s ease;
        }

        .task-card:active {
            cursor: grabbing;
        }

        .task-card:hover {
            border-color: var(--indigo-300);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .task-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--slate-900);
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 4px;
        }

        .task-btn {
            background: none;
            border: none;
            color: var(--slate-400);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .task-btn:hover {
            color: var(--slate-700);
            background: var(--slate-100);
        }

        .task-description {
            font-size: 13px;
            color: var(--slate-600);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .task-linked-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--indigo-50);
            border: 1px solid var(--indigo-200);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 500;
            color: var(--indigo-700);
            margin-top: 8px;
        }

        .task-linked-item img {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            object-fit: cover;
        }

        .task-dragging {
            opacity: 0.4;
        }

        /* ── Gallery Grid View (Sortly-style) ── */
        .view-toggle {
            display: flex;
            background: var(--slate-100);
            border-radius: 8px;
            padding: 3px;
        }

        .view-toggle button {
            padding: 7px 12px;
            border: none;
            background: transparent;
            color: var(--slate-400);
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-toggle button.active {
            background: white;
            color: var(--indigo-600);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }

        .item-card {
            background: white;
            border: 2px solid var(--slate-200);
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .item-card:hover {
            border-color: var(--indigo-300);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .item-card.card-selected {
            border-color: var(--indigo-400);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .card-photo {
            position: relative;
            aspect-ratio: 4/3;
            background: var(--slate-50);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-photo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--slate-300);
        }

        .card-photo-placeholder span {
            font-size: 10px;
            color: var(--slate-400);
        }

        .card-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .item-card:hover .card-checkbox,
        .item-card.card-selected .card-checkbox {
            opacity: 1;
        }

        .card-checkbox input {
            width: 20px;
            height: 20px;
            accent-color: var(--indigo-600);
            cursor: pointer;
            border-radius: 4px;
        }

        .card-status {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .card-cat-stripe {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .card-body {
            padding: 12px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--slate-900);
            margin-bottom: 4px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
        }

        .card-sku {
            font-size: 10px;
            font-family: monospace;
            color: var(--slate-400);
            background: var(--slate-50);
            padding: 2px 5px;
            border-radius: 4px;
        }

        .card-category {
            font-size: 10px;
            font-weight: 600;
        }

        .card-financials {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 12px;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .card-financials .cf-label {
            color: var(--slate-400);
        }

        .card-financials .cf-value {
            font-weight: 700;
            color: var(--slate-700);
            margin-left: 4px;
        }

        .card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 8px;
            border-top: 1px solid var(--slate-100);
        }

        .card-platform {
            font-size: 10px;
            font-weight: 600;
            color: var(--indigo-600);
            background: var(--indigo-50);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .card-badges {
            display: flex;
            gap: 4px;
        }

        .card-badge {
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .card-badge-link {
            color: #7c3aed;
            background: #f5f3ff;
        }

        .card-badge-stale {
            color: var(--amber-600);
            background: rgba(245, 158, 11, 0.1);
        }

        /* ── Stale Alert ── */
        .stale-alert {
            background: rgba(245, 158, 11, 0.08);
            border: 1px solid rgba(245, 158, 11, 0.25);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .stale-alert-icon {
            color: var(--amber-600);
            font-size: 18px;
            line-height: 1;
        }

        .stale-alert h4 {
            font-size: 13px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 2px;
        }

        .stale-alert p {
            font-size: 12px;
            color: #a16207;
        }

        /* ── Bulk Action Bar ── */
        .bulk-bar {
            position: fixed;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--slate-800);
            color: white;
            padding: 12px 20px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 12px 40px rgba(15, 23, 42, 0.35);
            z-index: 999;
            transition: bottom 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            white-space: nowrap;
        }

        .bulk-bar.visible {
            bottom: 24px;
        }

        .bulk-count {
            background: var(--indigo-500);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
        }

        .bulk-divider {
            width: 1px;
            height: 24px;
            background: var(--slate-600);
        }

        .bulk-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 7px 14px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .bulk-btn-status {
            background: rgba(255,255,255,0.12);
            color: white;
        }

        .bulk-btn-status:hover { background: rgba(255,255,255,0.2); }

        .bulk-btn-delete {
            background: rgba(244,63,94,0.15);
            color: #fb7185;
        }

        .bulk-btn-delete:hover { background: rgba(244,63,94,0.3); }

        .bulk-btn-clear {
            background: transparent;
            color: var(--slate-400);
            padding: 6px;
        }

        .bulk-btn-clear:hover { color: white; }

        .bulk-dropdown {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--slate-700);
            border: 1px solid var(--slate-600);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 8px;
            display: none;
            min-width: 160px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .bulk-dropdown.show { display: block; }

        .bulk-dropdown button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 9px 12px;
            border: none;
            background: none;
            color: white;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            border-radius: 6px;
        }

        .bulk-dropdown button:hover {
            background: rgba(255,255,255,0.1);
        }

        .bulk-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        tbody tr.row-selected {
            background: var(--indigo-50) !important;
        }

        /* ── Sortable Column Headers ── */
        th.sortable {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: color 0.15s;
        }

        th.sortable:hover {
            color: var(--indigo-400);
        }

        th.sortable .sort-arrow {
            display: inline-block;
            margin-left: 4px;
            font-size: 10px;
            opacity: 0.3;
            transition: opacity 0.15s, transform 0.2s;
        }

        th.sortable.sort-active .sort-arrow {
            opacity: 1;
            color: var(--indigo-400);
        }

        th.sortable.sort-desc .sort-arrow {
            transform: rotate(180deg);
        }

        /* ── Toast Notifications ── */
        .toast-container {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            z-index: 99999; display: flex; flex-direction: column-reverse; gap: 8px;
            align-items: center; pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            padding: 10px 20px; border-radius: 10px;
            font-size: 13px; font-weight: 600; line-height: 1.4;
            box-shadow: 0 4px 20px rgba(0,0,0,0.18);
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            max-width: 360px; text-align: center;
        }
        .toast-success { background: var(--emerald-600, #059669); color: #fff; }
        .toast-error { background: var(--rose-600, #e11d48); color: #fff; }
        .toast-info { background: var(--indigo-600, #4f46e5); color: #fff; }
        .toast-warn { background: #f59e0b; color: #1e293b; }
        @keyframes toastIn { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
        @keyframes toastOut { from { opacity:1; } to { opacity:0; transform:translateY(8px); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ── Confirm Bar ── */
        .confirm-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 99998; display: flex; align-items: center;
            justify-content: center; gap: 12px; padding: 14px 20px;
            background: var(--slate-900, #0f172a); color: #fff;
            font-size: 13px; font-weight: 500;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.25);
            animation: toastIn 0.25s ease;
        }
        .confirm-bar span { flex-shrink: 1; }
        .confirm-bar button {
            padding: 6px 16px; border-radius: 6px; border: none;
            font-size: 12px; font-weight: 700; cursor: pointer;
            white-space: nowrap;
        }
        .confirm-bar .cb-yes { background: #fff; color: var(--slate-900, #0f172a); }
        .confirm-bar .cb-no { background: rgba(255,255,255,0.15); color: #fff; }
        .confirm-bar .cb-yes:hover { background: #e2e8f0; }
        .confirm-bar .cb-no:hover { background: rgba(255,255,255,0.25); }

        /* ── Photo Drop Zone ── */
        .photo-drop-zone {
            border: 2px dashed var(--border-primary, var(--slate-300));
            border-radius: 12px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-inset, var(--slate-50));
        }
        .photo-drop-zone:hover, .photo-drop-zone.drag-over {
            border-color: var(--indigo-400);
            background: var(--indigo-50, rgba(99,102,241,0.06));
        }
        .photo-drop-zone.drag-over {
            border-style: solid;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
        }
        .drop-zone-icon { font-size: 28px; margin-bottom: 6px; }
        .drop-zone-text {
            font-size: 13px; font-weight: 600;
            color: var(--text-primary, var(--slate-800));
        }
        .drop-zone-hint {
            font-size: 11px; margin-top: 4px;
            color: var(--text-tertiary, var(--slate-400));
        }
        [data-theme="dark"] .photo-drop-zone:hover,
        [data-theme="dark"] .photo-drop-zone.drag-over {
            background: rgba(99,102,241,0.1);
        }

        /* ── Qty Stepper ── */
        .qty-stepper {
            display: inline-flex; align-items: center; gap: 0;
            background: var(--bg-inset, var(--slate-100));
            border-radius: 8px; overflow: hidden;
            border: 1px solid var(--border-primary, var(--slate-200));
        }
        .qty-stepper button {
            width: 28px; height: 28px; border: none; background: transparent;
            font-size: 15px; font-weight: 700; cursor: pointer;
            color: var(--text-secondary, var(--slate-600));
            display: flex; align-items: center; justify-content: center;
            transition: background 0.15s;
        }
        .qty-stepper button:hover { background: var(--indigo-100); color: var(--indigo-700); }
        .qty-stepper button:active { background: var(--indigo-200); }
        .qty-stepper span {
            min-width: 28px; text-align: center; font-weight: 700;
            font-size: 13px; color: var(--text-primary, var(--slate-900));
            padding: 0 2px;
        }

        /* ── Barcode Scanner Modal ── */
        .scan-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 2500;
        }
        .scan-card {
            background: var(--bg-surface, white);
            border-radius: 20px;
            width: 440px; max-width: 94vw;
            max-height: 90vh; overflow: auto;
            box-shadow: 0 32px 64px rgba(0,0,0,0.25);
        }
        .scan-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 24px; border-bottom: 1px solid var(--border-primary, var(--slate-200));
        }
        .scan-header h3 { margin: 0; font-size: 17px; font-weight: 700; color: var(--text-primary, var(--slate-900)); }
        .scan-body { padding: 20px 24px; }
        #scanReader {
            width: 100%; border-radius: 12px; overflow: hidden;
            margin-bottom: 16px; min-height: 260px;
            background: var(--bg-inset, var(--slate-100));
        }
        #scanReader video { border-radius: 12px; }
        .scan-status {
            text-align: center; padding: 12px;
            font-size: 13px; font-weight: 600;
            color: var(--text-secondary, var(--slate-600));
            border-radius: 10px;
            background: var(--bg-inset, var(--slate-100));
            margin-bottom: 12px;
        }
        .scan-status.found { background: #ecfdf5; color: #059669; }
        .scan-status.error { background: #fef2f2; color: #dc2626; }
        .scan-status.loading { background: #fffbeb; color: #d97706; }
        .scan-manual {
            display: flex; gap: 8px; margin-top: 12px;
        }
        .scan-manual input {
            flex: 1; padding: 10px 14px;
            border: 1.5px solid var(--border-primary, var(--slate-200));
            border-radius: 10px; font-size: 14px;
            background: var(--bg-input, white);
            color: var(--text-primary, var(--slate-900));
        }
        .scan-manual input:focus { outline: none; border-color: var(--indigo-500); }
        .scan-manual button {
            padding: 10px 18px; border: none; border-radius: 10px;
            background: var(--indigo-500); color: white;
            font-weight: 700; font-size: 13px; cursor: pointer;
            white-space: nowrap;
        }
        .scan-result-preview {
            margin-top: 16px; padding: 16px;
            border: 1.5px solid var(--border-primary, var(--slate-200));
            border-radius: 12px; display: none;
        }
        .scan-result-preview.visible { display: block; }
        .scan-result-preview h4 {
            margin: 0 0 8px; font-size: 14px; font-weight: 700;
            color: var(--text-primary, var(--slate-900));
        }
        .scan-result-preview .srp-row {
            display: flex; justify-content: space-between;
            font-size: 12px; padding: 4px 0;
            color: var(--text-secondary, var(--slate-600));
        }
        .scan-result-preview .srp-row span:last-child {
            font-weight: 600; color: var(--text-primary, var(--slate-900));
        }
        .scan-actions {
            display: flex; gap: 10px; margin-top: 16px;
        }
        .scan-actions button {
            flex: 1; padding: 11px; border-radius: 10px;
            font-weight: 700; font-size: 13px; cursor: pointer;
            transition: opacity 0.2s;
        }
        .scan-actions .scan-fill-btn {
            border: none;
            background: linear-gradient(135deg, var(--indigo-500), var(--indigo-700));
            color: white;
        }
        .scan-actions .scan-cancel-btn {
            border: 1.5px solid var(--border-primary, var(--slate-200));
            background: var(--bg-surface, white);
            color: var(--text-secondary, var(--slate-600));
        }

        /* ── Cloud sync indicator ── */
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.03em;
            transition: all 0.3s;
            cursor: default;
        }
        .sync-indicator .sync-dot {
            width: 8px; height: 8px; border-radius: 50%;
            transition: background 0.3s;
        }
        .sync-indicator.synced { background: var(--emerald-500); color: white; }
        .sync-indicator.synced .sync-dot { background: #a7f3d0; animation: pulse 2s infinite; }
        .sync-indicator.syncing { background: var(--amber-500); color: white; }
        .sync-indicator.syncing .sync-dot { background: #fde68a; animation: pulse 0.8s infinite; }
        .sync-indicator.offline { background: var(--slate-400); color: white; }
        .sync-indicator.offline .sync-dot { background: var(--slate-300); }
        .sync-indicator.error { background: var(--rose-500); color: white; }
        .sync-indicator.error .sync-dot { background: #fda4af; }

        /* ── Auth UI ── */
        .auth-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .auth-bar .user-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            background: var(--bg-inset, var(--slate-100));
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary, var(--slate-600));
        }
        .auth-bar .user-badge .user-dot {
            width: 7px; height: 7px; border-radius: 50%; background: var(--emerald-500);
        }
        .auth-bar button.auth-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-primary, var(--slate-200));
            background: var(--bg-surface, white);
            color: var(--text-secondary, var(--slate-600));
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .auth-bar button.auth-btn:hover {
            background: var(--bg-inset, var(--slate-100));
        }

        /* ── Login Modal ── */
        .login-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.55); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
        }
        .login-card {
            background: var(--bg-surface, white);
            border-radius: 20px;
            width: 380px;
            max-width: 92vw;
            padding: 36px 32px 28px;
            box-shadow: 0 32px 64px rgba(0,0,0,0.2);
            text-align: center;
        }
        .login-card .login-logo {
            width: 56px; height: 56px;
            background: linear-gradient(135deg, var(--indigo-500), var(--indigo-700));
            border-radius: 16px;
            display: inline-flex; align-items: center; justify-content: center;
            color: white; font-size: 24px;
            margin-bottom: 16px;
        }
        .login-card h2 {
            font-family: 'Clash Display', 'Inter', sans-serif;
            font-size: 22px; font-weight: 800;
            color: var(--text-primary, var(--slate-900));
            margin: 0 0 6px;
        }
        .login-card p {
            font-size: 13px; color: var(--text-tertiary, var(--slate-400));
            margin: 0 0 24px;
        }
        .login-card .login-input {
            width: 100%; padding: 12px 14px;
            border: 1.5px solid var(--border-primary, var(--slate-200));
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 12px;
            box-sizing: border-box;
            background: var(--bg-input, white);
            color: var(--text-primary, var(--slate-900));
            transition: border-color 0.2s;
        }
        .login-card .login-input:focus {
            outline: none; border-color: var(--indigo-500);
        }
        .login-card .login-btn {
            width: 100%; padding: 12px;
            border: none; border-radius: 10px;
            background: linear-gradient(135deg, var(--indigo-500), var(--indigo-700));
            color: white; font-size: 14px; font-weight: 700;
            cursor: pointer; transition: opacity 0.2s;
        }
        .login-card .login-btn:hover { opacity: 0.9; }
        .login-card .login-btn:disabled { opacity: 0.5; cursor: wait; }
        .login-card .login-error {
            color: var(--rose-500); font-size: 12px; font-weight: 600;
            margin-top: 10px;
        }
        .login-card .login-toggle {
            margin-top: 16px; font-size: 12px;
            color: var(--text-tertiary, var(--slate-400));
        }
        .login-card .login-toggle a {
            color: var(--indigo-500); cursor: pointer; font-weight: 600;
        }
        .login-card .login-divider {
            display:flex;align-items:center;gap:12px;margin:16px 0;
            font-size:11px;color:var(--text-tertiary, var(--slate-400));font-weight:600;
        }
        .login-card .login-divider::before,
        .login-card .login-divider::after {
            content:'';flex:1;height:1px;background:var(--border-primary, var(--slate-200));
        }
        .login-card .skip-btn {
            width:100%;padding:10px;border:1.5px solid var(--border-primary, var(--slate-200));
            border-radius:10px;background:var(--bg-surface, white);
            color:var(--text-secondary, var(--slate-600));font-size:13px;font-weight:600;
            cursor:pointer;transition:background 0.2s;
        }
        .login-card .skip-btn:hover { background:var(--bg-inset, var(--slate-100)); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ═══════════════════════════════════════════════════════════════
           RESPONSIVE — MOBILE & TABLET OPTIMIZATION
           ═══════════════════════════════════════════════════════════════ */

        /* ── Small phones (≤480px) ──────────────────────────────────── */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                padding: 16px 0;
                margin-bottom: 16px;
            }
            h1 {
                font-size: 20px;
                gap: 8px;
            }
            h1 .logo-icon {
                width: 28px; height: 28px;
            }
            .header-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                width: 100%;
            }
            .header-actions .sync-indicator {
                grid-column: 1 / -1;
                justify-content: center;
            }
            .header-actions .auth-bar {
                grid-column: 1 / -1;
                justify-content: center;
            }
            .btn {
                padding: 8px 12px;
                font-size: 12px;
                justify-content: center;
                width: 100%;
            }
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 16px;
            }
            .stat-card {
                padding: 14px;
            }
            .stat-value {
                font-size: 22px;
            }
            .stat-label {
                font-size: 10px;
            }
            .stat-change {
                font-size: 11px;
            }
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                gap: 2px;
                padding: 3px;
                margin-bottom: 16px;
            }
            .tabs::-webkit-scrollbar { display: none; }
            .tab {
                padding: 8px 12px;
                font-size: 11px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .table-container {
                padding: 10px;
                border-radius: 10px;
            }
            table { font-size: 11px; }
            th, td {
                padding: 8px 6px;
            }
            /* Hide less important columns on small screens */
            /* Cols: 1=checkbox 2=photos 3=name 4=qty 5=category 6=cost 7=sale 8=fees 9=profit 10=tax 11=platform 12=status */
            th:nth-child(2), td:nth-child(2), /* Photos */
            th:nth-child(5), td:nth-child(5), /* Category */
            th:nth-child(8), td:nth-child(8), /* Fees */
            th:nth-child(10), td:nth-child(10), /* Tax */
            th:nth-child(11), td:nth-child(11) /* Platform */
            { display: none; }

            .search-bar {
                gap: 8px;
            }
            .search-input {
                min-width: unset;
                font-size: 13px;
                padding: 8px 12px;
            }
            .form-row {
                grid-template-columns: 1fr !important;
            }
            .modal-content {
                padding: 20px 16px;
                width: 96%;
                border-radius: 14px;
            }
            .modal-title {
                font-size: 17px;
            }
            .form-input, select.form-input {
                font-size: 16px !important; /* prevents iOS zoom on focus */
                padding: 10px 12px;
            }
            .login-card {
                padding: 28px 20px 24px;
                width: 94vw;
            }
            .scan-card {
                width: 96vw;
                border-radius: 16px;
            }
            .scan-header { padding: 16px; }
            .scan-body { padding: 16px; }
            #scanReader { min-height: 220px; }
        }

        /* ── Tablets & small laptops (481px – 768px) ────────────────── */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                padding: 20px;
            }
            header {
                flex-wrap: wrap;
                gap: 12px;
                padding: 20px 0;
                margin-bottom: 20px;
            }
            h1 {
                font-size: 22px;
            }
            .header-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                width: 100%;
            }
            .btn {
                padding: 9px 14px;
                font-size: 13px;
            }
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }
            .stat-card { padding: 18px; }
            .stat-value { font-size: 26px; }
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .tabs::-webkit-scrollbar { display: none; }
            .tab {
                padding: 9px 14px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            table { font-size: 12px; }
            th, td { padding: 10px 8px; }
            /* Hide Photos + Tax + Platform on tablet */
            th:nth-child(2), td:nth-child(2),
            th:nth-child(10), td:nth-child(10),
            th:nth-child(11), td:nth-child(11)
            { display: none; }
            .form-row {
                grid-template-columns: 1fr;
            }
            .modal-content {
                padding: 24px 20px;
                width: 92%;
            }
        }

        /* ── Touch device improvements ──────────────────────────────── */
        @media (hover: none) and (pointer: coarse) {
            /* Bigger tap targets */
            .btn {
                min-height: 44px;
            }
            .tab {
                min-height: 44px;
            }
            th.sortable {
                min-height: 44px;
            }
            .close-btn {
                width: 44px; height: 44px;
                display: flex; align-items: center; justify-content: center;
            }
            .form-input, select.form-input, .search-input {
                min-height: 44px;
            }
            .auth-btn {
                min-height: 40px;
            }
        }

        /* ── Desktop enhancements (>1024px) ─────────────────────────── */
        @media (min-width: 1025px) {
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            /* Show all table columns */
            th, td { display: table-cell !important; }
        }

        /* ── Large desktop (>1400px) ────────────────────────────────── */
        @media (min-width: 1401px) {
            .container { max-width: 1600px; padding: 40px; }
            .stat-value { font-size: 36px; }
        }

        /* ── Safe area insets for notched phones ────────────────────── */
        @supports (padding: env(safe-area-inset-bottom)) {
            .container {
                padding-left: max(env(safe-area-inset-left), 12px);
                padding-right: max(env(safe-area-inset-right), 12px);
                padding-bottom: max(env(safe-area-inset-bottom), 12px);
            }
            .modal, .scan-overlay, .login-overlay {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            }
        }

        /* ── Print: hide interactive elements ───────────────────────── */
        @media print {
            .header-actions, .tabs, .search-bar, .scan-overlay, .login-overlay,
            .sync-indicator, .auth-bar { display: none !important; }
            .container { max-width: 100%; padding: 0; }
            .table-container { border: none; box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <div class="logo-icon">
                    <i data-lucide="package" style="width: 18px; height: 18px;"></i>
                </div>
                Reseller Pro
            </h1>
            <div class="header-actions">
                <div class="auth-bar" id="authBar">
                    <button class="auth-btn" id="authBtn" data-action="login">Sign In</button>
                </div>
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle dark mode">
                    <span class="theme-icon" id="themeIcon">☀️</span>
                </button>
                <button class="btn btn-primary" onclick="openModal()">
                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                    Add Item
                </button>
                <button class="btn btn-primary" id="scanBtn" style="background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600));">
                    📷 Scan
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                    Export
                </button>
                <button class="btn btn-secondary" id="importBtn">
                    <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                    Import
                </button>
                <input type="file" id="csvFileInput" accept=".csv,.tsv,.txt,.json" style="display:none;">
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Items Sold</div>
                <div class="stat-value" id="itemsSold">8</div>
                <div class="stat-change positive">↑ 12% this month</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value" id="totalRevenue">$1,438</div>
                <div class="stat-change positive">↑ $465 this month</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Net Profit</div>
                <div class="stat-value" id="netProfit">$779</div>
                <div class="stat-change positive" id="netProfitChange">↑ 54% ROI</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tax Reserve (15.3%)</div>
                <div class="stat-value" id="taxReserveTotal">$119</div>
                <div class="stat-change">Set aside for taxes</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Mileage Deduction</div>
                <div class="stat-value" id="mileageDeductionStat" style="color:var(--emerald-500);">$0</div>
                <div class="stat-change" id="mileageDeductionSub">0 trips · $0.70/mi</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'inventory')">
                <i data-lucide="package" style="width: 16px; height: 16px;"></i>
                Inventory
            </button>
            <button class="tab" onclick="switchTab(event, 'tasks')">
                <i data-lucide="check-square" style="width: 16px; height: 16px;"></i>
                Tasks
            </button>
            <button class="tab" onclick="switchTab(event, 'analytics')">
                <i data-lucide="bar-chart-3" style="width: 16px; height: 16px;"></i>
                Analytics
            </button>
            <button class="tab" onclick="switchTab(event, 'platforms')">
                <i data-lucide="shopping-cart" style="width: 16px; height: 16px;"></i>
                Platforms
            </button>
            <button class="tab" onclick="switchTab(event, 'expenses')">
                <i data-lucide="receipt" style="width: 16px; height: 16px;"></i>
                Expenses
            </button>
            <button class="tab" onclick="switchTab(event, 'mileage')">
                <i data-lucide="map-pin" style="width: 16px; height: 16px;"></i>
                Mileage
            </button>
        </div>

        <div id="inventory" class="tab-content active">
            <div id="staleAlert" class="stale-alert" style="display:none;">
                <span class="stale-alert-icon">⚠️</span>
                <div>
                    <h4>Stale Inventory Alert</h4>
                    <p id="staleAlertText"></p>
                </div>
            </div>
            <div class="table-container">
                <div class="search-bar">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search items, SKUs, sources…" onkeyup="filterAll()">
                    <select class="filter-select" id="categoryFilter" onchange="filterAll()">
                        <option value="">All Categories</option>
                    </select>
                    <select class="filter-select" id="platformFilter" onchange="filterAll()">
                        <option value="">All Platforms</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="filterAll()">
                        <option value="">All Status</option>
                        <option value="Sold">Sold</option>
                        <option value="Listed">Listed</option>
                        <option value="Unlisted">Unlisted</option>
                        <option value="Returned">Returned</option>
                        <option value="Lost/Damaged">Lost/Damaged</option>
                    </select>
                    <div class="view-toggle">
                        <button id="gridViewBtn" class="active" onclick="switchView('grid')" title="Gallery View">▦</button>
                        <button id="listViewBtn" onclick="switchView('list')" title="List View">☰</button>
                    </div>
                    <button class="btn btn-secondary" style="font-size:12px;padding:8px 14px;" onclick="toggleSelectAll()">Select All</button>
                </div>

                <!-- Gallery Grid View -->
                <div id="galleryView" class="gallery-grid" style=""></div>

                <!-- Table List View -->
                <div id="listView" style="display:none;">
                    <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th style="width:36px;"><input type="checkbox" class="bulk-checkbox" id="selectAllCb" onclick="toggleSelectAll()" style="width:16px;height:16px;accent-color:var(--indigo-600);cursor:pointer;"></th>
                            <th>Photos</th>
                            <th class="sortable" onclick="sortInventory('name')">Item <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('qty')" style="width:90px;">Qty <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('category')">Category <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('cost')">Total Cost <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('sale')">Sale Price <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('fees')">Fees <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('profit')">Net Profit <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('tax')">Tax Reserve <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('platform')">Platform <span class="sort-arrow">▲</span></th>
                            <th class="sortable" onclick="sortInventory('status')">Status <span class="sort-arrow">▲</span></th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                    </tbody>
                </table>
                </div><!-- end listView -->
            </div>
        </div>

    <!-- Bulk Action Bar -->
    <div class="bulk-bar" id="bulkBar">
        <span class="bulk-count" id="bulkCount">0</span>
        <span style="font-size:13px;font-weight:500;">selected</span>
        <div class="bulk-divider"></div>
        <div style="position:relative;">
            <button class="bulk-btn bulk-btn-status" onclick="toggleBulkDropdown()">↻ Status ▾</button>
            <div class="bulk-dropdown" id="bulkDropdown">
                <button onclick="bulkChangeStatus('Sold')"><span class="bulk-dot" style="background:var(--emerald-500);"></span>Mark Sold</button>
                <button onclick="bulkChangeStatus('Listed')"><span class="bulk-dot" style="background:var(--amber-500);"></span>Mark Listed</button>
                <button onclick="bulkChangeStatus('Unlisted')"><span class="bulk-dot" style="background:var(--slate-400);"></span>Mark Unlisted</button>
                <button onclick="bulkChangeStatus('Returned')"><span class="bulk-dot" style="background:var(--rose-500);"></span>Mark Returned</button>
                <button onclick="bulkChangeStatus('Lost/Damaged')"><span class="bulk-dot" style="background:var(--slate-400);"></span>Lost/Damaged</button>
            </div>
        </div>
        <button class="bulk-btn bulk-btn-delete" onclick="bulkDelete()">🗑 Delete</button>
        <div class="bulk-divider"></div>
        <button class="bulk-btn bulk-btn-clear" onclick="clearSelection()">✕</button>
    </div>

        <div id="tasks" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-family: 'Clash Display', sans-serif; font-size: 2em; color: var(--light); margin: 0;">Task Board</h2>
                <button class="btn btn-primary" onclick="openTaskModal()">+ Add Task</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
                <!-- To Do Column -->
                <div class="kanban-column">
                    <div class="kanban-header" style="background: var(--slate-100); border: 1px solid var(--slate-300);">
                        <h3>
                            <i data-lucide="circle" style="width: 16px; height: 16px; color: var(--slate-500);"></i>
                            To Do
                        </h3>
                        <span class="task-count" id="todoCount">0</span>
                    </div>
                    <div class="kanban-cards" id="todoCards" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)">
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="kanban-column">
                    <div class="kanban-header" style="background: var(--indigo-50); border: 1px solid var(--indigo-200);">
                        <h3>
                            <i data-lucide="loader" style="width: 16px; height: 16px; color: var(--indigo-600);"></i>
                            In Progress
                        </h3>
                        <span class="task-count" id="progressCount">0</span>
                    </div>
                    <div class="kanban-cards" id="progressCards" ondrop="drop(event, 'progress')" ondragover="allowDrop(event)">
                    </div>
                </div>

                <!-- Completed Column -->
                <div class="kanban-column">
                    <div class="kanban-header" style="background: var(--emerald-50); border: 1px solid var(--emerald-200);">
                        <h3>
                            <i data-lucide="check-circle" style="width: 16px; height: 16px; color: var(--emerald-600);"></i>
                            Completed
                        </h3>
                        <span class="task-count" id="completedCount">0</span>
                    </div>
                    <div class="kanban-cards" id="completedCards" ondrop="drop(event, 'completed')" ondragover="allowDrop(event)">
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <!-- Period Selector -->
            <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                <button class="btn btn-primary" id="weeklyBtn" onclick="switchPeriod('weekly')" style="flex: 1;">Weekly View</button>
                <button class="btn btn-secondary" id="monthlyBtn" onclick="switchPeriod('monthly')" style="flex: 1;">Monthly View</button>
                <button class="btn btn-secondary" id="categoriesBtn" onclick="switchPeriod('categories')" style="flex: 1;">Categories</button>
            </div>

            <!-- Categories Breakdown -->
            <div id="categoriesBreakdown" style="display: none;">
                <div class="table-container">
                    <h2 style="font-family: 'Clash Display', sans-serif; font-size: 1.8em; color: var(--light); margin-bottom: 25px;">📂 Category Analysis</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: rgba(255, 107, 53, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 107, 53, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">Total Categories</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--primary);" id="totalCategories">0</div>
                        </div>
                        <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(78, 205, 196, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">Best Performer</div>
                            <div style="font-size: 1.3em; font-weight: 700; color: var(--success); line-height: 1.2;" id="bestCategory">-</div>
                        </div>
                        <div style="background: rgba(253, 200, 48, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(253, 200, 48, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">Highest ROI</div>
                            <div style="font-size: 1.3em; font-weight: 700; color: var(--accent); line-height: 1.2;" id="bestROI">-</div>
                        </div>
                        <div style="background: rgba(255, 217, 61, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 217, 61, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">Avg. Sell Time</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--warning);" id="avgSellTime">0d</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Total Items</th>
                                <th>Sold</th>
                                <th>Listed</th>
                                <th>Sell-Through %</th>
                                <th>Revenue</th>
                                <th>Profit</th>
                                <th>Avg. ROI</th>
                                <th>Avg. Days</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
                    <div class="table-container">
                        <h3 style="font-family: 'Clash Display', sans-serif; font-size: 1.4em; color: var(--light); margin-bottom: 20px;">🏆 Top Performing Categories</h3>
                        <div id="topCategoriesChart" style="padding: 20px;">
                            <!-- Top categories with visual bars -->
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="font-family: 'Clash Display', sans-serif; font-size: 1.4em; color: var(--light); margin-bottom: 20px;">⚡ Quick Stats</h3>
                        <div style="line-height: 2;">
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>Most Listed Category</span>
                                <span style="font-weight: 600; color: var(--primary);" id="mostListed">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>Fastest Selling Category</span>
                                <span style="font-weight: 600; color: var(--success);" id="fastestSelling">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>Highest Avg. Price</span>
                                <span style="font-weight: 600; color: var(--accent);" id="highestPrice">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>Most Profitable Item</span>
                                <span style="font-weight: 600; color: var(--success);" id="mostProfitableItem">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                <span>Categories with Inventory</span>
                                <span style="font-weight: 600; color: var(--primary);" id="categoriesWithStock">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <div class="table-container">
                        <h3 style="font-family: 'Clash Display', sans-serif; font-size: 1.4em; color: var(--light); margin-bottom: 20px;">📊 Category Performance Over Time</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Jan</th>
                                    <th>Feb</th>
                                    <th>Mar</th>
                                    <th>Apr</th>
                                    <th>May</th>
                                    <th>Jun</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="categoryTrendsBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Weekly Breakdown -->
            <div id="weeklyBreakdown" style="display: block;">
                <div class="table-container">
                    <h2 style="font-family: 'Clash Display', sans-serif; font-size: 1.8em; color: var(--light); margin-bottom: 25px;">📅 Weekly Performance</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: rgba(255, 107, 53, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 107, 53, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">This Week</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--primary);" id="thisWeekRevenue">$0</div>
                        </div>
                        <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(78, 205, 196, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">Items Sold</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--success);" id="thisWeekItems">0</div>
                        </div>
                        <div style="background: rgba(253, 200, 48, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(253, 200, 48, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">Avg. Per Item</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--accent);" id="thisWeekAvg">$0</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Items Sold</th>
                                <th>Revenue</th>
                                <th>Profit</th>
                                <th>Avg. Profit/Item</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyBody">
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
                    <div class="table-container">
                        <h3 style="font-family: 'Clash Display', sans-serif; font-size: 1.4em; color: var(--light); margin-bottom: 20px;">🏆 Best Days of Week</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Total Revenue</th>
                                    <th>Items Sold</th>
                                </tr>
                            </thead>
                            <tbody id="bestDaysBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="table-container">
                        <h3 style="font-family: 'Clash Display', sans-serif; font-size: 1.4em; color: var(--light); margin-bottom: 20px;">⏰ Best Selling Times</h3>
                        <div id="sellingTimes" style="line-height: 2;">
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>🌅 Morning (6am-12pm)</span>
                                <span style="font-weight: 600; color: var(--success);" id="morningCount">0 sales</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>☀️ Afternoon (12pm-6pm)</span>
                                <span style="font-weight: 600; color: var(--success);" id="afternoonCount">0 sales</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>🌙 Evening (6pm-12am)</span>
                                <span style="font-weight: 600; color: var(--success);" id="eveningCount">0 sales</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                <span>🌃 Night (12am-6am)</span>
                                <span style="font-weight: 600; color: var(--success);" id="nightCount">0 sales</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Breakdown -->
            <div id="monthlyBreakdown" style="display: none;">
                <div class="table-container">
                    <h2 style="font-family: 'Clash Display', sans-serif; font-size: 1.8em; color: var(--light); margin-bottom: 25px;">📆 Monthly Performance</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: rgba(255, 107, 53, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 107, 53, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">This Month</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--primary);" id="thisMonthRevenue">$0</div>
                        </div>
                        <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(78, 205, 196, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">Items Sold</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--success);" id="thisMonthItems">0</div>
                        </div>
                        <div style="background: rgba(253, 200, 48, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(253, 200, 48, 0.3);">
                            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 5px;">Best Month</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--accent);" id="bestMonth">-</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Items Sold</th>
                                <th>Revenue</th>
                                <th>Profit</th>
                                <th>Avg. Profit/Item</th>
                                <th>Growth</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyBody">
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
                    <div class="table-container">
                        <h3 style="font-family: 'Clash Display', sans-serif; font-size: 1.4em; color: var(--light); margin-bottom: 20px;">📈 Monthly Trends</h3>
                        <div style="line-height: 2;">
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>Total Revenue (2026)</span>
                                <span style="font-weight: 600; color: var(--success);" id="yearRevenue">$0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>Total Profit (2026)</span>
                                <span style="font-weight: 600; color: var(--success);" id="yearProfit">$0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 10px;">
                                <span>Avg. Monthly Revenue</span>
                                <span style="font-weight: 600; color: var(--primary);" id="avgMonthlyRevenue">$0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                <span>Total Items Sold</span>
                                <span style="font-weight: 600; color: var(--primary);" id="yearItems">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="font-family: 'Clash Display', sans-serif; font-size: 1.4em; color: var(--light); margin-bottom: 20px;">🎯 Category Performance</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Sales</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="categoryBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="platforms" class="tab-content">
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="font-family: 'Clash Display', sans-serif; font-size: 1.8em; color: var(--light); margin: 0;">Platform Performance</h2>
                    <button class="btn btn-primary" onclick="openPlatformModal()">+ Add Platform</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Platform</th>
                            <th>Fee %</th>
                            <th>Fixed Fee</th>
                            <th>Avg. Days to Sell</th>
                            <th>Success Rate</th>
                            <th>Total Sales</th>
                        </tr>
                    </thead>
                    <tbody id="platformsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="font-family: 'Clash Display', sans-serif; font-size: 1.8em; color: var(--text-primary, var(--slate-900)); margin: 0;">💰 Business Expenses</h2>
                    <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" onclick="openExpenseModal()">+ Add Expense</button>
                    </div>
                </div>

                <!-- Expense Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 24px;">
                    <div class="stat-card" style="padding: 16px;">
                        <div class="stat-label">Total Expenses</div>
                        <div class="stat-value" id="totalExpenses" style="font-size: 1.6em;">$0</div>
                        <div class="stat-change">All time</div>
                    </div>
                    <div class="stat-card" style="padding: 16px;">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value" id="monthExpenses" style="font-size: 1.6em;">$0</div>
                        <div class="stat-change" id="monthExpenseChange"></div>
                    </div>
                    <div class="stat-card" style="padding: 16px;">
                        <div class="stat-label">Top Category</div>
                        <div class="stat-value" id="topExpenseCategory" style="font-size: 1.1em;">—</div>
                        <div class="stat-change" id="topExpenseCategoryAmt"></div>
                    </div>
                    <div class="stat-card" style="padding: 16px;">
                        <div class="stat-label">Adjusted Profit</div>
                        <div class="stat-value" id="adjustedProfit" style="font-size: 1.6em;">$0</div>
                        <div class="stat-change">Profit − Expenses</div>
                    </div>
                </div>

                <!-- Category Breakdown -->
                <div id="expenseCatBreakdown" style="margin-bottom: 24px;"></div>

                <!-- Expenses Table -->
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody">
                    </tbody>
                </table>
                <div id="expensesEmpty" style="display:none; text-align:center; padding:50px 20px; color:var(--text-tertiary, var(--slate-400));">
                    <div style="font-size:40px; margin-bottom:12px;">📋</div>
                    <div style="font-weight:600; font-size:16px; color:var(--text-secondary, var(--slate-600)); margin-bottom:4px;">No expenses tracked yet</div>
                    <div style="font-size:13px;">Add your first business expense to start tracking overhead costs.</div>
                </div>
            </div>
        </div>

        <!-- Mileage Tab -->
        <div id="mileage" class="tab-content">
            <div class="table-container">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;">
                    <h2 style="font-family:'Clash Display',sans-serif;font-size:1.8em;color:var(--text-primary, var(--slate-900));margin:0;">🚗 Mileage Tracker</h2>
                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-primary" id="startTripBtn" onclick="toggleTrip()" style="display:flex;align-items:center;gap:8px;font-size:15px;padding:10px 20px;">
                            <span id="tripBtnIcon" style="font-size:16px;">▶️</span>
                            <span id="tripBtnText">Start Trip</span>
                        </button>
                        <button class="btn btn-secondary" onclick="openManualTripModal()">+ Log Manual</button>
                    </div>
                </div>

                <!-- Live Trip Banner -->
                <div id="liveTripBanner" style="display:none;margin-bottom:20px;background:linear-gradient(135deg,#f97316,#fb923c);border-radius:16px;padding:22px 28px;color:white;position:relative;overflow:hidden;">
                    <div style="position:absolute;top:0;right:0;width:200px;height:100%;opacity:0.08;background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(255,255,255,0.5) 10px,rgba(255,255,255,0.5) 20px);"></div>
                    <!-- Live trip display -->
                    <div id="tripBannerLive" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:20px;position:relative;">
                        <div>
                            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;opacity:0.85;margin-bottom:6px;">
                                <span style="display:inline-block;width:8px;height:8px;background:#fff;border-radius:50%;margin-right:6px;animation:pulse 1.5s infinite;"></span>
                                TRIP IN PROGRESS
                            </div>
                            <div style="font-size:42px;font-weight:800;font-variant-numeric:tabular-nums;letter-spacing:-0.02em;line-height:1;" id="tripTimer">00:00:00</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:11px;font-weight:600;opacity:0.8;margin-bottom:3px;">Started</div>
                            <div style="font-size:16px;font-weight:700;" id="tripStartTime">—</div>
                            <div style="font-size:12px;opacity:0.75;margin-top:6px;" id="tripLocation">📍 Getting location…</div>
                        </div>
                        <button onclick="stopTrip()" class="btn" style="background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.4);font-weight:700;padding:12px 24px;border-radius:12px;display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer;">
                            ⏹ End Trip
                        </button>
                    </div>
                    <!-- End trip form (shown after stopping) -->
                    <div id="tripEndForm" style="display:none;position:relative;">
                        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;opacity:0.85;margin-bottom:12px;">TRIP ENDED · <span id="tripEndElapsed">—</span></div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end;">
                            <div style="flex:1;min-width:100px;">
                                <label style="font-size:11px;font-weight:600;opacity:0.8;display:block;margin-bottom:4px;">Miles</label>
                                <input type="number" id="tripEndMiles" step="0.1" min="0" placeholder="Miles driven" style="width:100%;padding:10px 12px;border-radius:8px;border:2px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.15);color:white;font-size:15px;font-weight:700;outline:none;">
                            </div>
                            <div style="flex:2;min-width:160px;">
                                <label style="font-size:11px;font-weight:600;opacity:0.8;display:block;margin-bottom:4px;">Purpose</label>
                                <input type="text" id="tripEndPurpose" placeholder="e.g. Sourcing run, Drop-off" list="tripPurposeSuggestions" style="width:100%;padding:10px 12px;border-radius:8px;border:2px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.15);color:white;font-size:14px;font-weight:600;outline:none;">
                                <datalist id="tripPurposeSuggestions">
                                    <option value="Sourcing">
                                    <option value="Sourcing run">
                                    <option value="Drop-off at FedEx">
                                    <option value="Drop-off at UPS">
                                    <option value="Drop-off at USPS">
                                    <option value="Post office + supply pickup">
                                    <option value="Estate sale">
                                    <option value="Goodwill run">
                                    <option value="Thrift store run">
                                    <option value="Garage sale">
                                    <option value="Warehouse pickup">
                                </datalist>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button onclick="saveTripFromForm()" style="padding:10px 20px;border-radius:8px;border:none;background:white;color:#f97316;font-weight:800;font-size:13px;cursor:pointer;">✓ Save</button>
                                <button onclick="cancelTripEnd()" style="padding:10px 14px;border-radius:8px;border:2px solid rgba(255,255,255,0.3);background:transparent;color:white;font-weight:600;font-size:13px;cursor:pointer;">✕</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mileage Stats -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:14px;margin-bottom:24px;">
                    <div class="stat-card" style="padding:16px;">
                        <div class="stat-label">Total Miles</div>
                        <div class="stat-value" id="totalMiles" style="font-size:1.6em;">0</div>
                        <div class="stat-change" id="totalMilesSub">This year</div>
                    </div>
                    <div class="stat-card" style="padding:16px;">
                        <div class="stat-label">IRS Deduction</div>
                        <div class="stat-value" id="totalMileageDeduction" style="font-size:1.6em;color:var(--emerald-500);">$0</div>
                        <div class="stat-change">$0.70/mile (2026)</div>
                    </div>
                    <div class="stat-card" style="padding:16px;">
                        <div class="stat-label">Total Trips</div>
                        <div class="stat-value" id="totalTrips" style="font-size:1.6em;">0</div>
                        <div class="stat-change" id="avgMilesTrip">—</div>
                    </div>
                    <div class="stat-card" style="padding:16px;">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value" id="monthMiles" style="font-size:1.6em;">0</div>
                        <div class="stat-change" id="monthMilesDed">$0 deduction</div>
                    </div>
                </div>

                <!-- Mileage Log Table -->
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Purpose</th>
                            <th>Miles</th>
                            <th>IRS Deduction</th>
                            <th>Duration</th>
                            <th style="width:40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="mileageTripLog"></tbody>
                </table>
                <div id="mileageEmpty" style="display:none;text-align:center;padding:50px 20px;color:var(--text-tertiary, var(--slate-400));">
                    <div style="font-size:40px;margin-bottom:12px;">🚗</div>
                    <div style="font-weight:600;font-size:16px;color:var(--text-secondary, var(--slate-600));margin-bottom:4px;">No trips logged yet</div>
                    <div style="font-size:13px;">Start a live trip or log one manually to begin tracking your IRS mileage deductions.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Trip Modal -->
    <div id="manualTripModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="manualTripModalTitle">Log Trip</div>
                <button class="close-btn" onclick="closeManualTripModal()">&times;</button>
            </div>
            <form id="manualTripForm" onsubmit="saveManualTrip(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-input" id="mileageQuickDate" required>
                    </div>
                    <div class="form-group">
                        <label>Miles Driven</label>
                        <input type="number" class="form-input" id="mileageQuickMiles" step="0.1" min="0" required placeholder="0.0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Purpose</label>
                    <input type="text" class="form-input" id="mileageQuickPurpose" required placeholder="e.g. Goodwill sourcing run">
                </div>
                <div id="mileageQuickCalc" style="margin:12px 0;padding:12px 16px;background:var(--bg-inset, var(--slate-100));border-radius:10px;font-size:14px;color:var(--text-secondary, var(--slate-600));display:none;">
                    IRS Deduction: <strong id="mileageQuickAmt" style="color:var(--emerald-500);font-size:16px;">$0.00</strong>
                </div>
                <div style="display:flex;gap:15px;margin-top:20px;">
                    <button type="submit" class="btn btn-primary" style="flex:1;">Log Trip</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="expenseModalTitle">Add Expense</div>
                <button class="close-btn" onclick="closeExpenseModal()">&times;</button>
            </div>
            <form id="expenseForm" onsubmit="saveExpense(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" class="form-input" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label>Amount ($)</label>
                        <input type="number" class="form-input" id="expenseAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" class="form-input" id="expenseDescription" required placeholder="e.g. Bubble mailers, Gas for sourcing trip">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-input" id="expenseCategory" required>
                            <option value="">Select…</option>
                            <option value="Packaging Supplies">📦 Packaging Supplies</option>
                            <option value="Shipping Supplies">📫 Shipping Supplies</option>
                            <option value="Gas / Mileage">⛽ Gas / Mileage</option>
                            <option value="Software / Subscriptions">💻 Software / Subscriptions</option>
                            <option value="Equipment">🔧 Equipment</option>
                            <option value="Storage">🏠 Storage</option>
                            <option value="Advertising">📣 Advertising</option>
                            <option value="Sourcing Fees">🎟️ Sourcing Fees</option>
                            <option value="Returns / Refunds">↩️ Returns / Refunds</option>
                            <option value="Other">📝 Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Recurring?</label>
                        <select class="form-input" id="expenseRecurring">
                            <option value="">One-time</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea class="form-input" id="expenseNotes" rows="2" placeholder="Any details…" style="resize:none;"></textarea>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" id="expenseSubmitBtn" style="flex: 1;">Add Expense</button>
                    <button type="button" class="btn btn-secondary" id="expenseDeleteBtn" style="display: none; background: rgba(255, 107, 107, 0.2); color: var(--rose-500); border-color: var(--rose-500);" onclick="deleteExpense()">Delete</button>
                </div>
            </form>
        </div>
    </div>
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add New Item</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="itemForm" onsubmit="saveItem(event)">
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" class="form-input" id="itemName" required>
                </div>
                <div class="form-row" style="grid-template-columns:1fr auto 1fr;">
                    <div class="form-group">
                        <label>SKU / Item Code</label>
                        <input type="text" class="form-input" id="itemSKU" placeholder="Auto-generated if empty">
                    </div>
                    <div class="form-group">
                        <label>Qty</label>
                        <input type="number" class="form-input" id="itemQty" min="1" value="1" style="width:70px;text-align:center;">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-secondary" onclick="generateSKU()" style="width: 100%;">🔄 Generate SKU</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Item Photos (Optional)</label>
                    <div id="photoDropZone" class="photo-drop-zone" onclick="document.getElementById('dropZoneFileInput').click();">
                        <div class="drop-zone-icon">📸</div>
                        <div class="drop-zone-text">Drag & drop photos here</div>
                        <div class="drop-zone-hint">or click to browse · paste from clipboard</div>
                        <input type="file" id="dropZoneFileInput" accept="image/*" multiple style="display:none;" onchange="addPhotosFromGallery(this)">
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                        <label class="btn btn-secondary" style="cursor:pointer;flex:1;min-width:100px;justify-content:center;margin:0;">
                            📷 Camera
                            <input type="file" accept="image/*" capture="environment" onchange="addPhotoFromInput(this)" style="display:none;">
                        </label>
                        <button type="button" class="btn btn-secondary" onclick="triggerPasteFromClipboard()" style="flex:1;min-width:100px;justify-content:center;margin:0;">
                            📋 Paste
                        </button>
                        <button type="button" class="btn btn-primary" onclick="openAIScanModal()" style="flex:1;min-width:120px;justify-content:center;margin:0;background:linear-gradient(135deg,#7c3aed,#4f46e5);">
                            🤖 AI Scan
                        </button>
                    </div>
                    <input type="file" class="form-input" id="itemPhotos" accept="image/*" multiple onchange="previewPhotos()" style="display:none;">
                    <div id="photoPreview" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-input" id="itemCategory">
                            <option value="">Select...</option>
                            <option value="Accessories">Accessories</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Baby">Baby</option>
                            <option value="Baby Clothing">Baby Clothing</option>
                            <option value="Beauty & Skincare">Beauty & Skincare</option>
                            <option value="Books">Books</option>
                            <option value="Childrens Clothing">Childrens Clothing</option>
                            <option value="Computers & Tech">Computers & Tech</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Health & Wellness">Health & Wellness</option>
                            <option value="Home Decor">Home Decor</option>
                            <option value="Jewelry">Jewelry</option>
                            <option value="Kids Collectibles">Kids Collectibles</option>
                            <option value="Kitchen & Dining">Kitchen & Dining</option>
                            <option value="Media">Media</option>
                            <option value="Mens Clothing">Mens Clothing</option>
                            <option value="Womens Clothing">Womens Clothing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <input type="text" class="form-input" id="itemSource">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Purchase Price</label>
                        <input type="number" class="form-input" id="purchasePrice" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Purchase Shipping/Tax</label>
                        <input type="number" class="form-input" id="purchaseShipping" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Sale Price (Optional)</label>
                        <input type="number" class="form-input" id="salePrice" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Date Sold</label>
                        <input type="date" class="form-input" id="dateSold">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Outbound Shipping (Optional)</label>
                        <input type="number" class="form-input" id="outboundShipping" step="0.01" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Packaging Costs (Optional)</label>
                        <input type="number" class="form-input" id="packagingCosts" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label>Tax Reserve (15.3%)</label>
                        <input type="text" class="form-input" id="taxReserve" readonly style="background: rgba(255, 255, 255, 0.02);" value="Auto-calculated">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Platform</label>
                        <select class="form-input" id="platform"></select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-input" id="status" required>
                            <option value="Unlisted">Unlisted</option>
                            <option value="Listed">Listed</option>
                            <option value="Sold">Sold</option>
                            <option value="Returned">Returned</option>
                            <option value="Lost/Damaged">Lost/Damaged</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" id="submitBtn" style="flex: 1;">Add Item</button>
                    <button type="button" class="btn btn-secondary" id="barcodeBtn" onclick="generateBarcode()" style="flex: 1; display: none;">📦 Print Label</button>
                    <button type="button" class="btn btn-secondary" id="deleteBtn" style="display: none; background: rgba(255, 107, 107, 0.2); color: var(--danger); border-color: var(--danger);" onclick="deleteItem()">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Platform Modal -->
    <div id="platformModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="platformModalTitle">Add New Platform</div>
                <button class="close-btn" onclick="closePlatformModal()">&times;</button>
            </div>
            <form id="platformForm" onsubmit="savePlatform(event)">
                <div class="form-group">
                    <label>Platform Name</label>
                    <input type="text" class="form-input" id="platformName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fee Percentage (%)</label>
                        <input type="number" class="form-input" id="platformFeePercent" step="0.1" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label>Fixed Fee ($)</label>
                        <input type="number" class="form-input" id="platformFixedFee" step="0.01" min="0" required>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" id="platformSubmitBtn" style="flex: 1;">Add Platform</button>
                    <button type="button" class="btn btn-secondary" id="platformDeleteBtn" style="display: none; background: rgba(255, 107, 107, 0.2); color: var(--danger); border-color: var(--danger);" onclick="deletePlatform()">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Barcode/Label Modal -->
    <div id="barcodeModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">📦 Print Labels & Barcodes</div>
                <button class="close-btn" onclick="closeBarcodeModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 25px;">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-primary" id="barcodeTypeBtn" onclick="switchBarcodeType('barcode')" style="flex: 1;">Barcode (128)</button>
                    <button class="btn btn-secondary" id="qrcodeTypeBtn" onclick="switchBarcodeType('qrcode')" style="flex: 1;">QR Code</button>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; min-height: 300px;" id="labelPreview">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 10px;" id="labelItemName">Item Name</h3>
                        <p style="color: #666; font-size: 14px;" id="labelSKU">SKU: ABC-123</p>
                    </div>
                    <div style="display: flex; justify-content: center; align-items: center; margin: 30px 0;">
                        <canvas id="barcodeCanvas"></canvas>
                        <div id="qrcodeDiv" style="display: none;"></div>
                    </div>
                    <div style="color: #333; margin-top: 20px;">
                        <p style="font-weight: 600; font-size: 18px;" id="labelPrice">$0.00</p>
                        <p style="font-size: 14px; color: #666;" id="labelCategory">Category</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button type="button" class="btn btn-primary" onclick="printLabel()">🖨️ Print Label</button>
                <button type="button" class="btn btn-secondary" onclick="downloadLabel()">💾 Download PNG</button>
            </div>
        </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div id="photoModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title" id="photoModalTitle">Item Photos</div>
                <button class="close-btn" onclick="closePhotoModal()">&times;</button>
            </div>
            
            <div style="position: relative;">
                <img id="photoViewerMain" src="" style="width: 100%; max-height: 60vh; object-fit: contain; background: #000; border-radius: 12px;">
                <button onclick="prevPhoto()" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">‹</button>
                <button onclick="nextPhoto()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;">›</button>
                <button onclick="deleteCurrentPhoto()" style="position: absolute; top: 10px; right: 10px; background: rgba(255, 107, 107, 0.9); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">🗑️ Delete Photo</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; overflow-x: auto; padding: 10px;" id="photoThumbnails"></div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title" id="taskModalTitle">Add New Task</div>
                <button class="close-btn" onclick="closeTaskModal()">&times;</button>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                <div class="form-group">
                    <label>Task Title</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea class="form-input" id="taskDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Link to Inventory Item (Optional)</label>
                    <select class="form-input" id="taskLinkedItem">
                        <option value="">No item linked</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-input" id="taskStatus" required>
                        <option value="todo">To Do</option>
                        <option value="progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" id="taskSubmitBtn" style="flex: 1;">Add Task</button>
                    <button type="button" class="btn btn-secondary" id="taskDeleteBtn" style="display: none; background: rgba(255, 107, 107, 0.2); color: var(--danger); border-color: var(--danger);" onclick="deleteTask()">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div class="scan-overlay" id="importOverlay" style="display:none;">
        <div class="scan-card" style="max-width:640px;">
            <div class="scan-header">
                <h3>📥 Import CSV</h3>
                <button class="close-btn" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="scan-body">
                <div class="scan-status" id="importStatus">Parsing your file…</div>
                <div id="importMappingArea" style="display:none;">
                    <p style="font-size:13px;color:var(--text-secondary,var(--slate-500));margin:0 0 12px;">
                        Map your CSV columns to inventory fields. Unmatched columns are auto-guessed.
                    </p>
                    <div id="importMappingRows" style="max-height:320px;overflow-y:auto;"></div>
                    <div style="margin-top:12px;padding:12px;background:var(--bg-inset,var(--slate-100));border-radius:10px;font-size:12px;color:var(--text-secondary,var(--slate-600));">
                        <strong id="importPreviewCount">0</strong> rows found &nbsp;·&nbsp;
                        <span id="importDupeWarning" style="display:none;color:var(--amber-600);">⚠️ <strong id="importDupeCount">0</strong> possible duplicates (same name)</span>
                    </div>
                </div>
                <div class="scan-actions" id="importActions" style="display:none;">
                    <button class="scan-fill-btn" onclick="confirmImport()">✅ Import Items</button>
                    <button class="scan-cancel-btn" onclick="closeImportModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="scan-overlay" id="scanOverlay" style="display:none;">
        <div class="scan-card">
            <div class="scan-header">
                <h3>📷 Scan Barcode / QR Code</h3>
                <button class="close-btn" onclick="closeScanModal()">&times;</button>
            </div>
            <div class="scan-body">
                <div id="scanReader"></div>
                <div class="scan-status" id="scanStatus">Point your camera at a barcode or QR code</div>
                <div class="scan-manual">
                    <input type="text" id="manualBarcode" placeholder="Or type barcode number…">
                    <button onclick="lookupManualBarcode()">Look Up</button>
                </div>
                <div class="scan-result-preview" id="scanResultPreview">
                    <h4 id="scanProductName">—</h4>
                    <div class="srp-row"><span>Brand</span><span id="scanBrand">—</span></div>
                    <div class="srp-row"><span>Category</span><span id="scanCategory">—</span></div>
                    <div class="srp-row"><span>UPC / EAN</span><span id="scanBarcode">—</span></div>
                    <div class="srp-row"><span>Avg. Price</span><span id="scanPrice">—</span></div>
                </div>
                <div class="scan-actions" id="scanActions" style="display:none;">
                    <button class="scan-fill-btn" onclick="fillFormFromScan()">✅ Auto-Fill Form</button>
                    <button class="scan-cancel-btn" onclick="scanAnother()">🔄 Scan Another</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-overlay" id="loginOverlay" style="display:none;">
        <div class="login-card">
            <div class="login-logo">📦</div>
            <h2 id="loginTitle">Welcome Back</h2>
            <p id="loginSubtitle">Sign in to sync your data across devices</p>
            <div id="loginError" class="login-error" style="display:none;"></div>
            <form id="loginForm" onsubmit="handleAuth(event)">
                <input class="login-input" id="authEmail" type="email" placeholder="Email address" required>
                <input class="login-input" id="authPassword" type="password" placeholder="Password" required minlength="6">
                <button type="submit" class="login-btn" id="authSubmitBtn">Sign In</button>
            </form>
            <div class="login-toggle" id="loginToggle">
                Don't have an account? <a onclick="toggleAuthMode()">Sign Up</a>
            </div>
            <div class="login-divider">or</div>
            <button class="skip-btn" onclick="skipLogin()">Continue offline (localStorage only)</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        // ── Theme Toggle (runs immediately to prevent flash) ──
        (function() {
            const saved = localStorage.getItem('reseller_theme');
            if (saved === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();

        // ── Toast & Confirm System ──
        function toast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const el = document.createElement('div');
            el.className = `toast toast-${type}`;
            el.textContent = message;
            container.appendChild(el);
            setTimeout(() => { if (el.parentNode) el.remove(); }, duration);
        }
        window.toast = toast;

        function confirmAction(message) {
            return new Promise((resolve) => {
                const existing = document.querySelector('.confirm-bar');
                if (existing) existing.remove();

                const bar = document.createElement('div');
                bar.className = 'confirm-bar';
                bar.innerHTML = `
                    <span>${message}</span>
                    <button class="cb-yes">Yes</button>
                    <button class="cb-no">Cancel</button>
                `;
                document.body.appendChild(bar);

                const cleanup = (result) => { bar.remove(); resolve(result); };
                bar.querySelector('.cb-yes').onclick = () => cleanup(true);
                bar.querySelector('.cb-no').onclick = () => cleanup(false);
            });
        }
        window.confirmAction = confirmAction;

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            
            if (next === 'dark') {
                html.setAttribute('data-theme', 'dark');
            } else {
                html.removeAttribute('data-theme');
            }
            
            localStorage.setItem('reseller_theme', next);
            updateThemeIcon();
        }
        window.toggleTheme = toggleTheme;

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = isDark ? '🌙' : '☀️';
                icon.style.transform = 'rotate(360deg)';
                setTimeout(() => { icon.style.transform = ''; }, 400);
            }
        }

        // Set initial icon after DOM loads
        document.addEventListener('DOMContentLoaded', updateThemeIcon);

        // ═══════════════════════════════════════════════════════════════
        // SUPABASE CLIENT + AUTH + CLOUD SYNC
        // ═══════════════════════════════════════════════════════════════

        // ── CONFIG — Replace with your Supabase project values ────────
        const SUPABASE_URL  = 'https://pglbroqrzchalfivhxju.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnbGJyb3FyemNoYWxmaXZoeGp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNzczNjksImV4cCI6MjA4Njg1MzM2OX0.txVH7ywpKEC1bGnufqF36bwqWLIiTdmNmx9ZYYN2n_Q';

        // ── CONFIG — Groq API key stored in localStorage (never in code) ──
        function getGroqKey() {
            return localStorage.getItem('reseller_groq_key') || '';
        }
        function setGroqKey(key) {
            localStorage.setItem('reseller_groq_key', key.trim());
        }

        let sbClient = null;
        let currentUser = null;
        let authMode = 'login'; // 'login' or 'signup'
        let syncEnabled = false;
        let syncDebounceTimer = null;

        // Initialize Supabase client — tries now AND can retry later
        function initSupabase() {
            if (sbClient) return true; // already initialized

            // Check 1: did the user replace the placeholder keys?
            const hasKeys = SUPABASE_URL !== 'https://YOUR_PROJECT.supabase.co'
                         && SUPABASE_ANON !== 'YOUR_ANON_KEY';
            if (!hasKeys) return false;

            // Check 2: did the CDN script load?
            // The CDN exposes window.supabase as { createClient, ... }
            const sb = window.supabase;
            if (!sb) return false;

            // Find createClient — could be sb.createClient or sb.default.createClient
            const createFn = sb.createClient || (sb.default && sb.default.createClient);
            if (!createFn) return false;

            try {
                sbClient = createFn(SUPABASE_URL, SUPABASE_ANON);
                return true;
            } catch(e) {
                console.warn('Supabase init failed:', e);
                return false;
            }
        }

        // Try once on page load
        initSupabase();

        // ── Sync Status Indicator ─────────────────────────────────────
        function setSyncStatus(status, label) {
            const el = document.getElementById('syncIndicator');
            const lb = document.getElementById('syncLabel');
            if (!el) return;
            el.className = 'sync-indicator ' + status;
            lb.textContent = label || status;
        }

        // ── Auth UI ───────────────────────────────────────────────────
        function updateAuthUI() {
            const bar = document.getElementById('authBar');
            if (!bar) return; // auth bar removed from UI — silently skip
            if (currentUser) {
                const email = currentUser.email || '';
                const short = email.split('@')[0];
                bar.innerHTML = `
                    <div class="user-badge"><span class="user-dot"></span>${short}</div>
                    <button class="auth-btn" data-action="logout">Sign Out</button>
                `;
            } else {
                bar.innerHTML = `<button class="auth-btn" data-action="login">Sign In</button>`;
            }
        }

        // Event delegation for auth bar (handles dynamic buttons)
        const _authBar = document.getElementById('authBar');
        if (_authBar) _authBar.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            if (btn.dataset.action === 'login') showLoginModal();
            if (btn.dataset.action === 'logout') handleLogout();
        });

        function showLoginModal() {
            authMode = 'login';
            document.getElementById('loginOverlay').style.display = 'flex'; window._pushModalState && _pushModalState('loginOverlay');
            document.getElementById('loginTitle').textContent = 'Welcome Back';
            document.getElementById('loginSubtitle').textContent = 'Sign in to sync your data across devices';
            document.getElementById('authSubmitBtn').textContent = 'Sign In';
            document.getElementById('loginToggle').innerHTML = "Don't have an account? <a onclick=\"toggleAuthMode()\">Sign Up</a>";
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
        }
        window.showLoginModal = showLoginModal;

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'signup' : 'login';
            if (authMode === 'signup') {
                document.getElementById('loginTitle').textContent = 'Create Account';
                document.getElementById('loginSubtitle').textContent = 'Sign up to sync inventory across all your devices';
                document.getElementById('authSubmitBtn').textContent = 'Create Account';
                document.getElementById('loginToggle').innerHTML = "Already have an account? <a onclick=\"toggleAuthMode()\">Sign In</a>";
            } else {
                document.getElementById('loginTitle').textContent = 'Welcome Back';
                document.getElementById('loginSubtitle').textContent = 'Sign in to sync your data across devices';
                document.getElementById('authSubmitBtn').textContent = 'Sign In';
                document.getElementById('loginToggle').innerHTML = "Don't have an account? <a onclick=\"toggleAuthMode()\">Sign Up</a>";
            }
            document.getElementById('loginError').style.display = 'none';
        }
        window.toggleAuthMode = toggleAuthMode;

        function skipLogin() {
            document.getElementById('loginOverlay').style.display = 'none';
            syncEnabled = false;
            setSyncStatus('offline', 'Local Only');
        }
        window.skipLogin = skipLogin;

        async function handleAuth(event) {
            event.preventDefault();

            // Retry init in case CDN loaded after page script ran
            initSupabase();

            if (!sbClient) {
                const hasKeys = SUPABASE_URL !== 'https://YOUR_PROJECT.supabase.co'
                             && SUPABASE_ANON !== 'YOUR_ANON_KEY';
                if (!hasKeys) {
                    showAuthError('Step 4 not done yet: open this HTML file in a text editor, search for YOUR_PROJECT, and replace both lines with your Supabase URL and anon key.');
                } else if (!window.supabase || !window.supabase.createClient) {
                    showAuthError('Supabase library failed to load. Check your internet connection and refresh the page.');
                } else {
                    showAuthError('Supabase client could not initialize. Check your URL and key are correct.');
                }
                return;
            }

            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const btn = document.getElementById('authSubmitBtn');
            btn.disabled = true;
            btn.textContent = authMode === 'login' ? 'Signing in…' : 'Creating account…';
            document.getElementById('loginError').style.display = 'none';

            let result;
            if (authMode === 'signup') {
                result = await sbClient.auth.signUp({ email, password });
            } else {
                result = await sbClient.auth.signInWithPassword({ email, password });
            }

            btn.disabled = false;
            btn.textContent = authMode === 'login' ? 'Sign In' : 'Create Account';

            if (result.error) {
                showAuthError(result.error.message);
                return;
            }

            if (authMode === 'signup' && result.data?.user && !result.data.session) {
                showAuthError('Check your email for a confirmation link!');
                document.getElementById('loginError').style.color = 'var(--emerald-500)';
                return;
            }

            currentUser = result.data.user;
            syncEnabled = true;
            document.getElementById('loginOverlay').style.display = 'none';
            updateAuthUI();

            // Pull cloud data and merge
            await loadFromCloud();
            init();
        }
        window.handleAuth = handleAuth;

        function showAuthError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.style.display = 'block';
            el.style.color = '';
        }

        async function handleLogout() {
            if (sbClient) await sbClient.auth.signOut();
            currentUser = null;
            syncEnabled = false;
            updateAuthUI();
            setSyncStatus('offline', 'Local Only');
        }
        window.handleLogout = handleLogout;

        // ── Check existing session on page load ──────────────────────
        async function checkSession() {
            initSupabase(); // retry in case CDN was slow
            if (!sbClient) {
                setSyncStatus('offline', 'Local Only');
                return;
            }
            try {
                const { data: { session } } = await sbClient.auth.getSession();
                if (session && session.user) {
                    currentUser = session.user;
                    syncEnabled = true;
                    updateAuthUI();
                    await loadFromCloud();
                    init();
                    startRealtimeSync();
                    return;
                }
            } catch(e) {
                console.warn('Session check failed:', e);
            }
            setSyncStatus('offline', 'Local Only');
        }

        // ═══════════════════════════════════════════════════════════════
        // SYNC ENGINE — pushes every change to Supabase, falls back
        // to localStorage when offline or not logged in
        // ═══════════════════════════════════════════════════════════════

        // Cloud table: reseller_data (one row per user, stores all data as JSONB)
        // Migration:
        //   CREATE TABLE reseller_data (
        //     user_id uuid PRIMARY KEY REFERENCES auth.users(id),
        //     inventory jsonb DEFAULT '[]',
        //     platforms jsonb DEFAULT '[]',
        //     tasks jsonb DEFAULT '[]',
        //     expenses jsonb DEFAULT '[]',
        //     mileage jsonb DEFAULT '[]',
        //     updated_at timestamptz DEFAULT now()
        //   );
        //   ALTER TABLE reseller_data ENABLE ROW LEVEL SECURITY;
        //   CREATE POLICY "Users manage own data" ON reseller_data
        //     FOR ALL USING (auth.uid() = user_id)
        //     WITH CHECK (auth.uid() = user_id);

        async function syncData() {
            // Always save to localStorage as the fallback (with photos)
            saveToLocalStorage();

            if (!syncEnabled || !sbClient || !currentUser) {
                setSyncStatus('offline', 'Local Only');
                return;
            }

            setSyncStatus('syncing', 'Syncing…');

            try {
                // Deep clone and strip base64 photos to keep payload small
                const cleanInventory = JSON.parse(JSON.stringify(inventory)).map(item => {
                    if (item.photos && item.photos.length > 0) {
                        item.photoCount = item.photos.length;
                        item.photos = []; // strip base64 from cloud payload
                    }
                    return item;
                });

                const payload = {
                    user_id: currentUser.id,
                    inventory: cleanInventory,
                    platforms: JSON.parse(JSON.stringify(platforms)),
                    tasks: JSON.parse(JSON.stringify(tasks)),
                    expenses: JSON.parse(JSON.stringify(expenses)),
                    mileage: JSON.parse(JSON.stringify(mileageTrips)),
                    updated_at: new Date().toISOString()
                };

                const { error } = await sbClient
                    .from('reseller_data')
                    .upsert(payload, { onConflict: 'user_id' });

                if (error) throw error;

                setSyncStatus('synced', 'Synced ✓');
            } catch(e) {
                console.error('Sync failed:', e);
                setSyncStatus('error', 'Sync failed');
                // Data is safe in localStorage — will retry on next save
            }
        }

        // Flush pending sync before user leaves the page
        window.addEventListener('beforeunload', () => {
            if (syncDebounceTimer && syncEnabled && sbClient && currentUser) {
                clearTimeout(syncDebounceTimer);
                // Use sendBeacon for reliable last-chance sync
                try {
                    const cleanInventory = JSON.parse(JSON.stringify(inventory)).map(item => {
                        if (item.photos && item.photos.length > 0) {
                            item.photoCount = item.photos.length;
                            item.photos = [];
                        }
                        return item;
                    });
                    // At minimum, save to localStorage synchronously
                    saveToLocalStorage();
                } catch(e) {}
            }
        });

        // Debounced sync — batches rapid changes into one API call
        function debouncedSync() {
            clearTimeout(syncDebounceTimer);
            // Save to localStorage immediately
            saveToLocalStorage();
            // Sync to cloud with short debounce to batch rapid changes (300ms)
            syncDebounceTimer = setTimeout(syncData, 300);
        }

        async function loadFromCloud() {
            if (!sbClient || !currentUser) return;

            setSyncStatus('syncing', 'Loading…');

            try {
                const { data, error } = await sbClient
                    .from('reseller_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows

                if (data) {
                    // Build a lookup of local photos by name+sku so we can preserve them
                    const localPhotoMap = {};
                    inventory.forEach(item => {
                        if (item.photos && item.photos.length > 0) {
                            localPhotoMap[(item.name || '') + '|' + (item.sku || '')] = item.photos;
                        }
                    });

                    // Cloud data exists — use it (cloud is source of truth)
                    if (Array.isArray(data.inventory)) {
                        data.inventory.forEach(item => {
                            if (item.dateSold) item.dateSold = new Date(item.dateSold);
                            // Restore photos from localStorage if cloud doesn't have them
                            if ((!item.photos || item.photos.length === 0)) {
                                const key = (item.name || '') + '|' + (item.sku || '');
                                if (localPhotoMap[key]) {
                                    item.photos = localPhotoMap[key];
                                } else {
                                    item.photos = [];
                                }
                            }
                        });
                        inventory = data.inventory;
                    }
                    if (Array.isArray(data.platforms)) platforms = data.platforms;
                    if (Array.isArray(data.tasks)) tasks = data.tasks;
                    if (Array.isArray(data.expenses)) expenses = data.expenses;
                    if (Array.isArray(data.mileage)) mileageTrips = data.mileage;

                    // Also update localStorage as cache
                    saveToLocalStorage();
                    setSyncStatus('synced', 'Synced ✓');
                } else {
                    // No cloud data yet — push current localStorage data up
                    await syncData();
                }
            } catch(e) {
                console.error('Cloud load failed:', e);
                setSyncStatus('error', 'Load failed');
                // Fall through to localStorage data
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // LOCAL STORAGE (fallback + cache)
        // ═══════════════════════════════════════════════════════════════

        function saveToLocalStorage() {
            localStorage.setItem('reseller_inventory', JSON.stringify(inventory));
            localStorage.setItem('reseller_platforms', JSON.stringify(platforms));
            localStorage.setItem('reseller_tasks', JSON.stringify(tasks));
            localStorage.setItem('reseller_expenses', JSON.stringify(expenses));
            localStorage.setItem('reseller_mileage', JSON.stringify(mileageTrips));
        }

        // Load data from localStorage
        function loadFromStorage() {
            const savedInventory = localStorage.getItem('reseller_inventory');
            const savedPlatforms = localStorage.getItem('reseller_platforms');
            const savedTasks = localStorage.getItem('reseller_tasks');
            const savedExpenses = localStorage.getItem('reseller_expenses');
            const savedMileage = localStorage.getItem('reseller_mileage');
            
            let result = { inventory: null, platforms: null, tasks: null, expenses: null, mileage: null };
            
            if (savedInventory) {
                try {
                    const parsed = JSON.parse(savedInventory);
                    parsed.forEach(item => {
                        if (item.dateSold) item.dateSold = new Date(item.dateSold);
                    });
                    result.inventory = parsed;
                } catch (e) {
                    console.error('Error loading inventory:', e);
                }
            }
            
            if (savedPlatforms) {
                try { result.platforms = JSON.parse(savedPlatforms); } catch(e) {}
            }

            if (savedTasks) {
                try { result.tasks = JSON.parse(savedTasks); } catch(e) {}
            }

            if (savedExpenses) {
                try { result.expenses = JSON.parse(savedExpenses); } catch(e) {}
            }

            if (savedMileage) {
                try { result.mileage = JSON.parse(savedMileage); } catch(e) {}
            }
            
            return result;
        }

        // ── REPLACEMENT: saveToStorage now syncs everything ────────────
        function saveToStorage() {
            // Immediate localStorage save
            saveToLocalStorage();
            // Broadcast to other tabs on same device instantly
            if (window._syncChannel) {
                try {
                    const cleanInv = JSON.parse(JSON.stringify(inventory)).map(item => ({...item, photos: item.photos || []}));
                    window._syncChannel.postMessage({
                        type: 'data_update',
                        inventory: cleanInv,
                        platforms: JSON.parse(JSON.stringify(platforms)),
                        tasks: JSON.parse(JSON.stringify(tasks)),
                        expenses: JSON.parse(JSON.stringify(expenses)),
                        mileage: JSON.parse(JSON.stringify(mileageTrips)),
                        ts: Date.now()
                    });
                } catch(e) {}
            }
            // Debounced cloud sync (300ms)
            debouncedSync();
        }

        // ── BroadcastChannel: instant same-device cross-tab sync ───────
        (function() {
            try {
                window._syncChannel = new BroadcastChannel('reseller_pro_sync');
                window._syncChannel.onmessage = function(e) {
                    if (e.data?.type !== 'data_update') return;
                    // Apply incoming data, preserving local photos (not sent over channel)
                    const localPhotoMap = {};
                    inventory.forEach(item => {
                        if (item.photos?.length) localPhotoMap[item.sku] = item.photos;
                    });
                    inventory = (e.data.inventory || []).map(item => ({
                        ...item,
                        photos: localPhotoMap[item.sku] || item.photos || [],
                        dateSold: item.dateSold ? new Date(item.dateSold) : null
                    }));
                    platforms = e.data.platforms || platforms;
                    tasks = e.data.tasks || tasks;
                    expenses = e.data.expenses || expenses;
                    mileageTrips = e.data.mileage || mileageTrips;
                    // Re-render everything silently
                    renderInventory();
                    if (currentView === 'grid') renderGallery();
                    updateStats();
                    renderTasks();
                    updateTaskLinkedItems();
                };
            } catch(e) {
                window._syncChannel = null;
            }
        })();

        const stored = loadFromStorage();
        
        let inventory = stored.inventory || [
            { name: "Vintage Leather Jacket", sku: "VLJ-001", category: "Accessories", source: "Poshmark", purchase: 44, purchaseShipping: 1, sale: 70, outboundShipping: 9.5, packaging: 1.5, profit: 14, platformFees: 0, taxReserve: 0, platform: "eBay", status: "Sold", days: 0, dateSold: new Date('2026-02-10'), photos: [] },
            { name: "Beauty Bundle", sku: "BB-002", category: "Beauty & Skincare", source: "eBay", purchase: 85, purchaseShipping: 1, sale: 465, outboundShipping: 10, packaging: 1.5, profit: 368.5, platformFees: 0, taxReserve: 0, platform: "Poshmark", status: "Sold", days: 0, dateSold: new Date('2026-02-02'), photos: [] },
            { name: "Electronics Lot", sku: "EL-003", category: "Electronics", source: "Goodwill", purchase: 33, purchaseShipping: 1, sale: 85, outboundShipping: 9.5, packaging: 1.5, profit: 40.5, platformFees: 0, taxReserve: 0, platform: "Mercari", status: "Sold", days: 0, dateSold: new Date('2026-01-15'), photos: [] },
            { name: "Auto Parts", sku: "AP-004", category: "Automotive", source: "Bid FTA", purchase: 43, purchaseShipping: 1, sale: 85, outboundShipping: 0, packaging: 0, profit: 42, platformFees: 0, taxReserve: 0, platform: "Etsy", status: "Sold", days: 0, dateSold: new Date('2026-01-20'), photos: [] },
            { name: "Kids Toys", sku: "KT-005", category: "Kids Collectibles", source: "Salvation Army", purchase: 23, purchaseShipping: 1, sale: null, outboundShipping: 0, packaging: 0, profit: null, platformFees: 0, taxReserve: 0, platform: "Depop", status: "Listed", days: 289, dateSold: null, photos: [] },
            { name: "Baby Clothes Bundle", sku: "BCB-006", category: "Baby Clothing", source: "Garage Sale", purchase: 33, purchaseShipping: 1, sale: 89, outboundShipping: 0, packaging: 0, profit: 56, platformFees: 0, taxReserve: 0, platform: "FB Marketplace", status: "Sold", days: 0, dateSold: new Date('2026-02-08'), photos: [] },
            { name: "Designer Dress", sku: "DD-007", category: "Womens Clothing", source: "Estate Sale", purchase: 12, purchaseShipping: 1, sale: 623, outboundShipping: 0, packaging: 0, profit: 611, platformFees: 0, taxReserve: 0, platform: "Mercari", status: "Sold", days: 0, dateSold: new Date('2026-02-12'), photos: [] },
            { name: "Laptop", sku: "LP-008", category: "Computers & Tech", source: "Walmart", purchase: 68, purchaseShipping: 1, sale: null, outboundShipping: 0, packaging: 0, profit: null, platformFees: 0, taxReserve: 0, platform: null, status: "Listed", days: 197, dateSold: null, photos: [] },
            { name: "Kitchen Set", sku: "KS-009", category: "Kitchen & Dining", source: "Amazon", purchase: 89, purchaseShipping: 1, sale: null, outboundShipping: 0, packaging: 0, profit: null, platformFees: 0, taxReserve: 0, platform: null, status: "Returned", days: 0, dateSold: null, photos: [] },
            { name: "Vinyl Records", sku: "VR-010", category: "Media", source: "Facebook", purchase: 12, purchaseShipping: 1, sale: 45, outboundShipping: 0, packaging: 0, profit: 33, platformFees: 0, taxReserve: 0, platform: "Etsy", status: "Sold", days: 0, dateSold: new Date('2026-01-25'), photos: [] },
            { name: "Men's Suit", sku: "MS-011", category: "Mens Clothing", source: "Estate Sale", purchase: 54, purchaseShipping: 1, sale: 90, outboundShipping: 0, packaging: 0, profit: 18, platformFees: 0, taxReserve: 0, platform: "Poshmark", status: "Sold", days: 0, dateSold: new Date('2026-02-05'), photos: [] },
            { name: "Gold Necklace", sku: "GN-012", category: "Jewelry", source: "Walmart", purchase: 40, purchaseShipping: 1, sale: null, outboundShipping: 0, packaging: 0, profit: null, platformFees: 0, taxReserve: 0, platform: "Whatnot", status: "Lost/Damaged", days: 0, dateSold: null, photos: [] },
            { name: "Rare Books", sku: "RB-013", category: "Books", source: "OfferUp", purchase: 3, purchaseShipping: 1, sale: 41, outboundShipping: 0, packaging: 0, profit: 38, platformFees: 0, taxReserve: 0, platform: "OfferUp", status: "Sold", days: 0, dateSold: new Date('2026-02-11'), photos: [] }
        ];

        const defaultPlatforms = [
            { name: "eBay", feePercent: 13.6, fixedFee: 0.40, avgDays: 15, successRate: 0.85, totalSales: 3 },
            { name: "Poshmark", feePercent: 20, fixedFee: 0, avgDays: 22, successRate: 0.78, totalSales: 5 },
            { name: "Mercari", feePercent: 10, fixedFee: 0, avgDays: 18, successRate: 0.82, totalSales: 4 },
            { name: "Etsy", feePercent: 9.5, fixedFee: 0.45, avgDays: 28, successRate: 0.65, totalSales: 2 },
            { name: "FB Marketplace", feePercent: 0, fixedFee: 0, avgDays: 12, successRate: 0.90, totalSales: 1 },
            { name: "Depop", feePercent: 10, fixedFee: 0, avgDays: 25, successRate: 0.60, totalSales: 0 },
            { name: "OfferUp", feePercent: 12.9, fixedFee: 0.45, avgDays: 8, successRate: 0.95, totalSales: 1 },
            { name: "Whatnot", feePercent: 8, fixedFee: 0, avgDays: 0, successRate: 0, totalSales: 0 }
        ];
        let platforms = stored.platforms || defaultPlatforms;

        let tasks = stored.tasks || [];

        const defaultExpenses = [
            { id: 'e1', date: '2026-01-05', description: 'Bubble mailers (100 pack)', category: 'Packaging Supplies', amount: 24.99, recurring: '', notes: 'Amazon' },
            { id: 'e2', date: '2026-01-10', description: 'Poshmark Pro subscription', category: 'Software / Subscriptions', amount: 9.99, recurring: 'monthly', notes: '' },
            { id: 'e3', date: '2026-01-15', description: 'Gas - estate sale run', category: 'Gas / Mileage', amount: 35.00, recurring: '', notes: '45 miles round trip' },
            { id: 'e4', date: '2026-01-22', description: 'Poly mailers (50 pack)', category: 'Shipping Supplies', amount: 12.49, recurring: '', notes: '' },
            { id: 'e5', date: '2026-02-01', description: 'Shipping scale', category: 'Equipment', amount: 29.99, recurring: '', notes: 'Digital postal scale' },
            { id: 'e6', date: '2026-02-05', description: 'Gas - Goodwill + Salvation Army', category: 'Gas / Mileage', amount: 22.00, recurring: '', notes: '' },
            { id: 'e7', date: '2026-02-08', description: 'Storage bins (4 pack)', category: 'Storage', amount: 39.96, recurring: '', notes: 'For staging area' },
            { id: 'e8', date: '2026-02-10', description: 'Poshmark Pro subscription', category: 'Software / Subscriptions', amount: 9.99, recurring: 'monthly', notes: '' },
            { id: 'e9', date: '2026-02-12', description: 'Tissue paper + thank you cards', category: 'Packaging Supplies', amount: 15.47, recurring: '', notes: '' },
            { id: 'e10', date: '2026-02-14', description: 'Bid FTA auction fee', category: 'Sourcing Fees', amount: 5.00, recurring: '', notes: '' },
        ];
        let expenses = stored.expenses || defaultExpenses;

        const IRS_MILEAGE_RATE = 0.70; // 2026 IRS standard mileage rate

        const defaultMileage = [
            { id: 'm1', date: '2026-01-15', miles: 45, purpose: 'Estate sale run — east side', deduction: 31.50 },
            { id: 'm2', date: '2026-01-22', miles: 12, purpose: 'Post office + supply pickup', deduction: 8.40 },
            { id: 'm3', date: '2026-02-05', miles: 28, purpose: 'Goodwill + Salvation Army loop', deduction: 19.60 },
            { id: 'm4', date: '2026-02-10', miles: 8, purpose: 'Drop-off at FedEx', deduction: 5.60 },
            { id: 'm5', date: '2026-02-14', miles: 52, purpose: 'Bid FTA warehouse pickup', deduction: 36.40 },
        ];
        let mileageTrips = stored.mileage || defaultMileage;

        let editingIndex = null;
        let editingPlatformIndex = null;
        let editingTaskIndex = null;
        let currentPeriod = 'weekly';
        let currentBarcodeType = 'barcode';
        let currentBarcodeItem = null;

        function generateSKU() {
            const category = document.getElementById('itemCategory').value || 'ITEM';
            const prefix = category.substring(0, 3).toUpperCase();
            const random = Math.floor(Math.random() * 9000) + 1000;
            const sku = `${prefix}-${random}`;
            document.getElementById('itemSKU').value = sku;
        }
        window.generateSKU = generateSKU;

        // Accumulated photo data URLs for the current form session
        let pendingPhotos = [];

        function addPhotoFromInput(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingPhotos.push(e.target.result);
                renderPhotoPreviews();
            };
            reader.readAsDataURL(file);
            // Reset so same camera can be used again
            input.value = '';
        }
        window.addPhotoFromInput = addPhotoFromInput;

        function addPhotosFromGallery(input) {
            if (!input.files) return;
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingPhotos.push(e.target.result);
                    renderPhotoPreviews();
                };
                reader.readAsDataURL(file);
            });
            input.value = '';
        }
        window.addPhotosFromGallery = addPhotosFromGallery;

        function renderPhotoPreviews() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            pendingPhotos.forEach((dataUrl, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${dataUrl}" alt="Photo ${index + 1}">
                    <button type="button" class="photo-remove-btn" onclick="removePendingPhoto(${index})">×</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePendingPhoto(index) {
            pendingPhotos.splice(index, 1);
            renderPhotoPreviews();
        }
        window.removePendingPhoto = removePendingPhoto;

        // Process image files into pendingPhotos (shared by drag-drop, paste, file input)
        function processImageFiles(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingPhotos.push(e.target.result);
                    renderPhotoPreviews();
                };
                reader.readAsDataURL(file);
            });
        }

        // Drag and drop handlers for the drop zone
        function initPhotoDropZone() {
            const zone = document.getElementById('photoDropZone');
            if (!zone) return;

            zone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
            });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                zone.classList.remove('drag-over');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    processImageFiles(e.dataTransfer.files);
                }
            });
        }

        // Clipboard paste — works in modal, on gallery cards, or on selected list items
        document.addEventListener('paste', (e) => {
            const clipItems = e.clipboardData && e.clipboardData.items;
            if (!clipItems) return;

            const imageFiles = [];
            for (let i = 0; i < clipItems.length; i++) {
                if (clipItems[i].type.startsWith('image/')) {
                    const file = clipItems[i].getAsFile();
                    if (file) imageFiles.push(file);
                }
            }
            if (imageFiles.length === 0) return;

            // 1. If item modal is open → add to pending photos
            const modal = document.getElementById('itemModal');
            if (modal && modal.classList.contains('active')) {
                e.preventDefault();
                processImageFiles(imageFiles);
                return;
            }

            // 2. If hovering a gallery card → add to that item
            const hoveredCard = document.querySelector('.item-card:hover');
            if (hoveredCard) {
                const gallery = document.getElementById('galleryView');
                const allCards = Array.from(gallery.querySelectorAll('.item-card'));
                const cardIdx = allCards.indexOf(hoveredCard);
                if (cardIdx >= 0) {
                    const sortedIndices = getSortedIndices();
                    const idx = sortedIndices[cardIdx];
                    if (idx != null) {
                        e.preventDefault();
                        pastePhotosToItem(idx, imageFiles);
                        return;
                    }
                }
            }

            // 3. If items are selected in list/gallery → add to first selected
            if (selectedItems.size > 0) {
                const idx = selectedItems.values().next().value;
                e.preventDefault();
                pastePhotosToItem(idx, imageFiles);
                return;
            }
        });

        function pastePhotosToItem(inventoryIdx, files) {
            const item = inventory[inventoryIdx];
            if (!item.photos) item.photos = [];
            let pending = files.length;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    item.photos.push(ev.target.result);
                    if (--pending === 0) {
                        renderInventory();
                        renderGallery();
                        saveToStorage();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Explicit paste button — reads clipboard via async API
        async function triggerPasteFromClipboard() {
            try {
                if (navigator.clipboard && navigator.clipboard.read) {
                    const clipboardItems = await navigator.clipboard.read();
                    for (const clipItem of clipboardItems) {
                        for (const type of clipItem.types) {
                            if (type.startsWith('image/')) {
                                const blob = await clipItem.getType(type);
                                processImageFiles([blob]);
                            }
                        }
                    }
                } else {
                    toast('Use Ctrl+V / Cmd+V to paste images', 'info');
                }
            } catch(err) {
                if (err.name === 'NotAllowedError') {
                    toast('Clipboard permission denied. Use Ctrl+V / Cmd+V', 'warn');
                } else {
                    console.error('Paste error:', err);
                    toast('No image found in clipboard', 'warn');
                }
            }
        }
        window.triggerPasteFromClipboard = triggerPasteFromClipboard;

        // Also allow dropping photos directly onto gallery cards (quick-add to existing items)
        function initGalleryDropListeners() {
            const gallery = document.getElementById('galleryView');
            if (!gallery) return;

            gallery.addEventListener('dragover', (e) => {
                const card = e.target.closest('.item-card');
                if (card && e.dataTransfer.types.includes('Files')) {
                    e.preventDefault();
                    card.style.outline = '2px solid var(--indigo-400)';
                    card.style.outlineOffset = '-2px';
                }
            });

            gallery.addEventListener('dragleave', (e) => {
                const card = e.target.closest('.item-card');
                if (card) {
                    card.style.outline = '';
                    card.style.outlineOffset = '';
                }
            });

            gallery.addEventListener('drop', (e) => {
                const card = e.target.closest('.item-card');
                if (!card || !e.dataTransfer.files || e.dataTransfer.files.length === 0) return;

                e.preventDefault();
                e.stopPropagation();
                card.style.outline = '';
                card.style.outlineOffset = '';

                // Find the inventory index from the card's onclick
                const allCards = Array.from(gallery.querySelectorAll('.item-card'));
                const cardIdx = allCards.indexOf(card);
                if (cardIdx < 0) return;

                const sortedIndices = getSortedIndices();
                const inventoryIdx = sortedIndices[cardIdx];
                if (inventoryIdx == null) return;

                const item = inventory[inventoryIdx];
                if (!item.photos) item.photos = [];

                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                let pending = files.length;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        item.photos.push(ev.target.result);
                        if (--pending === 0) { renderInventory(); renderGallery(); saveToStorage(); }
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        // Also allow dropping onto table rows in list view
        function initListDropListeners() {
            const tbody = document.getElementById('inventoryBody');
            if (!tbody) return;

            tbody.addEventListener('dragover', (e) => {
                const row = e.target.closest('tr');
                if (row && e.dataTransfer.types.includes('Files')) {
                    e.preventDefault();
                    row.style.outline = '2px solid var(--indigo-400)';
                    row.style.outlineOffset = '-2px';
                }
            });

            tbody.addEventListener('dragleave', (e) => {
                const row = e.target.closest('tr');
                if (row) {
                    row.style.outline = '';
                    row.style.outlineOffset = '';
                }
            });

            tbody.addEventListener('drop', (e) => {
                const row = e.target.closest('tr');
                if (!row || !e.dataTransfer.files || e.dataTransfer.files.length === 0) return;

                e.preventDefault();
                e.stopPropagation();
                row.style.outline = '';
                row.style.outlineOffset = '';

                const allRows = Array.from(tbody.querySelectorAll('tr'));
                const rowIdx = allRows.indexOf(row);
                if (rowIdx < 0) return;

                const sortedIndices = getSortedIndices();
                const inventoryIdx = sortedIndices[rowIdx];
                if (inventoryIdx == null) return;

                const item = inventory[inventoryIdx];
                if (!item.photos) item.photos = [];

                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                let pending = files.length;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        item.photos.push(ev.target.result);
                        if (--pending === 0) { renderInventory(); renderGallery(); saveToStorage(); }
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        function previewPhotos() {
            // Legacy — feeds into pendingPhotos from hidden input if used
            const files = document.getElementById('itemPhotos').files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingPhotos.push(e.target.result);
                    renderPhotoPreviews();
                };
                reader.readAsDataURL(file);
            });
        }
        window.previewPhotos = previewPhotos;

        function removePhoto(index) {
            const fileInput = document.getElementById('itemPhotos');
            const dt = new DataTransfer();
            const files = fileInput.files;
            
            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }
            
            fileInput.files = dt.files;
            previewPhotos();
        }
        window.removePhoto = removePhoto;

        function generateBarcode() {
            if (editingIndex === null) {
                toast('Save the item first before generating a barcode', 'warn');
                return;
            }
            
            currentBarcodeItem = inventory[editingIndex];
            
            // Populate label preview
            document.getElementById('labelItemName').textContent = currentBarcodeItem.name;
            document.getElementById('labelSKU').textContent = 'SKU: ' + (currentBarcodeItem.sku || 'N/A');
            document.getElementById('labelPrice').textContent = currentBarcodeItem.sale ? '$' + currentBarcodeItem.sale : '$' + currentBarcodeItem.purchase;
            document.getElementById('labelCategory').textContent = currentBarcodeItem.category;
            
            // Show modal and generate barcode
            document.getElementById('barcodeModal').classList.add('active'); window._pushModalState && _pushModalState('barcodeModal');
            renderBarcode();
        }
        window.generateBarcode = generateBarcode;

        function switchBarcodeType(type) {
            currentBarcodeType = type;
            
            if (type === 'barcode') {
                document.getElementById('barcodeTypeBtn').className = 'btn btn-primary';
                document.getElementById('qrcodeTypeBtn').className = 'btn btn-secondary';
            } else {
                document.getElementById('barcodeTypeBtn').className = 'btn btn-secondary';
                document.getElementById('qrcodeTypeBtn').className = 'btn btn-primary';
            }
            
            renderBarcode();
        }
        window.switchBarcodeType = switchBarcodeType;

        function renderBarcode() {
            if (!currentBarcodeItem) return;
            
            const canvas = document.getElementById('barcodeCanvas');
            const qrDiv = document.getElementById('qrcodeDiv');
            
            if (currentBarcodeType === 'barcode') {
                canvas.style.display = 'block';
                qrDiv.style.display = 'none';
                
                // Generate barcode
                try {
                    JsBarcode(canvas, currentBarcodeItem.sku || 'NO-SKU', {
                        format: 'CODE128',
                        width: 2,
                        height: 100,
                        displayValue: true,
                        fontSize: 16,
                        margin: 10
                    });
                } catch (error) {
                    console.error('Barcode generation error:', error);
                }
            } else {
                canvas.style.display = 'none';
                qrDiv.style.display = 'block';
                qrDiv.innerHTML = '';
                
                // Generate QR code with item data
                const itemData = JSON.stringify({
                    sku: currentBarcodeItem.sku,
                    name: currentBarcodeItem.name,
                    category: currentBarcodeItem.category,
                    price: currentBarcodeItem.sale || currentBarcodeItem.purchase,
                    platform: currentBarcodeItem.platform
                });
                
                new QRCode(qrDiv, {
                    text: itemData,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        function closeBarcodeModal() {
            document.getElementById('barcodeModal').classList.remove('active');
            currentBarcodeItem = null;
        }

        function printLabel() {
            const printWindow = window.open('', '_blank');
            const labelContent = document.getElementById('labelPreview').innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print Label - ${currentBarcodeItem.name}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                            margin: 0;
                            background: white;
                        }
                        .label {
                            border: 2px solid #000;
                            padding: 20px;
                            max-width: 400px;
                            text-align: center;
                        }
                        h3 { margin: 0 0 10px 0; }
                        p { margin: 5px 0; }
                        canvas, #qrcodeDiv { margin: 20px auto; }
                        @media print {
                            body { background: white; }
                            .label { border: 2px solid #000; }
                        }
                    </style>
                </head>
                <body>
                    <div class="label">
                        ${labelContent}
                    </div>
                    <scr` + `ipt>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 100);
                        }
                    </scr` + `ipt>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function downloadLabel() {
            const preview = document.getElementById('labelPreview');
            
            // Use html2canvas if available, otherwise create a basic canvas
            if (typeof html2canvas !== 'undefined') {
                html2canvas(preview).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `label-${currentBarcodeItem.sku || 'item'}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            } else {
                // Fallback: download just the barcode/QR code
                let canvas;
                if (currentBarcodeType === 'barcode') {
                    canvas = document.getElementById('barcodeCanvas');
                } else {
                    // For QR code, get the canvas from the QR div
                    const qrCanvas = document.querySelector('#qrcodeDiv canvas');
                    if (qrCanvas) canvas = qrCanvas;
                }
                
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = `${currentBarcodeType}-${currentBarcodeItem.sku || 'item'}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } else {
                    toast('Unable to download — use Print instead', 'warn');
                }
            }
        }

        // ── EXPENSES TRACKER ──────────────────────────────

        let editingExpenseIndex = null;

        const EXPENSE_CAT_ICONS = {
            'Packaging Supplies': '📦', 'Shipping Supplies': '📫', 'Gas / Mileage': '⛽',
            'Software / Subscriptions': '💻', 'Equipment': '🔧', 'Storage': '🏠',
            'Advertising': '📣', 'Sourcing Fees': '🎟️', 'Returns / Refunds': '↩️', 'Other': '📝'
        };

        const EXPENSE_CAT_COLORS = {
            'Packaging Supplies': '#8b5cf6', 'Shipping Supplies': '#6366f1', 'Gas / Mileage': '#f97316',
            'Software / Subscriptions': '#3b82f6', 'Equipment': '#64748b', 'Storage': '#14b8a6',
            'Advertising': '#ec4899', 'Sourcing Fees': '#eab308', 'Returns / Refunds': '#ef4444', 'Other': '#94a3b8'
        };

        function renderExpenses() {
            const tbody = document.getElementById('expensesBody');
            const empty = document.getElementById('expensesEmpty');
            tbody.innerHTML = '';

            // Sort by date descending
            const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                empty.style.display = 'block';
                tbody.parentElement.style.display = 'none';
            } else {
                empty.style.display = 'none';
                tbody.parentElement.style.display = '';
                
                sorted.forEach((exp, i) => {
                    const origIndex = expenses.indexOf(exp);
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => openEditExpenseModal(origIndex);

                    const catColor = EXPENSE_CAT_COLORS[exp.category] || '#94a3b8';
                    const icon = EXPENSE_CAT_ICONS[exp.category] || '📝';
                    const recurLabel = exp.recurring === 'auto'
                        ? `<span style="font-size:10px;font-weight:600;color:var(--emerald-600);background:var(--emerald-50,rgba(5,150,105,0.08));padding:2px 6px;border-radius:4px;margin-left:6px;">⚡ auto-updated</span>`
                        : exp.recurring ? `<span style="font-size:10px;font-weight:600;color:var(--indigo-500);background:var(--indigo-50);padding:2px 6px;border-radius:4px;margin-left:6px;">🔄 ${exp.recurring}</span>` : '';

                    const d = new Date(exp.date + 'T12:00:00');
                    const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                    row.innerHTML = `
                        <td style="white-space:nowrap;">${dateStr}</td>
                        <td style="font-weight:600;">${exp.description}${recurLabel}</td>
                        <td><span style="font-size:12px;font-weight:600;color:${catColor};background:${catColor}18;padding:3px 10px;border-radius:6px;">${icon} ${exp.category}</span></td>
                        <td style="font-weight:700;color:var(--rose-500);">-$${exp.amount.toFixed(2)}</td>
                        <td style="font-size:12px;color:var(--text-tertiary, var(--slate-400));">${exp.notes || '—'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateExpenseStats();
        }

        function updateExpenseStats() {
            const totalAll = expenses.reduce((s, e) => s + e.amount, 0);
            
            // This month
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonth = expenses.filter(e => new Date(e.date + 'T12:00:00') >= monthStart);
            const monthTotal = thisMonth.reduce((s, e) => s + e.amount, 0);
            
            // Last month for comparison
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            const lastMonth = expenses.filter(e => { const d = new Date(e.date + 'T12:00:00'); return d >= lastMonthStart && d <= lastMonthEnd; });
            const lastMonthTotal = lastMonth.reduce((s, e) => s + e.amount, 0);

            // Top category
            const catTotals = {};
            expenses.forEach(e => { catTotals[e.category] = (catTotals[e.category] || 0) + e.amount; });
            const topCat = Object.entries(catTotals).sort((a, b) => b[1] - a[1])[0];

            // Adjusted profit = inventory profit - total expenses
            const sold = inventory.filter(i => i.status === 'Sold');
            const invProfit = sold.reduce((s, i) => s + (i.profit || 0), 0);
            const adjusted = invProfit - totalAll;

            document.getElementById('totalExpenses').textContent = '$' + totalAll.toFixed(0);
            document.getElementById('monthExpenses').textContent = '$' + monthTotal.toFixed(0);
            
            if (lastMonthTotal > 0) {
                const pctChange = ((monthTotal - lastMonthTotal) / lastMonthTotal * 100);
                document.getElementById('monthExpenseChange').textContent = (pctChange >= 0 ? '↑ ' : '↓ ') + Math.abs(pctChange).toFixed(0) + '% vs last month';
                document.getElementById('monthExpenseChange').className = 'stat-change ' + (pctChange <= 0 ? 'positive' : '');
            } else {
                document.getElementById('monthExpenseChange').textContent = thisMonth.length + ' expense' + (thisMonth.length !== 1 ? 's' : '');
            }

            if (topCat) {
                const icon = EXPENSE_CAT_ICONS[topCat[0]] || '';
                document.getElementById('topExpenseCategory').textContent = icon + ' ' + topCat[0];
                document.getElementById('topExpenseCategoryAmt').textContent = '$' + topCat[1].toFixed(0) + ' total';
            }

            document.getElementById('adjustedProfit').textContent = (adjusted >= 0 ? '$' : '-$') + Math.abs(adjusted).toFixed(0);
            document.getElementById('adjustedProfit').style.color = adjusted >= 0 ? 'var(--emerald-500)' : 'var(--rose-500)';

            // Category breakdown bars
            renderExpenseCategoryBreakdown(catTotals, totalAll);
        }

        function renderExpenseCategoryBreakdown(catTotals, total) {
            const container = document.getElementById('expenseCatBreakdown');
            if (Object.keys(catTotals).length === 0) { container.innerHTML = ''; return; }

            const sorted = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);
            const maxVal = sorted[0][1] || 1;

            let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
            sorted.forEach(([cat, amount]) => {
                const color = EXPENSE_CAT_COLORS[cat] || '#94a3b8';
                const icon = EXPENSE_CAT_ICONS[cat] || '📝';
                const pct = total > 0 ? (amount / total * 100).toFixed(0) : 0;
                const barWidth = (amount / maxVal * 100).toFixed(1);
                html += `
                    <div style="background:var(--bg-surface, white);border:1px solid var(--border-primary, var(--slate-200));border-radius:10px;padding:12px 14px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-size:12px;font-weight:600;color:var(--text-primary, var(--slate-900));">${icon} ${cat}</span>
                            <span style="font-size:12px;font-weight:700;color:${color};">$${amount.toFixed(2)} <span style="font-size:10px;color:var(--text-tertiary, var(--slate-400));font-weight:500;">(${pct}%)</span></span>
                        </div>
                        <div style="height:6px;background:var(--bg-inset, var(--slate-100));border-radius:3px;overflow:hidden;">
                            <div style="height:100%;width:${barWidth}%;background:${color};border-radius:3px;transition:width 0.5s;"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function openExpenseModal() {
            editingExpenseIndex = null;
            document.getElementById('expenseModalTitle').textContent = 'Add Expense';
            document.getElementById('expenseSubmitBtn').textContent = 'Add Expense';
            document.getElementById('expenseDeleteBtn').style.display = 'none';
            document.getElementById('expenseForm').reset();
            // Default to today
            const today = new Date();
            document.getElementById('expenseDate').value = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
            document.getElementById('expenseModal').classList.add('active'); window._pushModalState && _pushModalState('expenseModal');
        }
        window.openExpenseModal = openExpenseModal;

        function openEditExpenseModal(index) {
            editingExpenseIndex = index;
            const exp = expenses[index];
            document.getElementById('expenseModalTitle').textContent = 'Edit Expense';
            document.getElementById('expenseSubmitBtn').textContent = 'Update Expense';
            document.getElementById('expenseDeleteBtn').style.display = 'block';
            
            document.getElementById('expenseDate').value = exp.date;
            document.getElementById('expenseAmount').value = exp.amount;
            document.getElementById('expenseDescription').value = exp.description;
            document.getElementById('expenseCategory').value = exp.category;
            document.getElementById('expenseRecurring').value = exp.recurring || '';
            document.getElementById('expenseNotes').value = exp.notes || '';
            
            document.getElementById('expenseModal').classList.add('active'); window._pushModalState && _pushModalState('expenseModal');
        }
        window.openEditExpenseModal = openEditExpenseModal;

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('active');
            document.getElementById('expenseForm').reset();
            editingExpenseIndex = null;
        }
        window.closeExpenseModal = closeExpenseModal;

        function saveExpense(event) {
            event.preventDefault();
            
            const data = {
                id: editingExpenseIndex !== null ? expenses[editingExpenseIndex].id : 'e' + Date.now(),
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDescription').value.trim(),
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
                recurring: document.getElementById('expenseRecurring').value,
                notes: document.getElementById('expenseNotes').value.trim()
            };
            
            if (editingExpenseIndex !== null) {
                expenses[editingExpenseIndex] = data;
            } else {
                expenses.push(data);
            }
            
            renderExpenses();
            saveToStorage();
            closeExpenseModal();
        }
        window.saveExpense = saveExpense;

        async function deleteExpense() {
            if (editingExpenseIndex === null) return;
            if (!await confirmAction('Delete this expense?')) return;
            expenses.splice(editingExpenseIndex, 1);
            renderExpenses();
            saveToStorage();
            closeExpenseModal();
            toast('Expense deleted');
        }
        window.deleteExpense = deleteExpense;

        // Close expense modal on backdrop click
        document.getElementById('expenseModal').addEventListener('click', function(e) {
            if (e.target === this) closeExpenseModal();
        });

        // ── MILEAGE TRACKER ──────────────────────────────

        // ── MILEAGE TRACKER (Start Trip + Timer + Geolocation + Auto-Stop Agent) ──

        let tripActive = false;
        let tripStartTimestamp = null;
        let tripTimerInterval = null;
        let tripStartLocation = null;

        // ── Auto-Stop Location Agent state ──
        let gpsWatchId = null;
        let tripCoords = [];           // all GPS breadcrumbs during trip
        let stationaryAnchor = null;   // { lat, lng, since: timestamp }
        let stationaryCheckInterval = null;
        let autoStopPrompted = false;  // prevent repeat prompts per stop
        const STATIONARY_RADIUS_M = 50;
        const STATIONARY_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes

        function toggleTrip() {
            if (tripActive) {
                showTripEndForm();
            } else {
                startTrip();
            }
        }
        window.toggleTrip = toggleTrip;

        function startTrip() {
            tripActive = true;
            tripStartTimestamp = Date.now();
            tripCoords = [];
            stationaryAnchor = null;
            autoStopPrompted = false;

            // Update button
            document.getElementById('tripBtnIcon').textContent = '⏹';
            document.getElementById('tripBtnText').textContent = 'End Trip';
            document.getElementById('startTripBtn').style.background = 'var(--rose-500)';

            // Show banner, hide end form
            const banner = document.getElementById('liveTripBanner');
            banner.style.display = 'block';
            document.getElementById('tripEndForm').style.display = 'none';
            document.getElementById('tripBannerLive').style.display = 'flex';

            // Start time display
            const startTime = new Date(tripStartTimestamp);
            document.getElementById('tripStartTime').textContent = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            // Start timer
            tripTimerInterval = setInterval(updateTripTimer, 1000);
            updateTripTimer();

            // Geolocation — continuous watch for GPS agent
            document.getElementById('tripLocation').textContent = '📍 Getting location…';
            if (navigator.geolocation) {
                gpsWatchId = navigator.geolocation.watchPosition(
                    function(pos) {
                        const coord = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now() };
                        tripCoords.push(coord);

                        // Set start location from first fix
                        if (!tripStartLocation) {
                            tripStartLocation = { lat: coord.lat, lng: coord.lng };
                            reverseGeocode(coord.lat, coord.lng, 'tripLocation');
                        }

                        // Update current location display
                        document.getElementById('tripLocation').textContent = '📍 ' + coord.lat.toFixed(4) + ', ' + coord.lng.toFixed(4);

                        // ── Auto-Stop Agent: stationary detection ──
                        checkStationary(coord);
                    },
                    function(err) {
                        document.getElementById('tripLocation').textContent = '📍 Location unavailable';
                        tripStartLocation = null;
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000 }
                );
            } else {
                document.getElementById('tripLocation').textContent = '📍 Geolocation not supported';
            }

            toast('Trip started — GPS tracking active', 'info');
        }
        window.startTrip = startTrip;

        // ── Haversine distance (meters) ──
        function haversineM(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // ── Stationary detection logic ──
        function checkStationary(coord) {
            if (!tripActive || autoStopPrompted) return;

            if (!stationaryAnchor) {
                stationaryAnchor = { lat: coord.lat, lng: coord.lng, since: coord.ts };
                return;
            }

            const dist = haversineM(stationaryAnchor.lat, stationaryAnchor.lng, coord.lat, coord.lng);

            if (dist > STATIONARY_RADIUS_M) {
                // Moved — reset anchor
                stationaryAnchor = { lat: coord.lat, lng: coord.lng, since: coord.ts };
                return;
            }

            // Still within radius — check time
            const dwellMs = coord.ts - stationaryAnchor.since;
            if (dwellMs >= STATIONARY_TIMEOUT_MS) {
                autoStopPrompted = true;
                promptAutoStop();
            }
        }

        // ── Auto-stop prompt ──
        async function promptAutoStop() {
            const isSourcing = await confirmAction('You\'ve been stationary for 10+ min. Are you sourcing here?');
            if (isSourcing && tripActive) {
                // Auto-stop with "Sourcing" purpose
                autoEndTrip('Sourcing');
            } else if (tripActive) {
                // User said no — allow them to keep going, but don't re-prompt for this stop
                toast('Trip continues — will check again if you stop elsewhere', 'info');
                // Reset anchor so it can detect a NEW stationary point
                stationaryAnchor = null;
                autoStopPrompted = false;
            }
        }

        function autoEndTrip(purpose) {
            if (!tripActive) return;

            clearInterval(tripTimerInterval);
            tripTimerInterval = null;
            stopGpsWatch();

            const elapsed = Math.floor((Date.now() - tripStartTimestamp) / 1000);
            const estimatedMiles = estimateTripMiles();

            tripActive = false;
            document.getElementById('tripBtnIcon').textContent = '▶️';
            document.getElementById('tripBtnText').textContent = 'Start Trip';
            document.getElementById('startTripBtn').style.background = '';

            // Show end form pre-filled
            document.getElementById('tripBannerLive').style.display = 'none';
            document.getElementById('tripEndForm').style.display = 'block';
            document.getElementById('tripEndMiles').value = estimatedMiles > 0 ? estimatedMiles.toFixed(1) : '';
            document.getElementById('tripEndPurpose').value = purpose || '';
            document.getElementById('tripEndElapsed').textContent = formatDuration(elapsed);
            document.getElementById('tripEndForm').dataset.elapsed = elapsed;
        }

        function showTripEndForm() {
            if (!tripActive) return;

            clearInterval(tripTimerInterval);
            tripTimerInterval = null;
            stopGpsWatch();

            const elapsed = Math.floor((Date.now() - tripStartTimestamp) / 1000);
            const estimatedMiles = estimateTripMiles();

            tripActive = false;
            document.getElementById('tripBtnIcon').textContent = '▶️';
            document.getElementById('tripBtnText').textContent = 'Start Trip';
            document.getElementById('startTripBtn').style.background = '';

            // Show inline end form
            document.getElementById('tripBannerLive').style.display = 'none';
            document.getElementById('tripEndForm').style.display = 'block';
            document.getElementById('tripEndMiles').value = estimatedMiles > 0 ? estimatedMiles.toFixed(1) : '';
            document.getElementById('tripEndPurpose').value = '';
            document.getElementById('tripEndElapsed').textContent = formatDuration(elapsed);
            document.getElementById('tripEndForm').dataset.elapsed = elapsed;
        }

        function stopGpsWatch() {
            if (gpsWatchId !== null) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            stationaryAnchor = null;
            autoStopPrompted = false;
        }

        // ── Estimate miles from GPS breadcrumbs ──
        function estimateTripMiles() {
            if (tripCoords.length < 2) return 0;
            let totalM = 0;
            for (let i = 1; i < tripCoords.length; i++) {
                totalM += haversineM(tripCoords[i-1].lat, tripCoords[i-1].lng, tripCoords[i].lat, tripCoords[i].lng);
            }
            return totalM / 1609.34; // meters to miles
        }

        // ── Save trip from inline form ──
        function saveTripFromForm() {
            const milesVal = parseFloat(document.getElementById('tripEndMiles').value);
            if (!milesVal || milesVal <= 0) {
                toast('Enter miles driven', 'error');
                return;
            }
            const purpose = document.getElementById('tripEndPurpose').value.trim() || 'Business trip';
            const elapsed = parseInt(document.getElementById('tripEndForm').dataset.elapsed) || 0;
            const deduction = Math.round(milesVal * IRS_MILEAGE_RATE * 100) / 100;
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

            const trip = {
                id: 'm' + Date.now(),
                date: dateStr,
                miles: milesVal,
                purpose: purpose,
                deduction: deduction,
                duration: elapsed,
                startLocation: tripStartLocation ? (tripStartLocation.lat.toFixed(4) + ', ' + tripStartLocation.lng.toFixed(4)) : null
            };
            mileageTrips.push(trip);

            // Auto-sync the consolidated Vehicle Expenses entry
            updateVehicleExpenseSummary();

            // Reset
            tripStartTimestamp = null;
            tripStartLocation = null;
            tripCoords = [];
            document.getElementById('liveTripBanner').style.display = 'none';
            document.getElementById('tripEndForm').style.display = 'none';

            renderMileage();
            renderExpenses();
            updateStats();
            saveToStorage();
            toast('Trip saved — $' + deduction.toFixed(2) + ' deduction');
        }
        window.saveTripFromForm = saveTripFromForm;

        // ── Recurring "Vehicle Expenses" summary entry ──
        // Maintains a single auto-updating expense that totals all mileage deductions
        function cancelTripEnd() {
            tripStartTimestamp = null;
            tripStartLocation = null;
            tripCoords = [];
            document.getElementById('liveTripBanner').style.display = 'none';
            document.getElementById('tripEndForm').style.display = 'none';
            toast('Trip discarded', 'info');
        }
        window.cancelTripEnd = cancelTripEnd;

        function reverseGeocode(lat, lng, elementId) {
            fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng)
                .then(r => r.json())
                .then(data => {
                    if (data && data.display_name) {
                        const parts = data.display_name.split(',').slice(0, 3).join(',');
                        document.getElementById(elementId).textContent = '📍 ' + parts;
                    }
                })
                .catch(() => {});
        }

        function updateTripTimer() {
            if (!tripStartTimestamp) return;
            const elapsed = Math.floor((Date.now() - tripStartTimestamp) / 1000);
            const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const s = String(elapsed % 60).padStart(2, '0');
            document.getElementById('tripTimer').textContent = h + ':' + m + ':' + s;
        }

        function stopTrip() {
            showTripEndForm();
        }
        window.stopTrip = stopTrip;

        function formatDuration(secs) {
            if (!secs || secs <= 0) return '—';
            const h = Math.floor(secs / 3600);
            const m = Math.floor((secs % 3600) / 60);
            if (h > 0) return h + 'h ' + m + 'm';
            return m + 'm';
        }

        function openManualTripModal() {
            document.getElementById('manualTripForm').reset();
            document.getElementById('manualTripModalTitle').textContent = 'Log Trip';
            const today = new Date();
            document.getElementById('mileageQuickDate').value = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
            document.getElementById('mileageQuickCalc').style.display = 'none';
            document.getElementById('manualTripModal').classList.add('active'); window._pushModalState && _pushModalState('manualTripModal');
        }
        window.openManualTripModal = openManualTripModal;

        function closeManualTripModal() {
            document.getElementById('manualTripModal').classList.remove('active');
        }
        window.closeManualTripModal = closeManualTripModal;

        function saveManualTrip(event) {
            event.preventDefault();
            const miles = parseFloat(document.getElementById('mileageQuickMiles').value);
            const purpose = document.getElementById('mileageQuickPurpose').value.trim();
            const date = document.getElementById('mileageQuickDate').value;

            if (!miles || miles <= 0) { toast('Enter miles driven', 'error'); return; }
            if (!purpose) { toast('Enter a trip purpose', 'error'); return; }
            if (!date) { toast('Select a date', 'error'); return; }

            const deduction = Math.round(miles * IRS_MILEAGE_RATE * 100) / 100;
            mileageTrips.push({ id: 'm' + Date.now(), date: date, miles: miles, purpose: purpose, deduction: deduction, duration: null, startLocation: null });

            updateVehicleExpenseSummary();
            renderMileage();
            renderExpenses();
            updateStats();
            saveToStorage();
            closeManualTripModal();
        }
        window.saveManualTrip = saveManualTrip;

        async function deleteMileageTrip(tripId) {
            if (!await confirmAction('Delete this trip?')) return;
            mileageTrips = mileageTrips.filter(t => t.id !== tripId);
            updateVehicleExpenseSummary();
            renderMileage();
            renderExpenses();
            updateStats();
            saveToStorage();
            toast('Trip deleted');
        }
        window.deleteMileageTrip = deleteMileageTrip;

        function renderMileage() {
            const totalMiles = mileageTrips.reduce((s, t) => s + t.miles, 0);
            const totalDeduction = mileageTrips.reduce((s, t) => s + t.deduction, 0);
            const avgMiles = mileageTrips.length > 0 ? (totalMiles / mileageTrips.length).toFixed(1) : 0;

            // This month
            const now = new Date();
            const mStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthTrips = mileageTrips.filter(t => new Date(t.date + 'T12:00:00') >= mStart);
            const mMiles = monthTrips.reduce((s, t) => s + t.miles, 0);
            const mDed = monthTrips.reduce((s, t) => s + t.deduction, 0);

            // Update stats inside mileage tab
            document.getElementById('totalMiles').textContent = totalMiles.toFixed(1);
            document.getElementById('totalMileageDeduction').textContent = '$' + totalDeduction.toFixed(2);
            document.getElementById('totalTrips').textContent = mileageTrips.length;
            const avgEl = document.getElementById('avgMilesTrip');
            if (avgEl) avgEl.textContent = avgMiles > 0 ? ('Avg ' + avgMiles + ' mi/trip') : '—';
            const mmEl = document.getElementById('monthMiles');
            if (mmEl) mmEl.textContent = mMiles.toFixed(1);
            const mdEl = document.getElementById('monthMilesDed');
            if (mdEl) mdEl.textContent = '$' + mDed.toFixed(2) + ' deduction';

            // Update header stat card
            const headerStat = document.getElementById('mileageDeductionStat');
            if (headerStat) headerStat.textContent = '$' + totalDeduction.toFixed(0);
            const headerSub = document.getElementById('mileageDeductionSub');
            if (headerSub) headerSub.textContent = mileageTrips.length + ' trip' + (mileageTrips.length !== 1 ? 's' : '') + ' · $0.70/mi';

            // Render trip log table
            const tbody = document.getElementById('mileageTripLog');
            const empty = document.getElementById('mileageEmpty');

            if (mileageTrips.length === 0) {
                tbody.innerHTML = '';
                if (empty) empty.style.display = 'block';
                tbody.parentElement.style.display = 'none';
                return;
            }

            if (empty) empty.style.display = 'none';
            tbody.parentElement.style.display = '';

            const sorted = [...mileageTrips].sort((a, b) => new Date(b.date) - new Date(a.date));
            tbody.innerHTML = '';

            sorted.forEach(trip => {
                const d = new Date(trip.date + 'T12:00:00');
                const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const durStr = trip.duration ? formatDuration(trip.duration) : '—';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="white-space:nowrap;">${dateStr}</td>
                    <td style="font-weight:600;">
                        ${trip.purpose}
                        ${trip.startLocation ? '<div style="font-size:10px;color:var(--text-tertiary, var(--slate-400));margin-top:2px;">📍 ' + trip.startLocation + '</div>' : ''}
                    </td>
                    <td style="font-weight:700;font-variant-numeric:tabular-nums;">${trip.miles.toFixed(1)} mi</td>
                    <td style="font-weight:700;color:var(--emerald-500);font-variant-numeric:tabular-nums;">$${trip.deduction.toFixed(2)}</td>
                    <td style="color:var(--text-tertiary, var(--slate-400));">${durStr}</td>
                    <td><button onclick="deleteMileageTrip('${trip.id}')" style="background:none;border:none;color:var(--text-tertiary, var(--slate-400));cursor:pointer;font-size:14px;opacity:0.5;transition:opacity 0.15s;" onmouseover="this.style.opacity='1';this.style.color='var(--rose-500)'" onmouseout="this.style.opacity='0.5';this.style.color='var(--text-tertiary, var(--slate-400))'">🗑</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Live calc preview for manual trip modal
        document.addEventListener('DOMContentLoaded', function() {
            const milesInput = document.getElementById('mileageQuickMiles');
            if (milesInput) {
                milesInput.addEventListener('input', function() {
                    const miles = parseFloat(this.value) || 0;
                    const calc = document.getElementById('mileageQuickCalc');
                    const amt = document.getElementById('mileageQuickAmt');
                    if (miles > 0) { calc.style.display = 'block'; amt.textContent = '$' + (miles * IRS_MILEAGE_RATE).toFixed(2); }
                    else { calc.style.display = 'none'; }
                });
            }
            // Close manual trip modal on backdrop
            document.getElementById('manualTripModal').addEventListener('click', function(e) { if (e.target === this) closeManualTripModal(); });
        });

        // ═══════════════════════════════════════════════════════════════
        // BARCODE / QR CODE SCANNER + PRODUCT LOOKUP
        // ═══════════════════════════════════════════════════════════════

        let html5QrCode = null;
        let lastScanResult = null; // stores the looked-up product data

        function openScanModal() {
            document.getElementById('scanOverlay').style.display = 'flex'; window._pushModalState && _pushModalState('scanOverlay');
            document.getElementById('scanStatus').textContent = 'Starting camera…';
            document.getElementById('scanStatus').className = 'scan-status loading';
            document.getElementById('scanResultPreview').classList.remove('visible');
            document.getElementById('scanActions').style.display = 'none';
            document.getElementById('manualBarcode').value = '';
            lastScanResult = null;
            startScanner();
        }

        function closeScanModal() {
            stopScanner();
            document.getElementById('scanOverlay').style.display = 'none';
        }
        window.closeScanModal = closeScanModal;

        async function startScanner() {
            if (typeof Html5Qrcode === 'undefined') {
                setScanStatus('Scanner library failed to load. Use manual entry below.', 'error');
                return;
            }

            try {
                html5QrCode = new Html5Qrcode('scanReader');

                await html5QrCode.start(
                    { facingMode: 'environment' }, // back camera
                    {
                        fps: 10,
                        qrbox: { width: 280, height: 160 },
                        aspectRatio: 1.5
                    },
                    onScanSuccess,
                    () => {} // ignore scan failures (happens every frame without a code)
                );

                setScanStatus('Point your camera at a barcode or QR code', '');
            } catch (err) {
                console.warn('Camera start failed:', err);
                setScanStatus('Camera not available — type the barcode number below', 'error');
            }
        }

        async function stopScanner() {
            if (html5QrCode) {
                try {
                    const state = html5QrCode.getState();
                    if (state === 2) { // Html5QrcodeState.SCANNING
                        await html5QrCode.stop();
                    }
                } catch(e) { /* already stopped */ }
                try { html5QrCode.clear(); } catch(e) {}
                html5QrCode = null;
            }
        }

        function setScanStatus(msg, type) {
            const el = document.getElementById('scanStatus');
            el.textContent = msg;
            el.className = 'scan-status' + (type ? ' ' + type : '');
        }

        async function onScanSuccess(decodedText) {
            // Pause scanner while we look up
            try { await html5QrCode.pause(true); } catch(e) {}

            setScanStatus('Code detected: ' + decodedText + ' — looking up…', 'loading');
            await lookupBarcode(decodedText);
        }

        function lookupManualBarcode() {
            const code = document.getElementById('manualBarcode').value.trim();
            if (!code) return;
            setScanStatus('Looking up: ' + code + '…', 'loading');
            lookupBarcode(code);
        }
        window.lookupManualBarcode = lookupManualBarcode;

        async function lookupBarcode(code) {
            document.getElementById('scanResultPreview').classList.remove('visible');
            document.getElementById('scanActions').style.display = 'none';

            try {
                // UPCitemdb free trial API — no key required, 100 lookups/day
                const resp = await fetch(
                    'https://api.upcitemdb.com/prod/trial/lookup?upc=' + encodeURIComponent(code)
                );

                if (resp.status === 429) {
                    setScanStatus('Rate limited — wait a moment and try again', 'error');
                    resumeScanner();
                    return;
                }

                if (!resp.ok) throw new Error('API returned ' + resp.status);

                const data = await resp.json();

                if (!data.items || data.items.length === 0) {
                    setScanStatus('No product found for: ' + code + ' — try another or fill manually', 'error');
                    lastScanResult = { barcode: code, title: '', brand: '', category: '', price: null };
                    showScanPreview(lastScanResult);
                    resumeScanner();
                    return;
                }

                const item = data.items[0];

                // Map UPCitemdb category to our closest category
                const mappedCategory = mapCategory(item.category || '');

                // Find a reasonable price from offers
                let avgPrice = null;
                if (item.offers && item.offers.length > 0) {
                    const prices = item.offers
                        .map(o => parseFloat(o.price))
                        .filter(p => !isNaN(p) && p > 0);
                    if (prices.length > 0) {
                        avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                    }
                }
                // Fallback to lowest_recorded_price
                if (!avgPrice && item.lowest_recorded_price) {
                    avgPrice = parseFloat(item.lowest_recorded_price);
                }

                lastScanResult = {
                    barcode: code,
                    title: item.title || '',
                    brand: item.brand || '',
                    category: mappedCategory,
                    price: avgPrice,
                    rawCategory: item.category || '',
                    description: item.description || '',
                    ean: item.ean || '',
                    upc: item.upc || ''
                };

                setScanStatus('✅ Product found!', 'found');
                showScanPreview(lastScanResult);

            } catch (err) {
                console.error('Barcode lookup error:', err);
                // Still let user fill what we have
                lastScanResult = { barcode: code, title: '', brand: '', category: '', price: null };
                setScanStatus('Lookup failed — you can still auto-fill the barcode', 'error');
                showScanPreview(lastScanResult);
                resumeScanner();
            }
        }

        function resumeScanner() {
            if (html5QrCode) {
                try { html5QrCode.resume(); } catch(e) {}
            }
        }

        function showScanPreview(result) {
            document.getElementById('scanProductName').textContent = result.title || '(unknown product)';
            document.getElementById('scanBrand').textContent = result.brand || '—';
            document.getElementById('scanCategory').textContent = result.rawCategory || result.category || '—';
            document.getElementById('scanBarcode').textContent = result.barcode || '—';
            document.getElementById('scanPrice').textContent = result.price ? '$' + result.price.toFixed(2) : '—';

            document.getElementById('scanResultPreview').classList.add('visible');
            document.getElementById('scanActions').style.display = 'flex';
        }

        function fillFormFromScan() {
            if (!lastScanResult) return;

            closeScanModal();
            openModal(); // opens the Add Item modal

            // Give the modal a moment to render, then fill fields
            setTimeout(() => {
                const r = lastScanResult;

                if (r.title) {
                    document.getElementById('itemName').value = r.title;
                }

                // Use barcode as SKU
                if (r.barcode) {
                    document.getElementById('itemSKU').value = r.barcode;
                }

                // Set category dropdown
                if (r.category) {
                    const sel = document.getElementById('itemCategory');
                    for (let i = 0; i < sel.options.length; i++) {
                        if (sel.options[i].value === r.category) {
                            sel.selectedIndex = i;
                            break;
                        }
                    }
                }

                // Set source to brand if available
                if (r.brand) {
                    document.getElementById('itemSource').value = r.brand;
                }

                // Set purchase price hint if we have avg market price
                // (User will adjust — this is a starting reference)
                if (r.price && r.price > 0) {
                    // Leave purchase price blank but pre-fill sale price as market reference
                    document.getElementById('salePrice').value = r.price.toFixed(2);
                }

                // Flash the form to show it was auto-filled
                const form = document.getElementById('itemForm');
                form.style.transition = 'box-shadow 0.3s';
                form.style.boxShadow = '0 0 0 3px var(--indigo-300)';
                setTimeout(() => { form.style.boxShadow = ''; }, 1500);

            }, 200);
        }
        window.fillFormFromScan = fillFormFromScan;

        function scanAnother() {
            lastScanResult = null;
            document.getElementById('scanResultPreview').classList.remove('visible');
            document.getElementById('scanActions').style.display = 'none';
            setScanStatus('Point your camera at a barcode or QR code', '');
            resumeScanner();
        }
        window.scanAnother = scanAnother;

        // Map UPCitemdb categories to our dropdown values
        function mapCategory(apiCategory) {
            if (!apiCategory) return '';
            const c = apiCategory.toLowerCase();
            const map = [
                [['electronics', 'computer', 'laptop', 'phone', 'tablet', 'tech'], 'Electronics'],
                [['book', 'magazine', 'novel'], 'Books'],
                [['beauty', 'skincare', 'cosmetic', 'makeup'], 'Beauty & Skincare'],
                [['jewelry', 'jewel', 'necklace', 'ring', 'bracelet'], 'Jewelry'],
                [['toy', 'game', 'kid', 'children', 'collectible'], 'Kids Collectibles'],
                [['baby', 'infant', 'toddler'], 'Baby'],
                [['kitchen', 'dining', 'cookware'], 'Kitchen & Dining'],
                [['automotive', 'car', 'vehicle'], 'Automotive'],
                [['media', 'dvd', 'cd', 'vinyl', 'music', 'movie', 'video'], 'Media'],
                [['men', 'mens'], 'Mens Clothing'],
                [['women', 'womens', 'dress'], 'Womens Clothing'],
                [['health', 'wellness', 'vitamin', 'supplement'], 'Health & Wellness'],
                [['home', 'decor', 'furniture'], 'Home Decor'],
                [['accessori', 'bag', 'hat', 'sunglasses', 'watch'], 'Accessories'],
            ];
            for (const [keywords, value] of map) {
                if (keywords.some(kw => c.includes(kw))) return value;
            }
            return 'Other';
        }

        // ═══════════════════════════════════════════════════════════════
        // CSV IMPORT
        // ═══════════════════════════════════════════════════════════════

        let importParsedRows = [];
        let importColumnMap = {};

        // Our inventory fields and their display names
        const IMPORT_FIELDS = [
            { key: 'name', label: 'Item Name', required: true },
            { key: 'sku', label: 'SKU' },
            { key: 'qty', label: 'Quantity', numeric: true },
            { key: 'category', label: 'Category' },
            { key: 'source', label: 'Source' },
            { key: 'purchase', label: 'Purchase Price', numeric: true },
            { key: 'purchaseShipping', label: 'Purchase Shipping', numeric: true },
            { key: 'sale', label: 'Sale Price', numeric: true },
            { key: 'outboundShipping', label: 'Outbound Shipping', numeric: true },
            { key: 'packaging', label: 'Packaging Cost', numeric: true },
            { key: 'platformFees', label: 'Platform Fees', numeric: true },
            { key: 'taxReserve', label: 'Tax Reserve', numeric: true },
            { key: 'platform', label: 'Platform' },
            { key: 'status', label: 'Status' },
            { key: 'days', label: 'Days Listed', numeric: true },
            { key: 'dateSold', label: 'Date Sold' },
            { key: '_skip', label: '— Skip this column —' }
        ];

        // Fuzzy match CSV headers to our fields
        function guessFieldMapping(header) {
            const h = header.toLowerCase().replace(/[^a-z0-9]/g, '');
            const guesses = [
                [/^(item|name|title|product|description)/, 'name'],
                [/^(sku|code|barcode|upc|itemcode|id)/, 'sku'],
                [/^(qty|quantity|stock|count|units|amount)/, 'qty'],
                [/^(cat|category|type)/, 'category'],
                [/^(source|store|supplier|vendor|from|bought)/, 'source'],
                [/^(purchase|cost|paid|buyprice|purchaseprice|cog)/, 'purchase'],
                [/^(purchaseship|inboundship|shippingin)/, 'purchaseShipping'],
                [/^(sale|sell|sold|price|saleprice|sellprice|revenue)/, 'sale'],
                [/^(outbound|shipout|shippingout|outboundship)/, 'outboundShipping'],
                [/^(pack|packaging)/, 'packaging'],
                [/^(fee|platformfee|sellingfee)/, 'platformFees'],
                [/^(tax|taxreserve)/, 'taxReserve'],
                [/^(platform|marketplace|channel|listedon|soldon)/, 'platform'],
                [/^(status|state|condition)/, 'status'],
                [/^(day|dayslisted|daysactive|age)/, 'days'],
                [/^(datesold|solddate|saledate|sold)/, 'dateSold'],
                [/^(profit)/, '_skip'], // we compute profit, don't import it
            ];
            for (const [regex, field] of guesses) {
                if (regex.test(h)) return field;
            }
            return '_skip';
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            if (lines.length < 2) return { headers: [], rows: [] };

            // Detect delimiter
            const firstLine = lines[0];
            const delim = firstLine.includes('\t') ? '\t' : ',';

            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (inQuotes) {
                        if (ch === '"' && line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else if (ch === '"') {
                            inQuotes = false;
                        } else {
                            current += ch;
                        }
                    } else {
                        if (ch === '"') {
                            inQuotes = true;
                        } else if (ch === delim) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += ch;
                        }
                    }
                }
                result.push(current.trim());
                return result;
            }

            const headers = parseLine(lines[0]);
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const vals = parseLine(lines[i]);
                if (vals.length > 0 && vals.some(v => v)) {
                    const row = {};
                    headers.forEach((h, idx) => { row[h] = vals[idx] || ''; });
                    rows.push(row);
                }
            }
            return { headers, rows };
        }

        function openImportModal(file) {
            document.getElementById('importOverlay').style.display = 'flex'; window._pushModalState && _pushModalState('importOverlay');
            document.getElementById('importStatus').textContent = 'Parsing your file…';
            document.getElementById('importStatus').className = 'scan-status loading';
            document.getElementById('importMappingArea').style.display = 'none';
            document.getElementById('importActions').style.display = 'none';
            importParsedRows = [];
            importColumnMap = {};

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const { headers, rows } = parseCSV(text);

                if (headers.length === 0 || rows.length === 0) {
                    document.getElementById('importStatus').textContent = 'Could not parse any rows. Check your CSV format.';
                    document.getElementById('importStatus').className = 'scan-status error';
                    return;
                }

                importParsedRows = rows;

                // Auto-guess mappings
                headers.forEach(h => {
                    importColumnMap[h] = guessFieldMapping(h);
                });

                // Build mapping UI
                buildMappingUI(headers, rows);

                document.getElementById('importStatus').textContent = '✅ File parsed — review column mapping below';
                document.getElementById('importStatus').className = 'scan-status found';
                document.getElementById('importMappingArea').style.display = 'block';
                document.getElementById('importActions').style.display = 'flex';
            };
            reader.onerror = function() {
                document.getElementById('importStatus').textContent = 'Failed to read file.';
                document.getElementById('importStatus').className = 'scan-status error';
            };
            reader.readAsText(file);
        }

        function buildMappingUI(headers, rows) {
            const container = document.getElementById('importMappingRows');
            container.innerHTML = '';

            headers.forEach(csvHeader => {
                const sample = rows.slice(0, 3).map(r => r[csvHeader]).filter(Boolean).join(', ');
                const row = document.createElement('div');
                row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-primary,#e2e8f0);flex-wrap:wrap;';
                row.innerHTML = `
                    <div style="flex:1;min-width:120px;">
                        <div style="font-size:13px;font-weight:600;color:var(--text-primary,#0f172a);">${csvHeader}</div>
                        <div style="font-size:11px;color:var(--text-tertiary,#94a3b8);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:160px;" title="${sample}">e.g. ${sample || '(empty)'}</div>
                    </div>
                    <div style="font-size:12px;color:var(--text-tertiary,#94a3b8);">→</div>
                    <select class="form-input import-map-select" data-csv-header="${csvHeader}" style="flex:1;min-width:140px;padding:8px 10px;font-size:13px;border-radius:8px;">
                        ${IMPORT_FIELDS.map(f =>
                            `<option value="${f.key}" ${importColumnMap[csvHeader] === f.key ? 'selected' : ''}>${f.label}</option>`
                        ).join('')}
                    </select>
                `;
                container.appendChild(row);
            });

            // Listen for mapping changes
            container.querySelectorAll('.import-map-select').forEach(sel => {
                sel.addEventListener('change', function() {
                    importColumnMap[this.dataset.csvHeader] = this.value;
                });
            });

            // Preview count & dupe check
            document.getElementById('importPreviewCount').textContent = rows.length;
            const existingNames = new Set(inventory.map(i => i.name.toLowerCase().trim()));
            const dupes = rows.filter(r => {
                const nameCol = Object.keys(importColumnMap).find(k => importColumnMap[k] === 'name');
                return nameCol && existingNames.has((r[nameCol] || '').toLowerCase().trim());
            });
            if (dupes.length > 0) {
                document.getElementById('importDupeWarning').style.display = 'inline';
                document.getElementById('importDupeCount').textContent = dupes.length;
            } else {
                document.getElementById('importDupeWarning').style.display = 'none';
            }
        }

        function confirmImport() {
            if (importParsedRows.length === 0) return;

            // Build reverse map: our field -> csv column
            const fieldToCSV = {};
            for (const [csvCol, ourField] of Object.entries(importColumnMap)) {
                if (ourField !== '_skip' && !fieldToCSV[ourField]) {
                    fieldToCSV[ourField] = csvCol;
                }
            }

            // Validate: must have at least a name mapping
            if (!fieldToCSV.name) {
                document.getElementById('importStatus').textContent = '❌ You must map at least one column to "Item Name"';
                document.getElementById('importStatus').className = 'scan-status error';
                return;
            }

            const validStatuses = ['Listed', 'Sold', 'Shipped', 'Returned', 'Lost/Damaged', 'Unlisted'];
            let imported = 0;
            let skipped = 0;

            importParsedRows.forEach(row => {
                const name = (row[fieldToCSV.name] || '').trim();
                if (!name) { skipped++; return; }

                function getVal(field) { return fieldToCSV[field] ? (row[fieldToCSV[field]] || '').trim() : ''; }
                function getNum(field) {
                    const v = getVal(field);
                    const n = parseFloat(v.replace(/[$,]/g, ''));
                    return isNaN(n) ? 0 : n;
                }
                function getNumOrNull(field) {
                    const v = getVal(field);
                    if (!v) return null;
                    const n = parseFloat(v.replace(/[$,]/g, ''));
                    return isNaN(n) ? null : n;
                }

                const purchase = getNum('purchase');
                const purchaseShipping = getNum('purchaseShipping');
                const sale = getNumOrNull('sale');
                const outboundShipping = getNum('outboundShipping');
                const packaging = getNum('packaging');
                const platformFees = getNum('platformFees');
                const taxReserve = getNum('taxReserve');
                const profit = sale !== null ? sale - purchase - purchaseShipping - outboundShipping - packaging - platformFees - taxReserve : null;

                let status = getVal('status') || 'Listed';
                if (!validStatuses.includes(status)) {
                    // Try to match loosely
                    const sl = status.toLowerCase();
                    if (sl.includes('sold')) status = 'Sold';
                    else if (sl.includes('ship')) status = 'Shipped';
                    else if (sl.includes('return')) status = 'Returned';
                    else if (sl.includes('lost') || sl.includes('damage')) status = 'Lost/Damaged';
                    else if (sl.includes('unlist')) status = 'Unlisted';
                    else status = 'Listed';
                }

                let dateSold = null;
                const ds = getVal('dateSold');
                if (ds) {
                    const parsed = new Date(ds);
                    if (!isNaN(parsed.getTime())) dateSold = parsed;
                }

                const item = {
                    name: name,
                    sku: getVal('sku') || generateImportSKU(getVal('category') || 'IMP'),
                    qty: parseInt(getVal('qty')) || 1,
                    category: getVal('category') || 'Other',
                    source: getVal('source') || '',
                    purchase: purchase,
                    purchaseShipping: purchaseShipping,
                    sale: sale,
                    outboundShipping: outboundShipping,
                    packaging: packaging,
                    profit: profit,
                    platformFees: platformFees,
                    taxReserve: taxReserve,
                    platform: getVal('platform') || null,
                    status: status,
                    days: status === 'Sold' ? 0 : parseInt(getVal('days')) || 0,
                    dateSold: dateSold,
                    photos: []
                };

                inventory.push(item);
                imported++;
            });

            // Save and refresh
            saveToStorage();
            init();

            document.getElementById('importStatus').textContent = `✅ Imported ${imported} items` + (skipped > 0 ? ` (${skipped} skipped — no name)` : '');
            document.getElementById('importStatus').className = 'scan-status found';
            document.getElementById('importActions').style.display = 'none';
            document.getElementById('importMappingArea').style.display = 'none';

            // Auto-close after a moment
            setTimeout(closeImportModal, 2000);
        }
        window.confirmImport = confirmImport;

        function generateImportSKU(category) {
            const prefix = (category || 'IMP').substring(0, 3).toUpperCase();
            const random = Math.floor(Math.random() * 9000) + 1000;
            return prefix + '-' + random;
        }

        function closeImportModal() {
            document.getElementById('importOverlay').style.display = 'none';
            importParsedRows = [];
            importColumnMap = {};
            // Reset file input so the same file can be re-selected
            document.getElementById('csvFileInput').value = '';
        }
        window.closeImportModal = closeImportModal;

        function init() {
            updateVehicleExpenseSummary();
            renderInventory();
            renderGallery();
            renderPlatforms();
            populateCategories();
            updateStats();
            updatePlatformDropdowns();
            renderWeeklyAnalytics();
            renderMonthlyAnalytics();
            renderCategoriesAnalytics();
            renderTasks();
            renderExpenses();
            renderMileage();
            checkStaleItems();
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function switchPeriod(period) {
            currentPeriod = period;
            
            // Hide all breakdowns
            document.getElementById('weeklyBreakdown').style.display = 'none';
            document.getElementById('monthlyBreakdown').style.display = 'none';
            document.getElementById('categoriesBreakdown').style.display = 'none';
            
            // Reset all buttons to secondary
            document.getElementById('weeklyBtn').className = 'btn btn-secondary';
            document.getElementById('monthlyBtn').className = 'btn btn-secondary';
            document.getElementById('categoriesBtn').className = 'btn btn-secondary';
            
            // Show selected breakdown and highlight button
            if (period === 'weekly') {
                document.getElementById('weeklyBreakdown').style.display = 'block';
                document.getElementById('weeklyBtn').className = 'btn btn-primary';
            } else if (period === 'monthly') {
                document.getElementById('monthlyBreakdown').style.display = 'block';
                document.getElementById('monthlyBtn').className = 'btn btn-primary';
            } else if (period === 'categories') {
                document.getElementById('categoriesBreakdown').style.display = 'block';
                document.getElementById('categoriesBtn').className = 'btn btn-primary';
                renderCategoriesAnalytics();
            }
        }

        function renderWeeklyAnalytics() {
            const soldItems = inventory.filter(item => item.status === 'Sold' && item.dateSold);
            
            // Get current week data
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            weekStart.setHours(0, 0, 0, 0);
            
            const thisWeekItems = soldItems.filter(item => {
                return item.dateSold >= weekStart;
            });
            
            const thisWeekRevenue = thisWeekItems.reduce((sum, item) => sum + (item.sale || 0), 0);
            const thisWeekAvg = thisWeekItems.length > 0 ? thisWeekRevenue / thisWeekItems.length : 0;
            
            document.getElementById('thisWeekRevenue').textContent = '$' + thisWeekRevenue.toFixed(0);
            document.getElementById('thisWeekItems').textContent = thisWeekItems.length;
            document.getElementById('thisWeekAvg').textContent = '$' + thisWeekAvg.toFixed(0);
            
            // Day breakdown (last 7 days)
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayData = {};
            
            days.forEach(day => {
                dayData[day] = { items: 0, revenue: 0, profit: 0 };
            });
            
            soldItems.forEach(item => {
                if (item.dateSold) {
                    const dayName = days[item.dateSold.getDay()];
                    dayData[dayName].items++;
                    dayData[dayName].revenue += item.sale || 0;
                    dayData[dayName].profit += item.profit || 0;
                }
            });
            
            const tbody = document.getElementById('weeklyBody');
            tbody.innerHTML = '';
            
            days.forEach(day => {
                const data = dayData[day];
                const avgProfit = data.items > 0 ? data.profit / data.items : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${day}</td>
                    <td>${data.items}</td>
                    <td class="price">$${data.revenue.toFixed(2)}</td>
                    <td class="profit-positive">$${data.profit.toFixed(2)}</td>
                    <td>$${avgProfit.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Best days
            const bestDays = Object.entries(dayData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 3);
            
            const bestDaysBody = document.getElementById('bestDaysBody');
            bestDaysBody.innerHTML = '';
            
            bestDays.forEach(([day, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${day}</td>
                    <td class="price">$${data.revenue.toFixed(2)}</td>
                    <td>${data.items}</td>
                `;
                bestDaysBody.appendChild(row);
            });
            
            // Selling times (mock data for demo)
            document.getElementById('morningCount').textContent = Math.floor(thisWeekItems.length * 0.25) + ' sales';
            document.getElementById('afternoonCount').textContent = Math.floor(thisWeekItems.length * 0.35) + ' sales';
            document.getElementById('eveningCount').textContent = Math.floor(thisWeekItems.length * 0.30) + ' sales';
            document.getElementById('nightCount').textContent = Math.floor(thisWeekItems.length * 0.10) + ' sales';
        }

        function renderMonthlyAnalytics() {
            const soldItems = inventory.filter(item => item.status === 'Sold' && item.dateSold);
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            
            const monthData = {};
            months.forEach(month => {
                monthData[month] = { items: 0, revenue: 0, profit: 0 };
            });
            
            soldItems.forEach(item => {
                if (item.dateSold) {
                    const monthName = months[item.dateSold.getMonth()];
                    monthData[monthName].items++;
                    monthData[monthName].revenue += item.sale || 0;
                    monthData[monthName].profit += item.profit || 0;
                }
            });
            
            // Current month stats
            const now = new Date();
            const currentMonthName = months[now.getMonth()];
            const currentMonth = monthData[currentMonthName];
            
            document.getElementById('thisMonthRevenue').textContent = '$' + currentMonth.revenue.toFixed(0);
            document.getElementById('thisMonthItems').textContent = currentMonth.items;
            
            // Find best month
            const bestMonth = Object.entries(monthData)
                .sort((a, b) => b[1].revenue - a[1].revenue)[0];
            document.getElementById('bestMonth').textContent = bestMonth ? bestMonth[0] : '-';
            
            // Render monthly table
            const tbody = document.getElementById('monthlyBody');
            tbody.innerHTML = '';
            
            let prevRevenue = 0;
            months.forEach(month => {
                const data = monthData[month];
                const avgProfit = data.items > 0 ? data.profit / data.items : 0;
                const growth = prevRevenue > 0 ? ((data.revenue - prevRevenue) / prevRevenue * 100) : 0;
                const growthClass = growth > 0 ? 'profit-positive' : growth < 0 ? 'profit-negative' : '';
                const growthSymbol = growth > 0 ? '↑' : growth < 0 ? '↓' : '→';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month}</td>
                    <td>${data.items}</td>
                    <td class="price">$${data.revenue.toFixed(2)}</td>
                    <td class="profit-positive">$${data.profit.toFixed(2)}</td>
                    <td>$${avgProfit.toFixed(2)}</td>
                    <td class="${growthClass}">${data.revenue > 0 ? growthSymbol + ' ' + Math.abs(growth).toFixed(1) + '%' : '-'}</td>
                `;
                tbody.appendChild(row);
                
                if (data.revenue > 0) prevRevenue = data.revenue;
            });
            
            // Year totals
            const yearRevenue = soldItems.reduce((sum, item) => sum + (item.sale || 0), 0);
            const yearProfit = soldItems.reduce((sum, item) => sum + (item.profit || 0), 0);
            const monthsWithSales = Object.values(monthData).filter(m => m.revenue > 0).length;
            const avgMonthly = monthsWithSales > 0 ? yearRevenue / monthsWithSales : 0;
            
            document.getElementById('yearRevenue').textContent = '$' + yearRevenue.toFixed(2);
            document.getElementById('yearProfit').textContent = '$' + yearProfit.toFixed(2);
            document.getElementById('avgMonthlyRevenue').textContent = '$' + avgMonthly.toFixed(2);
            document.getElementById('yearItems').textContent = soldItems.length;
            
            // Category performance
            const categoryData = {};
            soldItems.forEach(item => {
                if (!categoryData[item.category]) {
                    categoryData[item.category] = { items: 0, revenue: 0 };
                }
                categoryData[item.category].items++;
                categoryData[item.category].revenue += item.sale || 0;
            });
            
            const topCategories = Object.entries(categoryData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            const categoryBody = document.getElementById('categoryBody');
            categoryBody.innerHTML = '';
            
            topCategories.forEach(([category, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category}</td>
                    <td>${data.items}</td>
                    <td class="price">$${data.revenue.toFixed(2)}</td>
                `;
                categoryBody.appendChild(row);
            });
        }

        function renderCategoriesAnalytics() {
            // Collect all categories
            const categoryStats = {};
            
            inventory.forEach(item => {
                if (!categoryStats[item.category]) {
                    categoryStats[item.category] = {
                        total: 0,
                        sold: 0,
                        listed: 0,
                        revenue: 0,
                        profit: 0,
                        totalCost: 0,
                        days: []
                    };
                }
                
                const cat = categoryStats[item.category];
                cat.total++;
                
                if (item.status === 'Sold') {
                    cat.sold++;
                    cat.revenue += item.sale || 0;
                    cat.profit += item.profit || 0;
                    cat.totalCost += item.purchase || 0;
                    if (item.days) cat.days.push(item.days);
                } else if (item.status === 'Listed') {
                    cat.listed++;
                }
            });
            
            // Summary stats
            const totalCategories = Object.keys(categoryStats).length;
            const bestPerformer = Object.entries(categoryStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)[0];
            
            const categoriesWithROI = Object.entries(categoryStats)
                .filter(([_, data]) => data.totalCost > 0)
                .map(([name, data]) => ({
                    name,
                    roi: (data.profit / data.totalCost) * 100
                }))
                .sort((a, b) => b.roi - a.roi);
            
            const allDays = Object.values(categoryStats).flatMap(cat => cat.days);
            const avgDays = allDays.length > 0 ? allDays.reduce((a, b) => a + b, 0) / allDays.length : 0;
            
            document.getElementById('totalCategories').textContent = totalCategories;
            document.getElementById('bestCategory').textContent = bestPerformer ? bestPerformer[0] : '-';
            document.getElementById('bestROI').textContent = categoriesWithROI.length > 0 
                ? categoriesWithROI[0].name : '-';
            document.getElementById('avgSellTime').textContent = avgDays.toFixed(0) + 'd';
            
            // Main table
            const tbody = document.getElementById('categoriesTableBody');
            tbody.innerHTML = '';
            
            Object.entries(categoryStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .forEach(([category, data]) => {
                    const sellThrough = data.total > 0 ? (data.sold / data.total * 100) : 0;
                    const avgROI = data.totalCost > 0 ? (data.profit / data.totalCost * 100) : 0;
                    const avgDays = data.days.length > 0 ? data.days.reduce((a, b) => a + b, 0) / data.days.length : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight: 600;">${category}</td>
                        <td>${data.total}</td>
                        <td class="profit-positive">${data.sold}</td>
                        <td class="price">${data.listed}</td>
                        <td>${sellThrough.toFixed(1)}%</td>
                        <td class="price">$${data.revenue.toFixed(2)}</td>
                        <td class="profit-positive">$${data.profit.toFixed(2)}</td>
                        <td class="${avgROI > 50 ? 'profit-positive' : ''}">${avgROI.toFixed(1)}%</td>
                        <td>${avgDays > 0 ? avgDays.toFixed(0) + 'd' : '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            
            // Top categories chart
            const topCategories = Object.entries(categoryStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            const maxRevenue = topCategories[0] ? topCategories[0][1].revenue : 1;
            
            const chartDiv = document.getElementById('topCategoriesChart');
            chartDiv.innerHTML = '';
            
            topCategories.forEach(([category, data]) => {
                const percentage = (data.revenue / maxRevenue) * 100;
                const barDiv = document.createElement('div');
                barDiv.style.marginBottom = '20px';
                barDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">${category}</span>
                        <span style="color: var(--success);">$${data.revenue.toFixed(2)}</span>
                    </div>
                    <div style="width: 100%; height: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.5s ease;"></div>
                    </div>
                `;
                chartDiv.appendChild(barDiv);
            });
            
            // Quick stats
            const mostListed = Object.entries(categoryStats)
                .sort((a, b) => b[1].total - a[1].total)[0];
            document.getElementById('mostListed').textContent = mostListed ? mostListed[0] : '-';
            
            const fastestSelling = Object.entries(categoryStats)
                .filter(([_, data]) => data.days.length > 0)
                .map(([name, data]) => ({
                    name,
                    avgDays: data.days.reduce((a, b) => a + b, 0) / data.days.length
                }))
                .sort((a, b) => a.avgDays - b.avgDays)[0];
            document.getElementById('fastestSelling').textContent = fastestSelling 
                ? `${fastestSelling.name} (${fastestSelling.avgDays.toFixed(0)}d)` : '-';
            
            const highestPrice = Object.entries(categoryStats)
                .filter(([_, data]) => data.sold > 0)
                .map(([name, data]) => ({
                    name,
                    avgPrice: data.revenue / data.sold
                }))
                .sort((a, b) => b.avgPrice - a.avgPrice)[0];
            document.getElementById('highestPrice').textContent = highestPrice 
                ? `${highestPrice.name} ($${highestPrice.avgPrice.toFixed(0)})` : '-';
            
            const mostProfitable = inventory
                .filter(item => item.status === 'Sold')
                .sort((a, b) => (b.profit || 0) - (a.profit || 0))[0];
            document.getElementById('mostProfitableItem').textContent = mostProfitable 
                ? `${mostProfitable.name} ($${mostProfitable.profit.toFixed(0)})` : '-';
            
            const categoriesWithStock = Object.values(categoryStats)
                .filter(data => data.listed > 0).length;
            document.getElementById('categoriesWithStock').textContent = categoriesWithStock;
            
            // Category trends over time
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const categoryTrends = {};
            
            inventory.filter(item => item.status === 'Sold' && item.dateSold).forEach(item => {
                if (!categoryTrends[item.category]) {
                    categoryTrends[item.category] = { Jan: 0, Feb: 0, Mar: 0, Apr: 0, May: 0, Jun: 0 };
                }
                const monthName = months[item.dateSold.getMonth()];
                if (monthName) categoryTrends[item.category][monthName]++;
            });
            
            const trendsBody = document.getElementById('categoryTrendsBody');
            trendsBody.innerHTML = '';
            
            Object.entries(categoryTrends)
                .sort((a, b) => {
                    const aTotal = Object.values(a[1]).reduce((sum, val) => sum + val, 0);
                    const bTotal = Object.values(b[1]).reduce((sum, val) => sum + val, 0);
                    return bTotal - aTotal;
                })
                .slice(0, 8)
                .forEach(([category, monthData]) => {
                    const values = months.map(m => monthData[m]);
                    const trend = values[values.length - 1] > values[0] ? '📈' : 
                                 values[values.length - 1] < values[0] ? '📉' : '➡️';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight: 600;">${category}</td>
                        ${months.map(m => `<td>${monthData[m] || '-'}</td>`).join('')}
                        <td style="font-size: 1.2em;">${trend}</td>
                    `;
                    trendsBody.appendChild(row);
                });
        }

        function getSortedIndices() {
            // Build array of [originalIndex, item] then sort, return indices
            const indices = inventory.map((item, i) => i);
            
            if (!sortColumn) return indices;
            
            const getValue = (item) => {
                const cost = (item.purchase || 0) + (item.purchaseShipping || 0);
                const fees = (item.platformFees || 0) + (item.outboundShipping || 0) + (item.packaging || 0);
                switch (sortColumn) {
                    case 'name': return (item.name || '').toLowerCase();
                    case 'qty': return item.qty || 1;
                    case 'category': return (item.category || '').toLowerCase();
                    case 'cost': return cost;
                    case 'sale': return item.sale || 0;
                    case 'fees': return fees;
                    case 'profit': return item.profit || 0;
                    case 'tax': return item.taxReserve || 0;
                    case 'platform': return (item.platform || '').toLowerCase();
                    case 'status': return item.status || '';
                    default: return 0;
                }
            };
            
            indices.sort((a, b) => {
                const va = getValue(inventory[a]);
                const vb = getValue(inventory[b]);
                let cmp = 0;
                if (typeof va === 'string') {
                    cmp = va.localeCompare(vb);
                } else {
                    cmp = va - vb;
                }
                return sortDirection === 'desc' ? -cmp : cmp;
            });
            
            return indices;
        }

        function sortInventory(column) {
            if (sortColumn === column) {
                // Toggle direction
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update header arrows
            document.querySelectorAll('#inventoryTable th.sortable').forEach(th => {
                th.classList.remove('sort-active', 'sort-desc');
            });
            const activeHeaders = document.querySelectorAll('#inventoryTable th.sortable');
            activeHeaders.forEach(th => {
                if (th.getAttribute('onclick') && th.getAttribute('onclick').includes("'" + column + "'")) {
                    th.classList.add('sort-active');
                    if (sortDirection === 'desc') th.classList.add('sort-desc');
                }
            });
            
            // Clear selection since indices change visually
            selectedItems.clear();
            updateBulkBar();
            const cb = document.getElementById('selectAllCb');
            if (cb) { cb.checked = false; cb.indeterminate = false; }
            
            renderInventory();
            if (currentView === 'grid') renderGallery();
        }
        window.sortInventory = sortInventory;

        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            const sortedIndices = getSortedIndices();
            
            sortedIndices.forEach((index) => {
                const item = inventory[index];
                const row = document.createElement('tr');
                const statusClass = item.status.toLowerCase().replace(/[\/\s]/g, '-');
                const profitClass = item.profit > 0 ? 'profit-positive' : item.profit < 0 ? 'profit-negative' : '';
                
                const totalCost = (item.purchase || 0) + (item.purchaseShipping || 0);
                const totalFees = (item.platformFees || 0) + (item.outboundShipping || 0) + (item.packaging || 0);
                
                const isSelected = selectedItems.has(index);
                if (isSelected) row.classList.add('row-selected');
                
                // Create photo thumbnails
                let photoHTML = '';
                if (item.photos && item.photos.length > 0) {
                    photoHTML = '<div class="item-photo-gallery">';
                    item.photos.slice(0, 3).forEach(photo => {
                        photoHTML += `<img src="${photo}" class="item-photo-thumb" onclick="viewItemPhotos(${index})" title="Click to view all photos">`;
                    });
                    if (item.photos.length > 3) {
                        photoHTML += `<span style="font-size: 12px; color: var(--primary);">+${item.photos.length - 3}</span>`;
                    }
                    photoHTML += '</div>';
                } else {
                    photoHTML = '<span style="opacity: 0.5; font-size: 12px;">No photos</span>';
                }
                
                row.innerHTML = `
                    <td style="width:36px;" onclick="event.stopPropagation();">
                        <input type="checkbox" style="width:16px;height:16px;accent-color:var(--indigo-600);cursor:pointer;" ${isSelected ? 'checked' : ''} onchange="toggleItemSelect(${index}, this.checked)">
                    </td>
                    <td>${photoHTML}</td>
                    <td>${item.name}</td>
                    <td onclick="event.stopPropagation();">
                        <div class="qty-stepper">
                            <button onclick="adjustQty(${index}, -1)">−</button>
                            <span data-qty-idx="${index}">${item.qty || 1}</span>
                            <button onclick="adjustQty(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td>${item.category}</td>
                    <td class="price" title="Purchase: $${item.purchase || 0} + Shipping: $${item.purchaseShipping || 0}">$${totalCost.toFixed(2)}</td>
                    <td class="price">${item.sale ? '$' + item.sale : '-'}</td>
                    <td title="Platform: $${(item.platformFees || 0).toFixed(2)} + Shipping: $${item.outboundShipping || 0} + Packaging: $${item.packaging || 0}">$${totalFees.toFixed(2)}</td>
                    <td class="${profitClass}">${item.profit ? '$' + item.profit.toFixed(2) : '-'}</td>
                    <td>${item.taxReserve ? '$' + item.taxReserve.toFixed(2) : '-'}</td>
                    <td>${item.platform || '-'}</td>
                    <td><span class="status-badge status-${statusClass}">${item.status}</span></td>
                `;
                row.onclick = (e) => {
                    if (!e.target.classList.contains('item-photo-thumb') && e.target.type !== 'checkbox') {
                        openEditModal(index);
                    }
                };
                tbody.appendChild(row);
            });
        }

        function adjustQty(index, delta) {
            const item = inventory[index];
            item.qty = Math.max(0, (item.qty || 1) + delta);
            // Update in-place — find all steppers for this index and update the span
            document.querySelectorAll(`[data-qty-idx="${index}"]`).forEach(span => {
                span.textContent = item.qty;
            });
            updateStats();
            saveToStorage();
        }
        window.adjustQty = adjustQty;

        function renderPlatforms() {
            const tbody = document.getElementById('platformsBody');
            tbody.innerHTML = '';
            
            platforms.forEach((platform, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${platform.name}</td>
                    <td>${platform.feePercent}%</td>
                    <td>$${platform.fixedFee.toFixed(2)}</td>
                    <td>${platform.avgDays || '-'} days</td>
                    <td>${(platform.successRate * 100).toFixed(0)}%</td>
                    <td>${platform.totalSales}</td>
                `;
                row.onclick = () => openEditPlatformModal(index);
                tbody.appendChild(row);
            });
        }

        function populateCategories() {
            const categories = [...new Set(inventory.map(item => item.category))].sort();
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            
            // Populate platform filter
            const platNames = [...new Set(inventory.map(item => item.platform).filter(Boolean))].sort();
            const platSelect = document.getElementById('platformFilter');
            platSelect.innerHTML = '<option value="">All Platforms</option>';
            platNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                platSelect.appendChild(option);
            });
        }

        function updateStats() {
            const sold = inventory.filter(i => i.status === 'Sold');
            const listed = inventory.filter(i => i.status === 'Listed');
            const totalRevenue = sold.reduce((sum, i) => sum + (i.sale || 0), 0);
            const totalProfit = sold.reduce((sum, i) => sum + (i.profit || 0), 0);
            const totalTaxReserve = sold.reduce((sum, i) => sum + (i.taxReserve || 0), 0);
            const totalCost = sold.reduce((sum, i) => sum + ((i.purchase || 0) + (i.purchaseShipping || 0)), 0);

            // Separate mileage from other expenses to avoid double-counting
            const mileageDeduction = mileageTrips.reduce((s, t) => s + (t.deduction || 0), 0);
            const nonMileageExpenses = expenses.filter(e => e.id !== 'auto_vehicle_expense').reduce((s, e) => s + (e.amount || 0), 0);
            
            // Net Profit = item profits - non-mileage expenses - mileage deduction
            const adjustedProfit = totalProfit - nonMileageExpenses - mileageDeduction;
            const roi = totalCost > 0 ? ((adjustedProfit / totalCost) * 100) : 0;
            
            document.getElementById('itemsSold').textContent = sold.length;
            document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString();
            document.getElementById('netProfit').textContent = (adjustedProfit >= 0 ? '$' : '-$') + Math.abs(adjustedProfit).toFixed(0);
            document.getElementById('netProfit').style.color = adjustedProfit >= 0 ? '' : 'var(--rose-500)';
            document.getElementById('netProfitChange').textContent = (roi >= 0 ? '↑ ' : '↓ ') + Math.abs(roi).toFixed(1) + '% ROI (after expenses + mileage)';
            document.getElementById('netProfitChange').className = 'stat-change ' + (adjustedProfit >= 0 ? 'positive' : 'negative');
            document.getElementById('taxReserveTotal').textContent = '$' + totalTaxReserve.toFixed(0);

            // Update mileage deduction stat card
            document.getElementById('mileageDeductionStat').textContent = '$' + mileageDeduction.toFixed(0);
            document.getElementById('mileageDeductionSub').textContent = mileageTrips.length + ' trips · $' + IRS_MILEAGE_RATE.toFixed(2) + '/mi';
        }

        // ── Bridge mileage → expenses: auto-sync Vehicle Expenses entry ──
        function updateVehicleExpenseSummary() {
            const mileageDeduction = mileageTrips.reduce((s, t) => s + (t.deduction || 0), 0);
            const totalMiles = mileageTrips.reduce((s, t) => s + (t.miles || 0), 0);
            const tripCount = mileageTrips.length;

            // Find or create the auto-managed "Vehicle Expenses" recurring entry
            const VEHICLE_EXPENSE_ID = 'auto_vehicle_expense';
            let existing = expenses.find(e => e.id === VEHICLE_EXPENSE_ID);

            if (tripCount === 0) {
                // No trips — remove the auto entry if it exists
                if (existing) {
                    expenses = expenses.filter(e => e.id !== VEHICLE_EXPENSE_ID);
                }
                return;
            }

            const today = new Date();
            const dateStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

            if (existing) {
                // Update in place
                existing.amount = mileageDeduction;
                existing.date = dateStr;
                existing.description = 'Vehicle Expenses — ' + tripCount + ' trips, ' + totalMiles.toFixed(1) + ' mi';
                existing.notes = 'Auto-updated from Mileage Log · ' + totalMiles.toFixed(1) + ' miles × $' + IRS_MILEAGE_RATE.toFixed(2) + '/mi';
            } else {
                // Create new
                expenses.push({
                    id: VEHICLE_EXPENSE_ID,
                    date: dateStr,
                    description: 'Vehicle Expenses — ' + tripCount + ' trips, ' + totalMiles.toFixed(1) + ' mi',
                    category: 'Gas / Mileage',
                    amount: mileageDeduction,
                    recurring: 'auto',
                    notes: 'Auto-updated from Mileage Log · ' + totalMiles.toFixed(1) + ' miles × $' + IRS_MILEAGE_RATE.toFixed(2) + '/mi'
                });
            }
        }

        function updatePlatformDropdowns() {
            const platformSelect = document.getElementById('platform');
            platformSelect.innerHTML = '<option value="">Not Listed Yet</option>';
            
            platforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform.name;
                option.textContent = platform.name;
                platformSelect.appendChild(option);
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const platformFilter = document.getElementById('platformFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const rows = document.querySelectorAll('#inventoryBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const category = row.cells[3] ? row.cells[3].textContent : '';
                const platform = row.cells[9] ? row.cells[9].textContent.trim() : '';
                const status = row.cells[10] ? row.cells[10].textContent : '';
                
                const matchesSearch = text.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;
                const matchesPlatform = !platformFilter || platform === platformFilter;
                const matchesStatus = !statusFilter || status.includes(statusFilter);
                
                row.style.display = matchesSearch && matchesCategory && matchesPlatform && matchesStatus ? '' : 'none';
            });
        }

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            window._pushTabState && _pushTabState(tabName);
        }

        // Item Modal Functions
        function openModal() {
            editingIndex = null;
            pendingPhotos = [];
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('modalTitle').textContent = 'Add New Item';
            document.getElementById('submitBtn').textContent = 'Add Item';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('barcodeBtn').style.display = 'none';
            document.getElementById('itemForm').reset();
            document.getElementById('taxReserve').value = 'Auto-calculated';
            document.getElementById('itemModal').classList.add('active');
            window._pushModalState && _pushModalState('itemModal');
            
            // Init drag-drop zone
            setTimeout(initPhotoDropZone, 50);
            
            // Add event listener for dynamic tax calculation
            setupTaxCalculation();
        }
        window.openModal = openModal;

        function setupTaxCalculation() {
            const fields = ['salePrice', 'purchasePrice', 'purchaseShipping', 'outboundShipping', 'packagingCosts'];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', calculateTaxPreview);
                }
            });
            
            document.getElementById('platform').addEventListener('change', calculateTaxPreview);
            
            // Auto-fill date sold when status switches to "Sold"
            document.getElementById('status').addEventListener('change', function() {
                const dateSoldInput = document.getElementById('dateSold');
                if (this.value === 'Sold' && !dateSoldInput.value) {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    dateSoldInput.value = `${yyyy}-${mm}-${dd}`;
                } else if (this.value !== 'Sold') {
                    dateSoldInput.value = '';
                }
            });
        }

        function calculateTaxPreview() {
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const purchaseShipping = parseFloat(document.getElementById('purchaseShipping').value) || 0;
            const outboundShipping = parseFloat(document.getElementById('outboundShipping').value) || 0;
            const packagingCosts = parseFloat(document.getElementById('packagingCosts').value) || 0;
            const platformName = document.getElementById('platform').value;
            
            if (!salePrice) {
                document.getElementById('taxReserve').value = 'Auto-calculated';
                return;
            }
            
            let platformFees = 0;
            if (platformName) {
                const platform = platforms.find(p => p.name === platformName);
                if (platform) {
                    platformFees = (salePrice * (platform.feePercent / 100)) + platform.fixedFee;
                } else {
                    platformFees = salePrice * 0.1;
                }
            } else {
                platformFees = salePrice * 0.1;
            }
            
            const totalCost = purchasePrice + purchaseShipping;
            const profit = salePrice - totalCost - platformFees - outboundShipping - packagingCosts;
            
            if (profit > 0) {
                const taxReserve = profit * 0.153;
                document.getElementById('taxReserve').value = '$' + taxReserve.toFixed(2) + ' (15.3% of profit)';
            } else {
                document.getElementById('taxReserve').value = '$0.00 (no profit)';
            }
        }

        function openEditModal(index) {
            editingIndex = index;
            const item = inventory[index];
            
            document.getElementById('modalTitle').textContent = 'Edit Item';
            document.getElementById('submitBtn').textContent = 'Update Item';
            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('barcodeBtn').style.display = 'block';
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemSKU').value = item.sku || '';
            document.getElementById('itemQty').value = item.qty || 1;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemSource').value = item.source || '';
            document.getElementById('purchasePrice').value = item.purchase;
            document.getElementById('purchaseShipping').value = item.purchaseShipping || 0;
            document.getElementById('salePrice').value = item.sale || '';
            document.getElementById('outboundShipping').value = item.outboundShipping || 0;
            document.getElementById('packagingCosts').value = item.packaging || 0;
            document.getElementById('platform').value = item.platform || '';
            document.getElementById('status').value = item.status;
            
            // Populate date sold picker
            if (item.dateSold) {
                const d = item.dateSold instanceof Date ? item.dateSold : new Date(item.dateSold);
                if (!isNaN(d.getTime())) {
                    const yyyy = d.getFullYear();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    document.getElementById('dateSold').value = `${yyyy}-${mm}-${dd}`;
                } else {
                    document.getElementById('dateSold').value = '';
                }
            } else {
                document.getElementById('dateSold').value = '';
            }
            
            if (item.taxReserve) {
                document.getElementById('taxReserve').value = '$' + item.taxReserve.toFixed(2);
            } else {
                document.getElementById('taxReserve').value = 'Auto-calculated';
            }
            
            document.getElementById('itemModal').classList.add('active');
            window._pushModalState && _pushModalState('itemModal');
            setupTaxCalculation();

            // Load existing photos into pendingPhotos for preview
            pendingPhotos = item.photos ? [...item.photos] : [];
            renderPhotoPreviews();

            // Init drag-drop zone
            setTimeout(initPhotoDropZone, 50);
        }

        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
            document.getElementById('itemForm').reset();
            editingIndex = null;
        }

        function saveItem(event) {
            event.preventDefault();
            
            const salePrice = parseFloat(document.getElementById('salePrice').value) || null;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            const purchaseShipping = parseFloat(document.getElementById('purchaseShipping').value) || 0;
            const outboundShipping = parseFloat(document.getElementById('outboundShipping').value) || 0;
            const packagingCosts = parseFloat(document.getElementById('packagingCosts').value) || 0;
            const platformName = document.getElementById('platform').value;
            const status = document.getElementById('status').value;
            let sku = document.getElementById('itemSKU').value.trim();
            
            // Auto-generate SKU if empty
            if (!sku) {
                const category = document.getElementById('itemCategory').value || 'ITEM';
                const prefix = category.substring(0, 3).toUpperCase();
                const random = Math.floor(Math.random() * 9000) + 1000;
                sku = `${prefix}-${random}`;
            }
            
            let profit = null;
            let platformFees = 0;
            let taxReserve = 0;
            let totalCost = purchasePrice + purchaseShipping;
            
            if (salePrice && platformName) {
                const platform = platforms.find(p => p.name === platformName);
                if (platform) {
                    const percentFee = salePrice * (platform.feePercent / 100);
                    platformFees = percentFee + platform.fixedFee;
                } else {
                    platformFees = salePrice * 0.1;
                }
            } else if (salePrice) {
                platformFees = salePrice * 0.1;
            }
            
            if (salePrice) {
                profit = salePrice - totalCost - platformFees - outboundShipping - packagingCosts;
                
                if (profit > 0) {
                    taxReserve = profit * 0.153;
                }
            }
            
            let dateSold = null;
            const dateSoldVal = document.getElementById('dateSold').value;
            if (dateSoldVal) {
                // User explicitly picked a date
                dateSold = new Date(dateSoldVal + 'T12:00:00');
            } else if (status === 'Sold' && salePrice) {
                // No date picked but status is Sold — default to today
                dateSold = new Date();
            }
            
            const itemData = {
                name: document.getElementById('itemName').value,
                sku: sku,
                qty: parseInt(document.getElementById('itemQty').value) || 1,
                category: document.getElementById('itemCategory').value,
                source: document.getElementById('itemSource').value,
                purchase: purchasePrice,
                purchaseShipping: purchaseShipping,
                sale: salePrice,
                outboundShipping: outboundShipping,
                packaging: packagingCosts,
                profit: profit,
                platformFees: platformFees,
                taxReserve: taxReserve,
                platform: platformName || null,
                status: status,
                days: 0,
                dateSold: dateSold,
                photos: []
            };
            
            // Handle photos from pendingPhotos array (camera + gallery)
            if (pendingPhotos.length > 0) {
                itemData.photos = [...pendingPhotos];
            } else if (editingIndex !== null && inventory[editingIndex].photos) {
                // Editing with no new photos — keep existing
                itemData.photos = inventory[editingIndex].photos;
            }

            const wasEditing = editingIndex !== null; // true if we were editing an existing item

            if (editingIndex !== null) {
                inventory[editingIndex] = itemData;
            } else {
                inventory.unshift(itemData);
                editingIndex = 0;
            }

            renderInventory();
            updateStats();
            renderWeeklyAnalytics();
            renderMonthlyAnalytics();
            renderCategoriesAnalytics();
            saveToStorage();
            updateTaskLinkedItems();

            // Auto-create "List this item" task for newly added OR edited-to-Unlisted items
            const needsListingTask = !['Listed','Sold','Returned','Lost/Damaged'].includes(itemData.status);
            if (needsListingTask) {
                const alreadyHasTask = tasks.some(t =>
                    t.linkedItem === itemData.sku && t.title === 'List item for sale' && t.status !== 'completed'
                );
                if (!alreadyHasTask) {
                    tasks.push({
                        id: 't' + Date.now(),
                        title: 'List item for sale',
                        description: 'Item is in inventory but not yet listed.',
                        linkedItem: itemData.sku,
                        status: 'todo',
                        createdAt: new Date().toISOString()
                    });
                    saveToStorage();
                    renderTasks();
                    if (!wasEditing) toast('📋 Task created: List "' + itemData.name + '"', 'info');
                }
            }

            // Auto-complete "List item for sale" task when item is marked Listed/Sold/etc
            if (['Listed','Sold','Returned','Lost/Damaged'].includes(itemData.status)) {
                let taskCompleted = false;
                tasks.forEach(t => {
                    if (t.linkedItem === itemData.sku && t.title === 'List item for sale' && t.status !== 'completed') {
                        t.status = 'completed';
                        taskCompleted = true;
                    }
                });
                if (taskCompleted) { saveToStorage(); renderTasks(); }
            }

            toast(wasEditing ? 'Item saved!' : 'Item added!');
            pendingPhotos = [];
            closeModal();
        }

        async function deleteItem() {
            if (editingIndex !== null && await confirmAction('Delete this item?')) {
                const deletedSku = inventory[editingIndex].sku;
                inventory.splice(editingIndex, 1);
                // Remove any tasks linked to this item
                const before = tasks.length;
                tasks = tasks.filter(t => t.linkedItem !== deletedSku);
                renderInventory();
                updateStats();
                renderWeeklyAnalytics();
                renderMonthlyAnalytics();
                renderCategoriesAnalytics();
                saveToStorage();
                updateTaskLinkedItems();
                renderTasks();
                closeModal();
                toast('Item deleted');
            }
        }

        // Platform Modal Functions
        function openPlatformModal() {
            editingPlatformIndex = null;
            document.getElementById('platformModalTitle').textContent = 'Add New Platform';
            document.getElementById('platformSubmitBtn').textContent = 'Add Platform';
            document.getElementById('platformDeleteBtn').style.display = 'none';
            document.getElementById('platformForm').reset();
            document.getElementById('platformModal').classList.add('active'); window._pushModalState && _pushModalState('platformModal');
        }

        function openEditPlatformModal(index) {
            editingPlatformIndex = index;
            const platform = platforms[index];
            
            document.getElementById('platformModalTitle').textContent = 'Edit Platform';
            document.getElementById('platformSubmitBtn').textContent = 'Update Platform';
            document.getElementById('platformDeleteBtn').style.display = 'block';
            
            document.getElementById('platformName').value = platform.name;
            document.getElementById('platformFeePercent').value = platform.feePercent;
            document.getElementById('platformFixedFee').value = platform.fixedFee;
            
            document.getElementById('platformModal').classList.add('active'); window._pushModalState && _pushModalState('platformModal');
        }

        function closePlatformModal() {
            document.getElementById('platformModal').classList.remove('active');
            document.getElementById('platformForm').reset();
            editingPlatformIndex = null;
        }

        function savePlatform(event) {
            event.preventDefault();
            
            const platformData = {
                name: document.getElementById('platformName').value,
                feePercent: parseFloat(document.getElementById('platformFeePercent').value),
                fixedFee: parseFloat(document.getElementById('platformFixedFee').value),
                avgDays: 0,
                successRate: 0,
                totalSales: 0
            };
            
            if (editingPlatformIndex !== null) {
                const oldName = platforms[editingPlatformIndex].name;
                platforms[editingPlatformIndex] = {
                    ...platforms[editingPlatformIndex],
                    ...platformData
                };
                
                if (oldName !== platformData.name) {
                    inventory.forEach(item => {
                        if (item.platform === oldName) {
                            item.platform = platformData.name;
                        }
                    });
                    renderInventory();
                }
            } else {
                platforms.push(platformData);
            }
            
            renderPlatforms();
            updatePlatformDropdowns();
            saveToStorage();
            closePlatformModal();
            toast(editingPlatformIndex !== null ? 'Platform updated!' : 'Platform added!');
        }

        async function deletePlatform() {
            if (editingPlatformIndex !== null) {
                const platform = platforms[editingPlatformIndex];
                const itemsUsingPlatform = inventory.filter(item => item.platform === platform.name).length;
                
                if (itemsUsingPlatform > 0) {
                    if (!await confirmAction(`${itemsUsingPlatform} item(s) use this platform. Delete anyway?`)) {
                        return;
                    }
                    inventory.forEach(item => {
                        if (item.platform === platform.name) {
                            item.platform = null;
                        }
                    });
                    renderInventory();
                } else if (!await confirmAction('Delete this platform?')) {
                    return;
                }
                
                platforms.splice(editingPlatformIndex, 1);
                renderPlatforms();
                updatePlatformDropdowns();
                saveToStorage();
                closePlatformModal();
                toast('Platform deleted');
            }
        }

        async function exportData() {
            const useJSON = await confirmAction('Export as JSON (with photos)? Cancel for CSV.');
            if (useJSON) {
                exportJSON();
            } else {
                exportCSV();
            }
        }

        function exportCSV() {
            let csv = 'Item,SKU,Qty,Category,Source,Purchase,Sale,Profit,Platform,Status,Days,PhotoCount\n';
            inventory.forEach(item => {
                const photoCount = (item.photos && item.photos.length) || 0;
                csv += `"${(item.name||'').replace(/"/g,'""')}","${item.sku || ''}",${item.qty || 1},"${item.category || ''}","${item.source || ''}",${item.purchase || 0},${item.sale || ''},${item.profit || ''},"${item.platform || ''}","${item.status || ''}",${item.days || 0},${photoCount}\n`;
            });
            downloadFile(csv, 'inventory_export.csv', 'text/csv');
        }

        function exportJSON() {
            const data = {
                exportDate: new Date().toISOString(),
                version: 1,
                inventory: inventory,
                platforms: platforms,
                expenses: expenses,
                mileage: mileageTrips,
                tasks: tasks
            };
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'inventory_export.json', 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        let currentPhotoIndex = 0;
        let currentPhotoItem = null;

        function viewItemPhotos(index) {
            currentPhotoItem = inventory[index];
            currentPhotoIndex = 0;
            
            if (!currentPhotoItem.photos || currentPhotoItem.photos.length === 0) {
                toast('No photos for this item', 'info');
                return;
            }
            
            document.getElementById('photoModalTitle').textContent = currentPhotoItem.name;
            showPhoto(0);
            document.getElementById('photoModal').classList.add('active'); window._pushModalState && _pushModalState('photoModal');
        }

        function showPhoto(index) {
            if (!currentPhotoItem || !currentPhotoItem.photos) return;
            
            currentPhotoIndex = index;
            document.getElementById('photoViewerMain').src = currentPhotoItem.photos[index];
            
            const thumbContainer = document.getElementById('photoThumbnails');
            thumbContainer.innerHTML = '';
            currentPhotoItem.photos.forEach((photo, i) => {
                const thumb = document.createElement('img');
                thumb.src = photo;
                thumb.style.width = '80px';
                thumb.style.height = '80px';
                thumb.style.objectFit = 'cover';
                thumb.style.borderRadius = '8px';
                thumb.style.cursor = 'pointer';
                thumb.style.border = i === index ? '3px solid var(--primary)' : '2px solid rgba(255,255,255,0.2)';
                thumb.onclick = () => showPhoto(i);
                thumbContainer.appendChild(thumb);
            });
        }

        function nextPhoto() {
            if (!currentPhotoItem || !currentPhotoItem.photos) return;
            const nextIndex = (currentPhotoIndex + 1) % currentPhotoItem.photos.length;
            showPhoto(nextIndex);
        }

        function prevPhoto() {
            if (!currentPhotoItem || !currentPhotoItem.photos) return;
            const prevIndex = (currentPhotoIndex - 1 + currentPhotoItem.photos.length) % currentPhotoItem.photos.length;
            showPhoto(prevIndex);
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
            currentPhotoItem = null;
        }

        async function deleteCurrentPhoto() {
            if (!currentPhotoItem || !currentPhotoItem.photos || currentPhotoItem.photos.length === 0) return;
            
            if (!await confirmAction('Delete this photo?')) return;
            
            // Find the item in inventory
            const itemIndex = inventory.findIndex(item => item.sku === currentPhotoItem.sku);
            if (itemIndex === -1) return;
            
            // Remove the current photo
            inventory[itemIndex].photos.splice(currentPhotoIndex, 1);
            currentPhotoItem.photos.splice(currentPhotoIndex, 1);
            
            // If no photos left, close modal
            if (currentPhotoItem.photos.length === 0) {
                toast('All photos deleted');
                closePhotoModal();
                renderInventory();
                return;
            }
            
            // Adjust index if needed
            if (currentPhotoIndex >= currentPhotoItem.photos.length) {
                currentPhotoIndex = currentPhotoItem.photos.length - 1;
            }
            
            // Refresh the viewer
            showPhoto(currentPhotoIndex);
            renderInventory();
        }
        window.deleteCurrentPhoto = deleteCurrentPhoto;
        
        // Task/Kanban Functions
        function renderTasks() {
            const todoCards = document.getElementById('todoCards');
            const progressCards = document.getElementById('progressCards');
            const completedCards = document.getElementById('completedCards');
            
            todoCards.innerHTML = '';
            progressCards.innerHTML = '';
            completedCards.innerHTML = '';
            
            let todoCnt = 0, progressCnt = 0, completedCnt = 0;
            
            tasks.forEach((task, index) => {
                const card = createTaskCard(task, index);
                
                if (task.status === 'todo') {
                    todoCards.appendChild(card);
                    todoCnt++;
                } else if (task.status === 'progress') {
                    progressCards.appendChild(card);
                    progressCnt++;
                } else if (task.status === 'completed') {
                    completedCards.appendChild(card);
                    completedCnt++;
                }
            });
            
            document.getElementById('todoCount').textContent = todoCnt;
            document.getElementById('progressCount').textContent = progressCnt;
            document.getElementById('completedCount').textContent = completedCnt;
            
            saveToStorage();
            
            // Refresh Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function createTaskCard(task, index) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.draggable = true;
            card.dataset.index = index;
            card.style.cursor = 'pointer';

            card.ondragstart = (e) => {
                e.dataTransfer.setData('text/plain', index);
                card.classList.add('task-dragging');
            };

            card.ondragend = () => {
                card.classList.remove('task-dragging');
            };

            // Click card body → open linked item if exists, otherwise edit task
            card.onclick = function(e) {
                if (e.target.closest('.task-actions')) return;
                if (task.linkedItem) {
                    const itemIndex = inventory.findIndex(i => i.sku === task.linkedItem);
                    if (itemIndex !== -1) {
                        // Activate inventory tab then open item modal
                        const inventoryTab = document.querySelector('.tab[onclick*="inventory"]');
                        if (inventoryTab) inventoryTab.click();
                        setTimeout(() => openEditModal(itemIndex), 80);
                        return;
                    }
                }
                openEditTaskModal(index);
            };

            let linkedItemHTML = '';
            if (task.linkedItem) {
                const item = inventory.find(i => i.sku === task.linkedItem);
                if (item) {
                    const photoHTML = item.photos && item.photos.length > 0
                        ? `<img src="${item.photos[0]}" alt="${item.name}">`
                        : '📦';
                    linkedItemHTML = `
                        <div class="task-linked-item">
                            ${photoHTML}
                            <span>${item.name}</span>
                        </div>
                    `;
                }
            }

            card.innerHTML = `
                <div class="task-card-header">
                    <div class="task-title">${task.title}</div>
                    <div class="task-actions">
                        <button class="task-btn" onclick="event.stopPropagation(); openEditTaskModal(${index})" title="Edit">✎</button>
                        <button class="task-btn" onclick="event.stopPropagation(); deleteTaskDirect(${index})" title="Delete">×</button>
                    </div>
                </div>
                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                ${linkedItemHTML}
            `;

            return card;
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function drop(e, newStatus) {
            e.preventDefault();
            const taskIndex = e.dataTransfer.getData('text/plain');
            tasks[taskIndex].status = newStatus;
            renderTasks();
            saveToStorage();
        }
        window.allowDrop = allowDrop;
        window.drop = drop;

        function updateTaskLinkedItems() {
            const select = document.getElementById('taskLinkedItem');
            const currentValue = select.value;
            select.innerHTML = '<option value="">No item linked</option>';
            
            inventory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.sku;
                option.textContent = `${item.name} (${item.sku})`;
                select.appendChild(option);
            });
            
            if (currentValue) select.value = currentValue;
        }

        function openTaskModal() {
            editingTaskIndex = null;
            document.getElementById('taskModalTitle').textContent = 'Add New Task';
            document.getElementById('taskSubmitBtn').textContent = 'Add Task';
            document.getElementById('taskDeleteBtn').style.display = 'none';
            document.getElementById('taskForm').reset();
            updateTaskLinkedItems();
            document.getElementById('taskModal').classList.add('active'); window._pushModalState && _pushModalState('taskModal');
        }
        window.openTaskModal = openTaskModal;

        function openEditTaskModal(index) {
            editingTaskIndex = index;
            const task = tasks[index];
            
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskSubmitBtn').textContent = 'Update Task';
            document.getElementById('taskDeleteBtn').style.display = 'block';
            
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskStatus').value = task.status;
            
            updateTaskLinkedItems();
            document.getElementById('taskLinkedItem').value = task.linkedItem || '';
            
            document.getElementById('taskModal').classList.add('active'); window._pushModalState && _pushModalState('taskModal');
        }
        window.openEditTaskModal = openEditTaskModal;

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            document.getElementById('taskForm').reset();
            editingTaskIndex = null;
        }
        window.closeTaskModal = closeTaskModal;

        function saveTask(event) {
            event.preventDefault();
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                linkedItem: document.getElementById('taskLinkedItem').value,
                status: document.getElementById('taskStatus').value,
                createdAt: new Date().toISOString()
            };
            
            if (editingTaskIndex !== null) {
                tasks[editingTaskIndex] = { ...tasks[editingTaskIndex], ...taskData };
            } else {
                tasks.push(taskData);
            }
            
            renderTasks();
            saveToStorage();
            closeTaskModal();
            toast(editingTaskIndex !== null ? 'Task updated!' : 'Task added!');
        }
        window.saveTask = saveTask;

        async function deleteTask() {
            if (editingTaskIndex !== null && await confirmAction('Delete this task?')) {
                tasks.splice(editingTaskIndex, 1);
                renderTasks();
                saveToStorage();
                closeTaskModal();
                toast('Task deleted');
            }
        }
        window.deleteTask = deleteTask;

        async function deleteTaskDirect(index) {
            if (await confirmAction('Delete this task?')) {
                tasks.splice(index, 1);
                renderTasks();
                saveToStorage();
                toast('Task deleted');
            }
        }
        window.deleteTaskDirect = deleteTaskDirect;
        
        let selectedItems = new Set();
        let currentView = 'grid';
        let sortColumn = null;
        let sortDirection = 'asc'; // 'asc' or 'desc'
        
        const CATEGORY_COLORS = {
            "Accessories":"#8b5cf6","Automotive":"#6366f1","Baby":"#ec4899",
            "Baby Clothing":"#f472b6","Beauty & Skincare":"#a855f7","Books":"#0ea5e9",
            "Childrens Clothing":"#14b8a6","Computers & Tech":"#3b82f6","Electronics":"#6366f1",
            "Health & Wellness":"#10b981","Home Decor":"#f59e0b","Jewelry":"#eab308",
            "Kids Collectibles":"#f97316","Kitchen & Dining":"#ef4444","Media":"#8b5cf6",
            "Mens Clothing":"#64748b","Womens Clothing":"#ec4899","Other":"#94a3b8"
        };

        function switchView(mode) {
            currentView = mode;
            document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
            document.getElementById('galleryView').style.display = mode === 'grid' ? 'grid' : 'none';
            document.getElementById('listView').style.display = mode === 'list' ? 'block' : 'none';
            if (mode === 'grid') renderGallery();
        }
        window.switchView = switchView;

        function renderGallery() {
            const container = document.getElementById('galleryView');
            container.innerHTML = '';
            
            const sortedIndices = getSortedIndices();
            
            sortedIndices.forEach((index) => {
                const item = inventory[index];
                const totalCost = (item.purchase || 0) + (item.purchaseShipping || 0);
                const isSelected = selectedItems.has(index);
                const catColor = CATEGORY_COLORS[item.category] || '#94a3b8';
                const linkedTasks = tasks.filter(t => t.linkedItem === item.sku);
                const statusClass = item.status.toLowerCase().replace(/[\/\s]/g, '-');
                
                // Days since listed
                let daysListed = null;
                if (item.status === 'Listed' && item.dateSold === null) {
                    // Approximate
                    daysListed = item.days || 0;
                }
                
                let photoHTML;
                if (item.photos && item.photos.length > 0) {
                    photoHTML = `<img src="${item.photos[0]}" alt="${item.name}">`;
                } else {
                    photoHTML = `<div class="card-photo-placeholder"><svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg><span>No photo</span></div>`;
                }
                
                const card = document.createElement('div');
                card.className = `item-card${isSelected ? ' card-selected' : ''}`;
                card.onclick = (e) => {
                    if (e.target.type === 'checkbox') return;
                    openEditModal(index);
                };
                
                const profitHTML = item.profit != null ? `
                    <div><span class="cf-label">Profit</span><span class="cf-value" style="color:${item.profit >= 0 ? 'var(--emerald-600)' : 'var(--rose-600)'}">${item.profit >= 0 ? '$' : '-$'}${Math.abs(item.profit).toFixed(2)}</span></div>
                    <div><span class="cf-label">ROI</span><span class="cf-value" style="color:${item.profit >= 0 ? 'var(--emerald-600)' : 'var(--rose-600)'}">${totalCost > 0 ? (item.profit / totalCost * 100).toFixed(0) + '%' : '—'}</span></div>
                ` : '';
                
                card.innerHTML = `
                    <div class="card-photo">
                        ${photoHTML}
                        <div class="card-checkbox">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelect(${index}, this.checked); event.stopPropagation();">
                        </div>
                        <div class="card-status"><span class="status-badge status-${statusClass}" style="font-size:10px;padding:2px 8px;">${item.status}</span></div>
                        ${item.photos && item.photos.length > 1 ? `<div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.6);color:white;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;">📷 ${item.photos.length}</div>` : ''}
                        <div class="card-cat-stripe" style="background:${catColor};"></div>
                    </div>
                    <div class="card-body">
                        <div class="card-title">${item.name}</div>
                        <div class="card-meta">
                            <span class="card-sku">${item.sku}</span>
                            <span class="card-category" style="color:${catColor}">${item.category}</span>
                        </div>
                        <div style="display:flex;align-items:center;justify-content:space-between;margin:6px 0;" onclick="event.stopPropagation();">
                            <span style="font-size:11px;font-weight:600;color:var(--text-secondary,var(--slate-500));">Stock</span>
                            <div class="qty-stepper">
                                <button onclick="adjustQty(${index}, -1)">−</button>
                                <span data-qty-idx="${index}">${item.qty || 1}</span>
                                <button onclick="adjustQty(${index}, 1)">+</button>
                            </div>
                        </div>
                        <div class="card-financials">
                            <div><span class="cf-label">Cost</span><span class="cf-value">$${totalCost.toFixed(2)}</span></div>
                            <div><span class="cf-label">Sale</span><span class="cf-value">${item.sale ? '$' + item.sale.toFixed(2) : '—'}</span></div>
                            ${profitHTML}
                        </div>
                        <div class="card-footer">
                            ${item.platform ? `<span class="card-platform">${item.platform}</span>` : '<span></span>'}
                            <div class="card-badges">
                                ${linkedTasks.length > 0 ? `<span class="card-badge card-badge-link">🔗 ${linkedTasks.length}</span>` : ''}
                                ${daysListed && daysListed > 30 ? `<span class="card-badge card-badge-stale">⏱ ${daysListed}d</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function checkStaleItems() {
            const staleItems = inventory.filter(i => i.status === 'Listed' && i.days > 30);
            const alertEl = document.getElementById('staleAlert');
            if (staleItems.length > 0) {
                alertEl.style.display = 'flex';
                document.getElementById('staleAlertText').textContent = 
                    staleItems.length + ' item' + (staleItems.length > 1 ? 's' : '') + ' listed 30+ days: ' + staleItems.map(i => i.name).join(', ');
            } else {
                alertEl.style.display = 'none';
            }
        }

        // ── Bulk Actions ──
        function toggleItemSelect(index, checked) {
            if (checked) { selectedItems.add(index); }
            else { selectedItems.delete(index); }
            updateBulkBar();
            // Highlight rows
            const rows = document.querySelectorAll('#inventoryBody tr');
            if (rows[index]) rows[index].classList.toggle('row-selected', checked);
            // Update cards if in gallery
            if (currentView === 'grid') renderGallery();
            // Sync select all
            const cb = document.getElementById('selectAllCb');
            if (cb) {
                cb.checked = selectedItems.size === inventory.length && inventory.length > 0;
                cb.indeterminate = selectedItems.size > 0 && selectedItems.size < inventory.length;
            }
        }
        window.toggleItemSelect = toggleItemSelect;

        function toggleSelectAll() {
            const cb = document.getElementById('selectAllCb');
            if (selectedItems.size === inventory.length) {
                selectedItems.clear();
                if (cb) cb.checked = false;
            } else {
                inventory.forEach((_, i) => selectedItems.add(i));
                if (cb) cb.checked = true;
            }
            if (cb) cb.indeterminate = false;
            renderInventory();
            if (currentView === 'grid') renderGallery();
            updateBulkBar();
        }
        window.toggleSelectAll = toggleSelectAll;

        function clearSelection() {
            selectedItems.clear();
            const cb = document.getElementById('selectAllCb');
            if (cb) { cb.checked = false; cb.indeterminate = false; }
            renderInventory();
            if (currentView === 'grid') renderGallery();
            updateBulkBar();
        }
        window.clearSelection = clearSelection;

        function updateBulkBar() {
            const bar = document.getElementById('bulkBar');
            const count = document.getElementById('bulkCount');
            if (selectedItems.size > 0) {
                bar.classList.add('visible');
                count.textContent = selectedItems.size;
            } else {
                bar.classList.remove('visible');
                document.getElementById('bulkDropdown').classList.remove('show');
            }
        }

        function toggleBulkDropdown() {
            document.getElementById('bulkDropdown').classList.toggle('show');
        }
        window.toggleBulkDropdown = toggleBulkDropdown;

        async function bulkChangeStatus(newStatus) {
            const count = selectedItems.size;
            if (!count || !await confirmAction(`Change ${count} item(s) to "${newStatus}"?`)) return;
            Array.from(selectedItems).forEach(index => {
                inventory[index].status = newStatus;
                if (newStatus === 'Sold' && !inventory[index].dateSold) {
                    inventory[index].dateSold = new Date();
                }
                if (newStatus === 'Sold' && inventory[index].sale) {
                    const item = inventory[index];
                    const totalCost = (item.purchase || 0) + (item.purchaseShipping || 0);
                    let pFees = 0;
                    if (item.platform) {
                        const p = platforms.find(pl => pl.name === item.platform);
                        pFees = p ? (item.sale * (p.feePercent / 100)) + p.fixedFee : item.sale * 0.1;
                    } else { pFees = item.sale * 0.1; }
                    item.platformFees = pFees;
                    item.profit = item.sale - totalCost - pFees - (item.outboundShipping || 0) - (item.packaging || 0);
                    item.taxReserve = item.profit > 0 ? item.profit * 0.153 : 0;
                }
            });
            selectedItems.clear();
            document.getElementById('bulkDropdown').classList.remove('show');
            refreshAll();
            toast(`${count} item(s) → "${newStatus}"`);
        }
        window.bulkChangeStatus = bulkChangeStatus;

        async function bulkDelete() {
            const count = selectedItems.size;
            if (!count || !await confirmAction(`Delete ${count} item(s)? This cannot be undone.`)) return;
            const indices = Array.from(selectedItems).sort((a, b) => b - a);
            indices.forEach(i => inventory.splice(i, 1));
            selectedItems.clear();
            refreshAll();
            toast(`${count} item(s) deleted`);
        }
        window.bulkDelete = bulkDelete;

        function refreshAll() {
            renderInventory();
            if (currentView === 'grid') renderGallery();
            updateStats();
            renderWeeklyAnalytics();
            renderMonthlyAnalytics();
            renderCategoriesAnalytics();
            renderTasks();
            renderExpenses();
            checkStaleItems();
            updateBulkBar();
            saveToStorage();
            const cb = document.getElementById('selectAllCb');
            if (cb) { cb.checked = false; cb.indeterminate = false; }
        }

        function filterAll() {
            filterTable();
            // If in gallery mode, also filter gallery
            if (currentView === 'grid') {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;
                const platformFilter = document.getElementById('platformFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const cards = document.querySelectorAll('#galleryView .item-card');
                const sortedIndices = getSortedIndices();
                cards.forEach((card, i) => {
                    const item = inventory[sortedIndices[i]];
                    if (!item) { card.style.display = 'none'; return; }
                    const matchSearch = !searchTerm || item.name.toLowerCase().includes(searchTerm) || item.sku.toLowerCase().includes(searchTerm) || (item.source || '').toLowerCase().includes(searchTerm);
                    const matchCategory = !categoryFilter || item.category === categoryFilter;
                    const matchPlatform = !platformFilter || item.platform === platformFilter;
                    const matchStatus = !statusFilter || item.status === statusFilter;
                    card.style.display = matchSearch && matchCategory && matchPlatform && matchStatus ? '' : 'none';
                });
            }
        }
        window.filterAll = filterAll;

        // Close bulk dropdown on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.bulk-dropdown') && !e.target.closest('.bulk-btn-status')) {
                document.getElementById('bulkDropdown').classList.remove('show');
            }
        });

        // Make all functions globally accessible
        window.exportData = exportData;
        window.switchTab = switchTab;
        window.switchPeriod = switchPeriod;
        window.filterTable = filterTable;
        window.closeModal = closeModal;
        window.openEditModal = openEditModal;
        window.saveItem = saveItem;
        window.deleteItem = deleteItem;
        window.openPlatformModal = openPlatformModal;
        window.closePlatformModal = closePlatformModal;
        window.savePlatform = savePlatform;
        window.deletePlatform = deletePlatform;
        window.closeBarcodeModal = closeBarcodeModal;
        window.printLabel = printLabel;
        window.downloadLabel = downloadLabel;

        // ═══════════════════════════════════════════════════════════════
        // AI ITEM SCANNER — uses Claude vision to identify items
        // ═══════════════════════════════════════════════════════════════

        let aiScanImageDataUrl = null;
        let aiScanResult = null;

        function openAIScanModal() {
            if (!getGroqKey()) {
                const key = prompt('Enter your Groq API key to enable AI scanning.\n\nGet one free at console.groq.com → API Keys\n\nThis is saved only on this device — never uploaded anywhere.');
                if (!key || !key.trim()) return;
                setGroqKey(key);
                toast('Groq API key saved to this device ✓', 'success');
            }
            aiScanImageDataUrl = null;
            aiScanResult = null;
            document.getElementById('aiScanStep1').style.display = 'block';
            document.getElementById('aiScanStep2').style.display = 'none';
            document.getElementById('aiScanStep3').style.display = 'none';
            document.getElementById('aiScanError').style.display = 'none';
            document.getElementById('aiScanPreviewBox').style.display = 'none';
            document.getElementById('aiScanAnalyzeRow').style.display = 'none';
            document.getElementById('aiScanGalleryInput').value = '';
            document.getElementById('aiScanOverlay').style.display = 'flex'; window._pushModalState && _pushModalState('aiScanOverlay');
        }
        window.openAIScanModal = openAIScanModal;

        function closeAIScanModal() {
            document.getElementById('aiScanOverlay').style.display = 'none';
        }
        window.closeAIScanModal = closeAIScanModal;

        // aiScanOverlay is injected after this script block — attach listener after DOM ready
        window.addEventListener('load', function() {
            const aiOverlay = document.getElementById('aiScanOverlay');
            if (aiOverlay) aiOverlay.addEventListener('click', function(e) {
                if (e.target === this) closeAIScanModal();
            });
        });

        // Compress image to max 800px and quality 0.7 before sending to API
        function compressImage(dataUrl, maxDim, quality) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = function() {
                    let w = img.width, h = img.height;
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                        else { w = Math.round(w * maxDim / h); h = maxDim; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }

        function aiScanPhotoSelected(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                // Compress before storing — faster preview and faster API
                const compressed = await compressImage(e.target.result, 800, 0.75);
                aiScanImageDataUrl = compressed;
                document.getElementById('aiScanPreviewImg').src = compressed;
                document.getElementById('aiScanPreviewBox').style.display = 'block';
                document.getElementById('aiScanAnalyzeRow').style.display = 'none'; // hidden — auto-runs
                // Auto-trigger scan immediately after photo selected
                runAIScan();
            };
            reader.readAsDataURL(file);
        }
        window.aiScanPhotoSelected = aiScanPhotoSelected;

        // ── Desktop webcam capture ──────────────────────────────────────
        let desktopStream = null;

        async function openDesktopCamera() {
            const overlay = document.getElementById('aiScanOverlay');
            // Build inline webcam UI
            let camBox = document.getElementById('aiDesktopCamBox');
            if (!camBox) {
                camBox = document.createElement('div');
                camBox.id = 'aiDesktopCamBox';
                camBox.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:3500;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;';
                camBox.innerHTML = `
                    <video id="aiDesktopVideo" autoplay playsinline muted style="max-width:90vw;max-height:70vh;border-radius:12px;background:#000;"></video>
                    <div style="display:flex;gap:12px;">
                        <button onclick="captureDesktopPhoto()" style="padding:14px 32px;border:none;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#4f46e5);color:white;font-size:16px;font-weight:700;cursor:pointer;">📸 Capture</button>
                        <button onclick="closeDesktopCamera()" style="padding:14px 24px;border:none;border-radius:12px;background:rgba(255,255,255,0.15);color:white;font-size:15px;cursor:pointer;">Cancel</button>
                    </div>
                `;
                document.body.appendChild(camBox);
            } else {
                camBox.style.display = 'flex';
            }

            try {
                desktopStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                document.getElementById('aiDesktopVideo').srcObject = desktopStream;
            } catch(err) {
                closeDesktopCamera();
                toast('Camera not available: ' + (err.message || err.name), 'error');
            }
        }
        window.openDesktopCamera = openDesktopCamera;

        function captureDesktopPhoto() {
            const video = document.getElementById('aiDesktopVideo');
            if (!video) return;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            closeDesktopCamera();
            // Compress and auto-scan
            compressImage(canvas.toDataURL('image/jpeg', 0.9), 800, 0.75).then(compressed => {
                aiScanImageDataUrl = compressed;
                document.getElementById('aiScanPreviewImg').src = compressed;
                document.getElementById('aiScanPreviewBox').style.display = 'block';
                document.getElementById('aiScanAnalyzeRow').style.display = 'none';
                runAIScan();
            });
        }
        window.captureDesktopPhoto = captureDesktopPhoto;

        function closeDesktopCamera() {
            if (desktopStream) {
                desktopStream.getTracks().forEach(t => t.stop());
                desktopStream = null;
            }
            const camBox = document.getElementById('aiDesktopCamBox');
            if (camBox) camBox.style.display = 'none';
        }
        window.closeDesktopCamera = closeDesktopCamera;

        async function runAIScan() {
            if (!aiScanImageDataUrl) return;

            // Show loading
            document.getElementById('aiScanStep1').style.display = 'none';
            document.getElementById('aiScanStep2').style.display = 'block';
            document.getElementById('aiScanStep3').style.display = 'none';
            document.getElementById('aiScanError').style.display = 'none';

            const VALID_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            const mediaType = aiScanImageDataUrl.split(';')[0].split(':')[1] || 'image/jpeg';
            if (!VALID_TYPES.includes(mediaType)) {
                document.getElementById('aiScanStep2').style.display = 'none';
                document.getElementById('aiScanError').style.display = 'block';
                document.getElementById('aiScanErrorMsg').textContent = 'Unsupported image type. Please use JPG, PNG, or WebP.';
                return;
            }

            const categoryList = [
                'Accessories','Automotive','Baby','Baby Clothing','Beauty & Skincare','Books',
                'Childrens Clothing','Computers & Tech','Electronics','Health & Wellness',
                'Home Decor','Jewelry','Kids Collectibles','Kitchen & Dining','Media',
                'Mens Clothing','Womens Clothing','Other'
            ].join(',');

            const prompt = `You are a reseller assistant. Look at this item image and respond with ONLY a JSON object. No explanation, no markdown, no code blocks. Just the raw JSON.

{"name":"product name","brand":"brand name or empty string","category":"one of: ${categoryList}","condition":"New or Like New or Good or Fair or Poor","estimatedPurchasePrice":0,"estimatedSalePrice":0,"notes":"brief description"}

Use null instead of 0 if you cannot estimate a price. All keys must use double quotes.`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getGroqKey()
                    },
                    body: JSON.stringify({
                        model: 'meta-llama/llama-4-scout-17b-16e-instruct',
                        max_tokens: 256,
                        temperature: 0.1,
                        response_format: { type: 'json_object' },
                        messages: [{
                            role: 'user',
                            content: [
                                { type: 'image_url', image_url: { url: aiScanImageDataUrl } },
                                { type: 'text', text: prompt }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error?.message || 'API error ' + response.status);
                }

                const data = await response.json();
                let rawText = data.choices?.[0]?.message?.content || '';

                // Strip markdown fences if present
                rawText = rawText.replace(/```json|```/gi, '').trim();

                // Extract first JSON object found in the string — handles extra surrounding text
                const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('No JSON found in response');

                aiScanResult = JSON.parse(jsonMatch[0]);
                showAIScanResults(aiScanResult);

            } catch (err) {
                console.error('AI scan error:', err);
                document.getElementById('aiScanStep2').style.display = 'none';
                document.getElementById('aiScanError').style.display = 'block';
                document.getElementById('aiScanErrorMsg').textContent = 'Scan failed: ' + (err.message || 'unknown error');
            }
        }
        window.runAIScan = runAIScan;

        function showAIScanResults(result) {
            document.getElementById('aiScanStep2').style.display = 'none';
            document.getElementById('aiScanStep3').style.display = 'block';

            const fields = [
                { key: 'name',                  label: 'Item Name',             type: 'text' },
                { key: 'brand',                 label: 'Brand / Source',        type: 'text' },
                { key: 'category',              label: 'Category',              type: 'text' },
                { key: 'condition',             label: 'Condition',             type: 'text' },
                { key: 'estimatedPurchasePrice',label: 'Est. Purchase Price $', type: 'number' },
                { key: 'estimatedSalePrice',    label: 'Est. Sale Price $',     type: 'number' },
                { key: 'notes',                 label: 'Notes',                 type: 'text' },
            ];

            const container = document.getElementById('aiScanResultFields');
            container.innerHTML = '';
            fields.forEach(f => {
                const val = result[f.key];
                if (val === null || val === undefined || val === '') return;
                const row = document.createElement('div');
                row.style.cssText = 'display:flex;flex-direction:column;gap:4px;';
                row.innerHTML = `
                    <label style="font-size:11px;font-weight:600;color:var(--text-tertiary,var(--slate-400));text-transform:uppercase;letter-spacing:0.04em;">${f.label}</label>
                    <input type="${f.type}" data-ai-key="${f.key}" value="${val}" class="form-input" style="font-size:13px;padding:8px 10px;">
                `;
                container.appendChild(row);
            });
        }

        function applyAIScanResults() {
            // Read back any edits the user made to the result fields
            const inputs = document.querySelectorAll('#aiScanResultFields input[data-ai-key]');
            const edited = {};
            inputs.forEach(inp => { edited[inp.dataset.aiKey] = inp.value; });

            // Fill item form
            if (edited.name) document.getElementById('itemName').value = edited.name;
            if (edited.brand) document.getElementById('itemSource').value = edited.brand;
            if (edited.estimatedPurchasePrice) document.getElementById('purchasePrice').value = parseFloat(edited.estimatedPurchasePrice).toFixed(2);
            if (edited.estimatedSalePrice) document.getElementById('salePrice').value = parseFloat(edited.estimatedSalePrice).toFixed(2);

            // Category — match to dropdown
            if (edited.category) {
                const sel = document.getElementById('itemCategory');
                for (let i = 0; i < sel.options.length; i++) {
                    if (sel.options[i].value.toLowerCase() === edited.category.toLowerCase()) {
                        sel.selectedIndex = i;
                        break;
                    }
                }
            }

            // Add the scanned image as a pending photo
            if (aiScanImageDataUrl) {
                pendingPhotos.push(aiScanImageDataUrl);
                renderPhotoPreviews();
            }

            closeAIScanModal();
            calculateTaxPreview();

            // Flash the form
            const form = document.getElementById('itemForm');
            form.style.transition = 'box-shadow 0.3s';
            form.style.boxShadow = '0 0 0 3px rgba(124,58,237,0.35)';
            setTimeout(() => { form.style.boxShadow = ''; }, 1500);

            toast('AI filled in ' + Object.keys(edited).length + ' fields ✨', 'success');
        }
        window.applyAIScanResults = applyAIScanResults;

        function aiScanRetry() {
            aiScanImageDataUrl = null;
            aiScanResult = null;
            document.getElementById('aiScanStep1').style.display = 'block';
            document.getElementById('aiScanStep2').style.display = 'none';
            document.getElementById('aiScanStep3').style.display = 'none';
            document.getElementById('aiScanError').style.display = 'none';
            document.getElementById('aiScanPreviewBox').style.display = 'none';
            document.getElementById('aiScanAnalyzeRow').style.display = 'none';
            document.getElementById('aiScanGalleryInput').value = '';
        }
        window.aiScanRetry = aiScanRetry;

        // ── Boot: render from localStorage instantly, then check cloud ──

        // ── Back Button Modal Manager ──────────────────────────────────
        (function() {
            const CLOSERS = {
                'itemModal':       () => closeModal(),
                'scanOverlay':     () => closeScanModal(),
                'aiScanOverlay':   () => closeAIScanModal(),
                'importOverlay':   () => closeImportModal(),
                'barcodeModal':    () => closeBarcodeModal(),
                'expenseModal':    () => closeExpenseModal(),
                'platformModal':   () => closePlatformModal(),
                'taskModal':       () => closeTaskModal(),
                'manualTripModal': () => closeManualTripModal(),
                'photoModal':      () => closePhotoModal(),
                'loginOverlay':    () => skipLogin(),
            };

            window._pushModalState = function(id) {
                const currentTab = history.state?.tab || 'inventory';
                history.pushState({ modal: id, prevTab: currentTab }, '');
            };

            // Track active tab so back button can restore it
            window._pushTabState = function(tabName) {
                history.replaceState({ tab: tabName }, '');
            };

            // On page load, record the default tab in history
            history.replaceState({ tab: 'inventory' }, '');

            window.addEventListener('popstate', function(e) {
                const id = e.state?.modal;
                if (id && CLOSERS[id]) {
                    // Close the modal, then re-push the tab state so further back stays on dashboard
                    CLOSERS[id]();
                    history.replaceState({ tab: e.state?.prevTab || 'inventory' }, '');
                    return;
                }
                // No modal — check if any are open and close the topmost
                for (const [mid, fn] of Object.entries(CLOSERS)) {
                    const el = document.getElementById(mid);
                    if (!el) continue;
                    const open = el.classList.contains('active') || el.style.display === 'flex';
                    if (open) {
                        fn();
                        history.replaceState({ tab: e.state?.tab || 'inventory' }, '');
                        return;
                    }
                }
                // Nothing open — restore the tab that was active
                const tab = e.state?.tab || 'inventory';
                const tabBtn = document.querySelector(`.tab[onclick*="'${tab}'"]`);
                if (tabBtn) tabBtn.click();
            });
        })();
        init();
        initGalleryDropListeners();
        initListDropListeners();
        (async function boot() {
            await checkSession();
            if (sbClient) {
                sbClient.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        syncEnabled = true;
                        updateAuthUI();
                        await loadFromCloud();
                        init();
                        startRealtimeSync();
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        syncEnabled = false;
                        updateAuthUI();
                        setSyncStatus('offline', 'Local Only');
                        stopRealtimeSync();
                    }
                });
            }
        })();

        let _realtimeChannel = null;
        function startRealtimeSync() {
            if (!sbClient || !currentUser) return;
            stopRealtimeSync();
            _realtimeChannel = sbClient
                .channel('reseller_data_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'reseller_data',
                    filter: `user_id=eq.${currentUser.id}`
                }, async (payload) => {
                    // Another device pushed an update — pull fresh data
                    await loadFromCloud();
                })
                .subscribe();
        }
        function stopRealtimeSync() {
            if (_realtimeChannel) {
                try { sbClient.removeChannel(_realtimeChannel); } catch(e) {}
                _realtimeChannel = null;
            }
        }

        document.getElementById('itemModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('platformModal').addEventListener('click', function(e) {
            if (e.target === this) closePlatformModal();
        });

        document.getElementById('barcodeModal').addEventListener('click', function(e) {
            if (e.target === this) closeBarcodeModal();
        });

        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) closePhotoModal();
        });

        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) closeTaskModal();
        });

        document.getElementById('loginOverlay').addEventListener('click', function(e) {
            if (e.target === this) skipLogin();
        });

        document.getElementById('scanBtn').addEventListener('click', function() {
            openScanModal();
        });

        document.getElementById('scanOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeScanModal();
        });

        document.getElementById('importBtn').addEventListener('click', function() {
            document.getElementById('csvFileInput').click();
        });

        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                if (file.name.endsWith('.json')) {
                    importJSON(file);
                } else {
                    openImportModal(file);
                }
                this.value = ''; // reset so same file can be re-imported
            }
        });

        function importJSON(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let imported = 0;

                    if (data.inventory && Array.isArray(data.inventory)) {
                        data.inventory.forEach(item => {
                            if (item.dateSold) item.dateSold = new Date(item.dateSold);
                            if (!item.photos) item.photos = [];
                            if (!item.qty) item.qty = 1;
                        });
                        const mergeMode = await confirmAction(
                            `Found ${data.inventory.length} items. Merge with existing? (Cancel = replace all)`
                        );
                        if (mergeMode) {
                            inventory.push(...data.inventory);
                        } else {
                            inventory = data.inventory;
                        }
                        imported += data.inventory.length;
                    }
                    if (data.platforms && Array.isArray(data.platforms)) {
                        platforms = data.platforms;
                    }
                    if (data.expenses && Array.isArray(data.expenses)) {
                        expenses = data.expenses;
                    }
                    if (data.mileage && Array.isArray(data.mileage)) {
                        mileageTrips = data.mileage;
                    }
                    if (data.tasks && Array.isArray(data.tasks)) {
                        tasks = data.tasks;
                    }

                    init();
                    saveToStorage();
                    toast(`${imported} items imported with photos!`);
                } catch(err) {
                    toast('Error reading JSON: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('importOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeImportModal();
        });

    </script>

    <!-- AI Item Scan Modal -->
    <div class="scan-overlay" id="aiScanOverlay" style="display:none;">
        <div class="scan-card" style="max-width:480px;">
            <div class="scan-header">
                <h3>🤖 AI Item Scanner</h3>
                <button class="close-btn" onclick="closeAIScanModal()">&times;</button>
            </div>
            <div class="scan-body">
                <!-- Step 1: capture -->
                <div id="aiScanStep1">
                    <div style="text-align:center;padding:16px 0 8px;">
                        <div style="font-size:13px;color:var(--text-secondary,var(--slate-600));margin-bottom:16px;">
                            Take or upload a photo — AI identifies the item and fills in the details instantly.
                        </div>
                        <div id="aiScanPreviewBox" style="display:none;margin-bottom:16px;">
                            <img id="aiScanPreviewImg" src="" style="max-width:100%;max-height:220px;border-radius:12px;object-fit:contain;border:2px solid var(--border-primary,var(--slate-200));">
                        </div>
                        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                            <!-- Desktop: opens webcam via getUserMedia. Mobile: opens native camera via capture -->
                            <button type="button" class="btn btn-primary" onclick="openDesktopCamera()" style="background:linear-gradient(135deg,#7c3aed,#4f46e5);">
                                📷 Take Photo
                            </button>
                            <label class="btn btn-secondary" style="cursor:pointer;">
                                🖼 Choose Image
                                <input type="file" id="aiScanGalleryInput" accept="image/*" style="display:none;" onchange="aiScanPhotoSelected(this)">
                            </label>
                        </div>
                    </div>
                    <!-- Analyze row hidden — scan triggers automatically on photo select -->
                    <div id="aiScanAnalyzeRow" style="display:none;"></div>
                </div>
                <!-- Step 2: loading -->
                <div id="aiScanStep2" style="display:none;text-align:center;padding:32px 16px;">
                    <div style="font-size:36px;margin-bottom:12px;animation:spin 1s linear infinite;display:inline-block;">⚙️</div>
                    <div style="font-weight:600;color:var(--text-primary,var(--slate-900));">Identifying item…</div>
                    <div style="font-size:12px;color:var(--text-tertiary,var(--slate-400));margin-top:6px;">Groq AI is analyzing the image at lightning speed</div>
                </div>
                <!-- Step 3: results -->
                <div id="aiScanStep3" style="display:none;">
                    <div style="font-size:13px;font-weight:600;color:var(--text-secondary,var(--slate-600));margin-bottom:12px;">AI detected the following — edit anything before filling:</div>
                    <div style="display:flex;flex-direction:column;gap:10px;" id="aiScanResultFields">
                        <!-- filled dynamically -->
                    </div>
                    <div style="display:flex;gap:10px;margin-top:16px;">
                        <button class="btn btn-primary" onclick="applyAIScanResults()" style="flex:1;background:linear-gradient(135deg,#7c3aed,#4f46e5);">✅ Fill Form</button>
                        <button class="btn btn-secondary" onclick="aiScanRetry()" style="flex:1;">🔄 Scan Again</button>
                    </div>
                </div>
                <!-- Error -->
                <div id="aiScanError" style="display:none;text-align:center;padding:16px;">
                    <div style="color:var(--rose-500);font-weight:600;font-size:13px;" id="aiScanErrorMsg"></div>
                    <button class="btn btn-secondary" onclick="aiScanRetry()" style="margin-top:12px;">Try Again</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

</body>
</html>
